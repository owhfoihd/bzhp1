<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Mise — Personal Cooking Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0e0e0d;
  --surface: #181815;
  --surface2: #222220;
  --surface3: #2c2c29;
  --border: #333330;
  --text: #f0ede8;
  --text2: #9e9b94;
  --text3: #5c5a55;
  --accent: #e8c547;
  --accent2: #c9a227;
  --green: #7ec8a0;
  --red: #e07070;
  --orange: #e89b5c;
  --blue: #7eb8c8;
  --tab-h: 72px;
  --header-h: 64px;
  --r: 16px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; -webkit-font-smoothing: antialiased; }
.app { display: flex; flex-direction: column; height: 100dvh; max-width: 430px; margin: 0 auto; position: relative; overflow: hidden; background: var(--bg); }

/* HEADER */
.header { height: var(--header-h); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; border-bottom: 1px solid var(--border); background: var(--bg); position: relative; z-index: 10; flex-shrink: 0; }
.header-logo { font-family: 'Fraunces', serif; font-size: 26px; font-weight: 700; color: var(--accent); letter-spacing: -0.5px; }
.header-subtitle { font-size: 11px; color: var(--text3); font-weight: 400; margin-top: 1px; }
.header-right { display: flex; gap: 8px; align-items: center; }
.header-btn { height: 34px; padding: 0 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); color: var(--text2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; font-family: 'DM Sans', sans-serif; gap: 6px; transition: all 0.15s; white-space: nowrap; }
.header-btn:hover { background: var(--surface2); color: var(--text); }
.header-btn.save-btn { background: var(--accent); color: #111; border-color: var(--accent); }
.header-btn.save-btn:hover { background: var(--accent2); }
.header-btn.save-btn.saved { background: var(--surface); color: var(--green); border-color: rgba(126,200,160,0.4); }
.save-icon { width: 14px; height: 14px; }
.unsaved-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); display: none; }
.unsaved-dot.show { display: block; }

/* SCREENS */
.screens { flex: 1; overflow: hidden; position: relative; }
.screen { position: absolute; inset: 0; overflow-y: auto; overflow-x: hidden; padding: 20px 20px calc(var(--tab-h) + 16px); opacity: 0; pointer-events: none; transform: translateX(24px); transition: opacity 0.25s ease, transform 0.25s ease; }
.screen.active { opacity: 1; pointer-events: auto; transform: translateX(0); }
.screen::-webkit-scrollbar { display: none; }

/* SECTION TITLES */
.section-title { font-family: 'Fraunces', serif; font-size: 28px; font-weight: 500; color: var(--text); margin-bottom: 6px; line-height: 1.1; }
.section-sub { font-size: 13px; color: var(--text3); margin-bottom: 20px; }

/* SEARCH */
.search-bar { display: flex; align-items: center; gap: 10px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 10px 14px; margin-bottom: 16px; }
.search-bar input { flex: 1; background: none; border: none; outline: none; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; }
.search-bar input::placeholder { color: var(--text3); }
.search-icon { color: var(--text3); width: 15px; height: 15px; flex-shrink: 0; }

/* CHIPS */
.chips { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 2px; scrollbar-width: none; }
.chips::-webkit-scrollbar { display: none; }
.chip { flex-shrink: 0; padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border); background: var(--surface); color: var(--text2); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
.chip.active { background: var(--accent); border-color: var(--accent); color: #111; }
.chip:hover:not(.active) { border-color: var(--text3); color: var(--text); }

/* RECIPE CARDS */
.recipe-grid { display: flex; flex-direction: column; gap: 12px; }
.recipe-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 16px; cursor: pointer; transition: all 0.18s; display: flex; gap: 14px; align-items: flex-start; }
.recipe-card:hover { border-color: var(--text3); background: var(--surface2); }
.recipe-card:active { transform: scale(0.98); }
.recipe-initial { width: 52px; height: 52px; border-radius: 12px; background: var(--surface2); display: flex; align-items: center; justify-content: center; font-family: 'Fraunces', serif; font-size: 20px; font-weight: 700; color: var(--accent); flex-shrink: 0; border: 1px solid var(--border); text-transform: uppercase; }
.recipe-info { flex: 1; min-width: 0; }
.recipe-name { font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
.recipe-meta { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.recipe-tag { font-size: 11px; padding: 3px 8px; border-radius: 6px; font-weight: 500; }
.tag-dinner { background: rgba(126,184,200,0.15); color: var(--blue); }
.tag-breakfast { background: rgba(232,155,92,0.15); color: var(--orange); }
.tag-lunch { background: rgba(126,200,160,0.15); color: var(--green); }
.tag-snack { background: rgba(200,160,232,0.15); color: #c8a0e8; }
.recipe-time { font-size: 12px; color: var(--text3); }
.recipe-rating { font-size: 12px; color: var(--accent); }
.recipe-right { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; flex-shrink: 0; }
.diff-badge { font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
.diff-easy { background: rgba(126,200,160,0.2); color: var(--green); }
.diff-medium { background: rgba(232,155,92,0.2); color: var(--orange); }
.diff-hard { background: rgba(224,112,112,0.2); color: var(--red); }
.days-ago { font-size: 11px; color: var(--text3); }

/* FAB */
.fab { position: fixed; bottom: calc(var(--tab-h) + 20px); right: calc(50% - 215px + 20px); width: 52px; height: 52px; border-radius: 16px; background: var(--accent); border: none; color: #111; font-size: 26px; font-weight: 300; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 24px rgba(232,197,71,0.35); transition: all 0.2s; z-index: 20; line-height: 1; }
.fab:hover { transform: scale(1.05); box-shadow: 0 6px 30px rgba(232,197,71,0.5); }
.fab:active { transform: scale(0.96); }

/* TABBAR */
.tabbar { height: var(--tab-h); display: flex; align-items: stretch; border-top: 1px solid var(--border); background: var(--bg); padding: 0 4px; flex-shrink: 0; position: relative; z-index: 10; }
.tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; cursor: pointer; border: none; background: none; color: var(--text3); transition: color 0.2s; border-radius: 12px; margin: 6px 2px; padding: 0 4px; position: relative; }
.tab.active { color: var(--accent); }
.tab-icon { width: 20px; height: 20px; }
.tab-label { font-size: 10px; font-weight: 600; letter-spacing: 0.3px; font-family: 'DM Sans', sans-serif; }
.tab-indicator { position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); width: 18px; height: 2px; border-radius: 2px; background: var(--accent); opacity: 0; transition: opacity 0.2s; }
.tab.active .tab-indicator { opacity: 1; }

/* PLAN */
.week-controls { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.week-nav { width: 34px; height: 34px; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); color: var(--text2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.15s; }
.week-nav:hover { background: var(--surface2); color: var(--text); }
.week-label { font-size: 14px; font-weight: 600; color: var(--text); }
.autofill-btn { width: 100%; padding: 14px; border-radius: var(--r); background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%); border: none; color: #111; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; margin-bottom: 20px; letter-spacing: 0.3px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
.autofill-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(232,197,71,0.3); }
.day-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); margin-bottom: 10px; overflow: hidden; }
.day-card.today { border-color: rgba(232,197,71,0.4); }
.day-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); }
.day-name { font-size: 13px; font-weight: 700; color: var(--text); text-transform: uppercase; letter-spacing: 1px; }
.day-date { font-size: 12px; color: var(--text3); }
.day-badge { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 6px; background: rgba(232,197,71,0.15); color: var(--accent); }
.day-meals { padding: 10px 16px 14px; display: flex; flex-direction: column; gap: 8px; }
.meal-slot { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 10px; border: 1px dashed var(--border); cursor: pointer; transition: all 0.15s; min-height: 48px; }
.meal-slot.filled { border-style: solid; border-color: var(--border); background: var(--surface2); }
.meal-slot.locked { border-color: rgba(232,197,71,0.3); }
.meal-slot:hover { border-color: var(--text3); }
.meal-type-label { font-size: 10px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 0.8px; width: 56px; flex-shrink: 0; }
.meal-slot-content { flex: 1; min-width: 0; }
.meal-slot-name { font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.meal-slot-meta { font-size: 11px; color: var(--text3); }
.meal-slot-empty { font-size: 13px; color: var(--text3); }
.meal-initials { width: 28px; height: 28px; border-radius: 7px; background: var(--surface3); display: flex; align-items: center; justify-content: center; font-family: 'Fraunces', serif; font-size: 12px; font-weight: 700; color: var(--accent); flex-shrink: 0; }
.lock-badge { font-size: 10px; font-weight: 700; color: var(--accent); background: rgba(232,197,71,0.12); padding: 2px 6px; border-radius: 5px; flex-shrink: 0; letter-spacing: 0.5px; }
.special-badge { font-size: 11px; font-weight: 600; color: var(--text3); background: var(--surface3); padding: 2px 8px; border-radius: 6px; }

/* GROCERY */
.grocery-header-card { background: linear-gradient(135deg, rgba(126,200,160,0.1), rgba(126,200,160,0.04)); border: 1px solid rgba(126,200,160,0.2); border-radius: var(--r); padding: 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 14px; }
.grocery-stat { text-align: center; flex: 1; }
.grocery-stat-num { font-family: 'Fraunces', serif; font-size: 28px; font-weight: 700; color: var(--green); line-height: 1; }
.grocery-stat-label { font-size: 11px; color: var(--text3); margin-top: 3px; }
.grocery-divider { width: 1px; height: 40px; background: var(--border); }
.grocery-category { margin-bottom: 20px; }
.cat-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; margin-bottom: 8px; }
.cat-title { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }
.cat-count { font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 6px; background: var(--surface2); color: var(--text3); }
.grocery-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 6px; cursor: pointer; transition: all 0.15s; user-select: none; }
.grocery-item.checked { opacity: 0.45; }
.grocery-item.have-it { opacity: 0.35; }
.grocery-item:hover { border-color: var(--text3); }
.check-box { width: 22px; height: 22px; border-radius: 7px; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s; }
.check-box svg { display: none; }
.grocery-item.checked .check-box { background: var(--green); border-color: var(--green); }
.grocery-item.checked .check-box svg { display: block; }
.item-info { flex: 1; min-width: 0; }
.item-name { font-size: 14px; font-weight: 500; color: var(--text); }
.grocery-item.checked .item-name { text-decoration: line-through; color: var(--text3); }
.item-qty { font-size: 12px; color: var(--text3); }
.have-it-btn { font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px; background: var(--surface2); color: var(--text3); border: 1px solid var(--border); cursor: pointer; flex-shrink: 0; transition: all 0.15s; }
.have-it-btn.active { background: rgba(126,200,160,0.15); color: var(--green); border-color: rgba(126,200,160,0.3); }

/* INSIGHTS */
.insight-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.insight-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 16px; }
.insight-card.wide { grid-column: 1 / -1; }
.insight-icon-wrap { width: 32px; height: 32px; border-radius: 9px; background: var(--surface2); display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
.insight-icon-wrap svg { width: 16px; height: 16px; }
.insight-val { font-family: 'Fraunces', serif; font-size: 26px; font-weight: 700; color: var(--text); line-height: 1; margin-bottom: 4px; }
.insight-label { font-size: 11px; color: var(--text3); }
.insight-observations { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); overflow: hidden; margin-bottom: 20px; }
.obs-header { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 8px; }
.obs-item { display: flex; align-items: flex-start; gap: 12px; padding: 14px 16px; border-bottom: 1px solid var(--border); }
.obs-item:last-child { border-bottom: none; }
.obs-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }
.obs-text { font-size: 13px; color: var(--text2); line-height: 1.5; }
.obs-text strong { color: var(--text); font-weight: 600; }
.cuisine-bars { margin-bottom: 20px; }
.cuisine-bar { margin-bottom: 10px; }
.cuisine-bar-label { display: flex; justify-content: space-between; font-size: 12px; color: var(--text2); margin-bottom: 5px; }
.bar-track { height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 3px; transition: width 1s ease; }

/* MODAL */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 100; display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
.modal-overlay.open { opacity: 1; pointer-events: auto; }
.modal { background: var(--surface); border-radius: 24px 24px 0 0; width: 100%; max-width: 430px; margin: 0 auto; padding: 24px 24px 40px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); max-height: 85dvh; overflow-y: auto; }
.modal::-webkit-scrollbar { display: none; }
.modal-overlay.open .modal { transform: translateY(0); }
.modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 20px; }
.modal-title { font-family: 'Fraunces', serif; font-size: 22px; font-weight: 500; color: var(--text); margin-bottom: 16px; }
.recipe-initial-lg { width: 64px; height: 64px; border-radius: 16px; background: var(--surface2); display: flex; align-items: center; justify-content: center; font-family: 'Fraunces', serif; font-size: 28px; font-weight: 700; color: var(--accent); margin-bottom: 12px; border: 1px solid var(--border); }
.meta-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
.meta-pill { padding: 5px 12px; border-radius: 8px; background: var(--surface2); border: 1px solid var(--border); font-size: 12px; color: var(--text2); }
.ingr-list { margin-bottom: 16px; }
.ingr-item { display: flex; justify-content: space-between; align-items: center; padding: 9px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
.ingr-item:last-child { border-bottom: none; }
.ingr-name-text { color: var(--text); }
.ingr-qty-text { color: var(--text3); font-size: 12px; }
.modal-btn { width: 100%; padding: 14px; border-radius: var(--r); border: none; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s; margin-top: 8px; }
.modal-btn-primary { background: var(--accent); color: #111; }
.modal-btn-primary:hover { box-shadow: 0 4px 16px rgba(232,197,71,0.3); }
.modal-btn-secondary { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }

/* SLOT PICKER */
.slot-options { display: flex; flex-direction: column; gap: 8px; }
.slot-option { display: flex; align-items: center; gap: 14px; padding: 14px 16px; border-radius: 12px; border: 1px solid var(--border); background: var(--surface2); cursor: pointer; transition: all 0.15s; font-size: 14px; font-weight: 500; color: var(--text); }
.slot-option:hover { border-color: var(--text3); }
.slot-option-initial { width: 28px; height: 28px; border-radius: 8px; background: var(--surface3); display: flex; align-items: center; justify-content: center; font-family: 'Fraunces', serif; font-size: 12px; font-weight: 700; color: var(--accent); flex-shrink: 0; }
.slot-option-icon { width: 28px; height: 28px; border-radius: 8px; background: var(--surface3); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.slot-option-icon svg { width: 14px; height: 14px; }

/* FORM */
.form-group { margin-bottom: 16px; }
.form-label { font-size: 12px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; display: block; }
.form-input, .form-select, .form-textarea { width: 100%; padding: 12px 14px; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; outline: none; transition: border-color 0.15s; }
.form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); }
.form-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%235c5a55' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 14px center; padding-right: 36px; }
.form-textarea { resize: none; height: 80px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* INGREDIENT ROWS */
.ingr-row { display: grid; grid-template-columns: 1fr 80px 80px 32px; gap: 6px; align-items: center; animation: slideIn 0.18s ease; }
@keyframes slideIn { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
.ingr-row .form-input { padding: 10px 10px; font-size: 13px; }
.ingr-row-remove { width: 32px; height: 38px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface2); color: var(--text3); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.15s; flex-shrink: 0; line-height: 1; }
.ingr-row-remove:hover { background: rgba(224,112,112,0.15); border-color: var(--red); color: var(--red); }
.ingr-col-labels { display: grid; grid-template-columns: 1fr 80px 80px 32px; gap: 6px; margin-bottom: 4px; }
.ingr-col-label { font-size: 10px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 0.6px; padding-left: 2px; }
.add-ingr-btn { width: 100%; padding: 10px; border-radius: 10px; border: 1px dashed var(--border); background: transparent; color: var(--text3); font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 6px; }
.add-ingr-btn:hover { border-color: var(--accent); color: var(--accent); }

/* TOAST */
.toast { position: fixed; bottom: calc(var(--tab-h) + 16px); left: 50%; transform: translateX(-50%) translateY(20px); background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; padding: 12px 20px; font-size: 13px; font-weight: 500; color: var(--text); z-index: 200; white-space: nowrap; opacity: 0; transition: all 0.3s; max-width: 340px; }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* EMPTY STATE */
.empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center; gap: 12px; }
.empty-title { font-family: 'Fraunces', serif; font-size: 20px; font-weight: 500; color: var(--text2); }
.empty-sub { font-size: 13px; color: var(--text3); max-width: 220px; line-height: 1.5; }
.empty-icon-wrap { width: 64px; height: 64px; border-radius: 20px; background: var(--surface); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; }
.empty-icon-wrap svg { width: 28px; height: 28px; color: var(--text3); }

/* SETTINGS */
.settings-section { margin-bottom: 24px; }
.settings-label { font-size: 11px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
.settings-row { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 6px; }
.settings-row-left { display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; color: var(--text); }
.settings-icon-wrap { width: 28px; height: 28px; border-radius: 8px; background: var(--surface2); display: flex; align-items: center; justify-content: center; }
.settings-icon-wrap svg { width: 14px; height: 14px; }
.toggle { width: 44px; height: 26px; background: var(--surface2); border-radius: 13px; border: 1px solid var(--border); cursor: pointer; position: relative; transition: background 0.2s; flex-shrink: 0; }
.toggle.on { background: var(--green); border-color: var(--green); }
.toggle::after { content: ''; position: absolute; width: 20px; height: 20px; border-radius: 50%; background: white; top: 2px; left: 2px; transition: transform 0.2s; }
.toggle.on::after { transform: translateX(18px); }

/* MISC */
.divider { height: 1px; background: var(--border); margin: 16px 0; }
.scroll-fade { position: absolute; bottom: var(--tab-h); left: 0; right: 0; height: 40px; background: linear-gradient(to top, var(--bg), transparent); pointer-events: none; z-index: 5; }
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <header class="header">
    <div>
      <div class="header-logo">Mise</div>
      <div class="header-subtitle">Personal Cooking Intelligence</div>
    </div>
    <div class="header-right">
      <div class="unsaved-dot" id="unsaved-dot" title="Unsaved changes"></div>
      <button class="header-btn save-btn" id="save-btn" onclick="saveAll()">
        <svg class="save-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8">
          <path d="M13 13H3a1 1 0 01-1-1V4a1 1 0 011-1h7.5L14 6.5V12a1 1 0 01-1 1z"/>
          <rect x="5" y="9" width="6" height="4" rx="0.5"/>
          <rect x="5.5" y="3" width="4" height="3" rx="0.5"/>
        </svg>
        Save
      </button>
      <button class="header-btn" onclick="openSettings()">
        <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8">
          <circle cx="8" cy="8" r="2.5"/>
          <path d="M8 1v1.5M8 13.5V15M1 8h1.5M13.5 8H15M3.05 3.05l1.06 1.06M11.89 11.89l1.06 1.06M3.05 12.95l1.06-1.06M11.89 4.11l1.06-1.06"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- SCREENS -->
  <div class="screens">

    <!-- RECIPES -->
    <div class="screen active" id="screen-recipes">
      <div class="section-title">Your Recipes</div>
      <div class="section-sub" id="recipe-count-sub">Loading…</div>
      <div class="search-bar">
        <svg class="search-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8">
          <circle cx="7" cy="7" r="4.5"/><path d="M10.5 10.5L14 14"/>
        </svg>
        <input type="text" placeholder="Search recipes…" id="recipe-search" oninput="filterRecipes()">
      </div>
      <div class="chips" id="filter-chips">
        <div class="chip active" onclick="setFilter('all', this)">All</div>
        <div class="chip" onclick="setFilter('dinner', this)">Dinner</div>
        <div class="chip" onclick="setFilter('lunch', this)">Lunch</div>
        <div class="chip" onclick="setFilter('breakfast', this)">Breakfast</div>
        <div class="chip" onclick="setFilter('quick', this)">Quick &lt;30min</div>
        <div class="chip" onclick="setFilter('high-protein', this)">High Protein</div>
        <div class="chip" onclick="setFilter('comfort', this)">Comfort</div>
      </div>
      <div class="recipe-grid" id="recipe-grid"></div>
    </div>

    <!-- PLAN -->
    <div class="screen" id="screen-plan">
      <div class="section-title">Weekly Plan</div>
      <div class="week-controls">
        <button class="week-nav" onclick="changeWeek(-1)">&#8249;</button>
        <span class="week-label" id="week-label"></span>
        <button class="week-nav" onclick="changeWeek(1)">&#8250;</button>
      </div>
      <button class="autofill-btn" onclick="autoFillWeek()">
        <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 1v6M8 1L5 4M8 1l3 3M1 10a7 7 0 0014 0"/>
        </svg>
        Auto-fill Week with Suggestions
      </button>
      <div id="plan-days"></div>
    </div>

    <!-- GROCERY -->
    <div class="screen" id="screen-grocery">
      <div class="section-title">Grocery List</div>
      <div class="section-sub" id="grocery-week-label"></div>
      <div class="grocery-header-card">
        <div class="grocery-stat">
          <div class="grocery-stat-num" id="grocery-total">0</div>
          <div class="grocery-stat-label">Items</div>
        </div>
        <div class="grocery-divider"></div>
        <div class="grocery-stat">
          <div class="grocery-stat-num" id="grocery-checked">0</div>
          <div class="grocery-stat-label">Checked</div>
        </div>
        <div class="grocery-divider"></div>
        <div class="grocery-stat">
          <div class="grocery-stat-num" id="grocery-have">0</div>
          <div class="grocery-stat-label">Have It</div>
        </div>
      </div>
      <div id="grocery-list"></div>
    </div>

    <!-- INSIGHTS -->
    <div class="screen" id="screen-insights">
      <div class="section-title">Your Habits</div>
      <div class="section-sub">Last 90 days of cooking</div>
      <div class="insight-cards">
        <div class="insight-card">
          <div class="insight-icon-wrap">
            <svg viewBox="0 0 16 16" fill="none" stroke="var(--accent)" stroke-width="1.8"><circle cx="8" cy="8" r="6.5"/><path d="M8 4.5v3.5l2 2"/></svg>
          </div>
          <div class="insight-val">4.2</div>
          <div class="insight-label">Meals cooked / week</div>
        </div>
        <div class="insight-card">
          <div class="insight-icon-wrap">
            <svg viewBox="0 0 16 16" fill="none" stroke="var(--accent)" stroke-width="1.8"><polygon points="8,2 10,6 14,6.5 11,9.5 11.8,13.5 8,11.5 4.2,13.5 5,9.5 2,6.5 6,6"/></svg>
          </div>
          <div class="insight-val">4.4</div>
          <div class="insight-label">Average rating</div>
        </div>
        <div class="insight-card">
          <div class="insight-icon-wrap">
            <svg viewBox="0 0 16 16" fill="none" stroke="var(--orange)" stroke-width="1.8"><path d="M8 2c-2 3-4 4.5-4 7a4 4 0 008 0c0-2.5-2-4-4-7z"/></svg>
          </div>
          <div class="insight-val">Mexican</div>
          <div class="insight-label">Favourite cuisine</div>
        </div>
        <div class="insight-card">
          <div class="insight-icon-wrap">
            <svg viewBox="0 0 16 16" fill="none" stroke="var(--green)" stroke-width="1.8"><path d="M3 8h10M8 3l5 5-5 5"/></svg>
          </div>
          <div class="insight-val">12</div>
          <div class="insight-label">Day cooking streak</div>
        </div>
        <div class="insight-card wide">
          <div class="insight-icon-wrap">
            <svg viewBox="0 0 16 16" fill="none" stroke="var(--accent)" stroke-width="1.8"><polygon points="8,2 10,6 14,6.5 11,9.5 11.8,13.5 8,11.5 4.2,13.5 5,9.5 2,6.5 6,6"/></svg>
          </div>
          <div class="insight-val">Tacos al Pastor</div>
          <div class="insight-label">Most cooked recipe — 9 times this year</div>
        </div>
      </div>
      <div class="insight-observations">
        <div class="obs-header">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="var(--accent)" stroke-width="1.8"><circle cx="8" cy="8" r="6.5"/><path d="M8 7v4M8 5v.5"/></svg>
          Patterns Detected
        </div>
        <div class="obs-item"><div class="obs-dot" style="background:var(--accent)"></div><div class="obs-text">You tend to eat <strong>pasta every 9–12 days</strong> — pretty consistent!</div></div>
        <div class="obs-item"><div class="obs-dot" style="background:var(--orange)"></div><div class="obs-text">You <strong>avoid complex meals on Mondays</strong> — easy recipes dominate Monday evenings.</div></div>
        <div class="obs-item"><div class="obs-dot" style="background:var(--red)"></div><div class="obs-text"><strong>Chili Con Carne</strong> hasn't been made in 47 days — it's rated 4.8. Time to revisit?</div></div>
        <div class="obs-item"><div class="obs-dot" style="background:var(--blue)"></div><div class="obs-text">You cook <strong>more adventurous meals on weekends</strong> — 78% of hard recipes are Fri–Sun.</div></div>
        <div class="obs-item"><div class="obs-dot" style="background:var(--green)"></div><div class="obs-text">You follow through on <strong>72% of planned meals</strong> — above average.</div></div>
      </div>
      <div class="section-title" style="font-size:18px;margin-bottom:14px;">Cuisine Mix</div>
      <div class="cuisine-bars" id="cuisine-bars"></div>
    </div>

  </div>

  <div class="scroll-fade"></div>

  <!-- FAB -->
  <button class="fab" onclick="openAddRecipe()" title="Add Recipe">+</button>

  <!-- TABBAR -->
  <nav class="tabbar">
    <button class="tab active" onclick="switchTab('recipes', this)">
      <svg class="tab-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6">
        <rect x="3" y="3" width="6" height="6" rx="1.5"/><rect x="11" y="3" width="6" height="6" rx="1.5"/>
        <rect x="3" y="11" width="6" height="6" rx="1.5"/><rect x="11" y="11" width="6" height="6" rx="1.5"/>
      </svg>
      <span class="tab-label">Recipes</span>
      <div class="tab-indicator"></div>
    </button>
    <button class="tab" onclick="switchTab('plan', this)">
      <svg class="tab-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6">
        <rect x="3" y="4" width="14" height="13" rx="2"/><path d="M7 2v4M13 2v4M3 9h14"/>
      </svg>
      <span class="tab-label">Plan</span>
      <div class="tab-indicator"></div>
    </button>
    <button class="tab" onclick="switchTab('grocery', this)">
      <svg class="tab-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6">
        <path d="M3 3h2l2.5 9h8l2-6H7"/><circle cx="9" cy="16" r="1.2"/><circle cx="15" cy="16" r="1.2"/>
      </svg>
      <span class="tab-label">Grocery</span>
      <div class="tab-indicator"></div>
    </button>
    <button class="tab" onclick="switchTab('insights', this)">
      <svg class="tab-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6">
        <path d="M3 15l4-5 4 2 4-7"/><circle cx="15" cy="5" r="1.5"/>
      </svg>
      <span class="tab-label">Insights</span>
      <div class="tab-indicator"></div>
    </button>
  </nav>

</div>

<!-- MODAL: Recipe Detail -->
<div class="modal-overlay" id="modal-recipe" onclick="closeModal('modal-recipe')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div id="modal-recipe-content"></div>
  </div>
</div>

<!-- MODAL: Slot Picker -->
<div class="modal-overlay" id="modal-slot" onclick="closeModal('modal-slot')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title" id="slot-modal-title">Choose Meal</div>
    <div class="slot-options" id="slot-options"></div>
  </div>
</div>

<!-- MODAL: Add Recipe -->
<div class="modal-overlay" id="modal-add" onclick="closeModal('modal-add')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">New Recipe</div>
    <div class="form-group">
      <label class="form-label">Recipe Name</label>
      <input type="text" class="form-input" placeholder="e.g. Grandma's Lasagna" id="new-name">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Category</label>
        <select class="form-select" id="new-category">
          <option>Dinner</option><option>Lunch</option><option>Breakfast</option><option>Snack</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Difficulty</label>
        <select class="form-select" id="new-diff">
          <option>Easy</option><option>Medium</option><option>Hard</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Prep (min)</label>
        <input type="number" class="form-input" placeholder="15" id="new-prep">
      </div>
      <div class="form-group">
        <label class="form-label">Cook (min)</label>
        <input type="number" class="form-input" placeholder="30" id="new-cook">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Cuisine</label>
      <input type="text" class="form-input" placeholder="e.g. Italian" id="new-cuisine">
    </div>
    <div class="form-group">
      <label class="form-label">Ingredients</label>
      <div id="ingredient-rows" style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px;"></div>
      <button type="button" class="add-ingr-btn" onclick="addIngredientRow()">
        <svg width="13" height="13" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 1v12M1 7h12"/></svg>
        Add Ingredient
      </button>
    </div>
    <div class="form-group">
      <label class="form-label">Notes / Instructions</label>
      <textarea class="form-textarea" placeholder="Brief instructions or notes…" id="new-notes"></textarea>
    </div>
    <button class="modal-btn modal-btn-primary" onclick="saveNewRecipe()">Save Recipe</button>
    <button class="modal-btn modal-btn-secondary" onclick="closeModal('modal-add')">Cancel</button>
  </div>
</div>

<!-- MODAL: Settings -->
<div class="modal-overlay" id="modal-settings" onclick="closeModal('modal-settings')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">Settings</div>
    <div class="settings-section">
      <div class="settings-label">Household</div>
      <div class="settings-row">
        <div class="settings-row-left">
          <div class="settings-icon-wrap"><svg viewBox="0 0 16 16" fill="none" stroke="var(--text3)" stroke-width="1.8"><circle cx="8" cy="5.5" r="3"/><path d="M2 14c0-3.3 2.7-6 6-6s6 2.7 6 6"/></svg></div>
          Your Name
        </div>
        <span style="font-size:13px;color:var(--text2)">Sarah</span>
      </div>
      <div class="settings-row">
        <div class="settings-row-left">
          <div class="settings-icon-wrap"><svg viewBox="0 0 16 16" fill="none" stroke="var(--text3)" stroke-width="1.8"><circle cx="5" cy="5" r="2.5"/><circle cx="11" cy="5" r="2.5"/><path d="M1 14c0-2.8 1.8-5 4-5M15 14c0-2.8-1.8-5-4-5"/></svg></div>
          Household Members
        </div>
        <span style="font-size:13px;color:var(--text2)">2</span>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-label">Planning</div>
      <div class="settings-row">
        <div class="settings-row-left">
          <div class="settings-icon-wrap"><svg viewBox="0 0 16 16" fill="none" stroke="var(--text3)" stroke-width="1.8"><rect x="2" y="3" width="12" height="11" rx="2"/><path d="M5 1.5v3M11 1.5v3M2 7.5h12"/></svg></div>
          Week starts on
        </div>
        <span style="font-size:13px;color:var(--text2)">Monday</span>
      </div>
      <div class="settings-row">
        <div class="settings-row-left">
          <div class="settings-icon-wrap"><svg viewBox="0 0 16 16" fill="none" stroke="var(--text3)" stroke-width="1.8"><path d="M8 2c-2 3-4 4-4 6.5a4 4 0 008 0C12 6 10 5 8 2z"/></svg></div>
          Seasonality hints
        </div>
        <div class="toggle on" onclick="this.classList.toggle('on');markUnsaved()"></div>
      </div>
      <div class="settings-row">
        <div class="settings-row-left">
          <div class="settings-icon-wrap"><svg viewBox="0 0 16 16" fill="none" stroke="var(--text3)" stroke-width="1.8"><rect x="2" y="4" width="12" height="9" rx="1.5"/><path d="M5 4V3a1 1 0 012 0v1M9 4V3a1 1 0 012 0v1"/></svg></div>
          Exclude pantry staples
        </div>
        <div class="toggle on" onclick="this.classList.toggle('on');markUnsaved()"></div>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-label">Data</div>
      <div class="settings-row">
        <div class="settings-row-left">
          <div class="settings-icon-wrap"><svg viewBox="0 0 16 16" fill="none" stroke="var(--text3)" stroke-width="1.8"><path d="M8 1v8M4.5 5L8 1l3.5 4M3 11h10a1 1 0 010 2H3a1 1 0 010-2z"/></svg></div>
          Export data
        </div>
        <button onclick="exportData()" style="font-size:12px;font-weight:600;padding:5px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;">Export JSON</button>
      </div>
      <div class="settings-row">
        <div class="settings-row-left">
          <div class="settings-icon-wrap"><svg viewBox="0 0 16 16" fill="none" stroke="var(--red)" stroke-width="1.8"><path d="M3 4h10M6 4V2h4v2M5 4v9a1 1 0 001 1h4a1 1 0 001-1V4"/></svg></div>
          <span style="color:var(--red)">Clear all data</span>
        </div>
        <button onclick="clearAllData()" style="font-size:12px;font-weight:600;padding:5px 12px;border-radius:8px;border:1px solid rgba(224,112,112,0.3);background:rgba(224,112,112,0.1);color:var(--red);cursor:pointer;">Clear</button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ── SVG ICONS (inline, no emoji) ──────────────────────────
const ICONS = {
  search: `<svg width="15" height="15" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="7" cy="7" r="4.5"/><path d="M10.5 10.5L14 14"/></svg>`,
  lock: `<svg width="12" height="12" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2.5" y="6" width="9" height="7" rx="1.5"/><path d="M4.5 6V4.5a2.5 2.5 0 015 0V6"/></svg>`,
  check: `<svg width="12" height="12" viewBox="0 0 14 14" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"><path d="M2.5 7.5L6 11l5.5-7"/></svg>`,
};

// ── DEFAULT SEED DATA ─────────────────────────────────────
const SEED_RECIPES = [
  { id:1,  name:'Tacos al Pastor',       category:'dinner',    cuisine:'Mexican',        diff:'medium', prep:20, cook:25, rating:4.9, tags:['high-protein','comfort'], daysAgo:3,
    ingredients:[{name:'Pork shoulder',qty:'500g'},{name:'Chipotle chillies',qty:'3'},{name:'Pineapple',qty:'half'},{name:'Corn tortillas',qty:'12'},{name:'Onion',qty:'1'},{name:'Coriander',qty:'1 bunch'}] },
  { id:2,  name:'Rigatoni Amatriciana',   category:'dinner',    cuisine:'Italian',        diff:'easy',   prep:10, cook:25, rating:4.7, tags:['comfort','quick'],       daysAgo:12,
    ingredients:[{name:'Rigatoni',qty:'400g'},{name:'Pancetta',qty:'150g'},{name:'San Marzano tomatoes',qty:'400g'},{name:'Pecorino',qty:'80g'},{name:'Chilli flakes',qty:'1 tsp'}] },
  { id:3,  name:'Thai Green Curry',       category:'dinner',    cuisine:'Thai',           diff:'medium', prep:15, cook:30, rating:4.8, tags:['high-protein','comfort'], daysAgo:18,
    ingredients:[{name:'Chicken thighs',qty:'600g'},{name:'Coconut milk',qty:'400ml'},{name:'Green curry paste',qty:'3 tbsp'},{name:'Aubergine',qty:'1'},{name:'Thai basil',qty:'1 bunch'},{name:'Fish sauce',qty:'2 tbsp'}] },
  { id:4,  name:'Blueberry Pancakes',     category:'breakfast', cuisine:'American',       diff:'easy',   prep:10, cook:20, rating:4.5, tags:['quick','comfort'],       daysAgo:6,
    ingredients:[{name:'Sourdough starter',qty:'200g'},{name:'Egg',qty:'2'},{name:'Blueberries',qty:'150g'},{name:'Butter',qty:'30g'},{name:'Maple syrup',qty:'to serve'}] },
  { id:5,  name:'Nicoise Salad',          category:'lunch',     cuisine:'French',         diff:'easy',   prep:20, cook:10, rating:4.3, tags:['high-protein','quick'],  daysAgo:8,
    ingredients:[{name:'Tuna steak',qty:'2'},{name:'Green beans',qty:'200g'},{name:'Eggs',qty:'4'},{name:'Cherry tomatoes',qty:'200g'},{name:'Olives',qty:'80g'},{name:'Anchovies',qty:'8'}] },
  { id:6,  name:'Chili Con Carne',        category:'dinner',    cuisine:'Tex-Mex',        diff:'medium', prep:20, cook:60, rating:4.8, tags:['high-protein','comfort'], daysAgo:47,
    ingredients:[{name:'Ground beef',qty:'500g'},{name:'Kidney beans',qty:'400g'},{name:'Chopped tomatoes',qty:'400g'},{name:'Chipotle paste',qty:'2 tbsp'},{name:'Dark chocolate',qty:'20g'},{name:'Cumin',qty:'2 tsp'}] },
  { id:7,  name:'Salmon Teriyaki Bowl',   category:'dinner',    cuisine:'Japanese',       diff:'easy',   prep:10, cook:20, rating:4.6, tags:['high-protein','quick'],  daysAgo:22,
    ingredients:[{name:'Salmon fillet',qty:'2'},{name:'Soy sauce',qty:'3 tbsp'},{name:'Mirin',qty:'2 tbsp'},{name:'Jasmine rice',qty:'300g'},{name:'Edamame',qty:'100g'},{name:'Sesame seeds',qty:'1 tbsp'}] },
  { id:8,  name:'Shakshuka',              category:'breakfast', cuisine:'Middle Eastern', diff:'easy',   prep:5,  cook:25, rating:4.4, tags:['comfort','quick'],       daysAgo:14,
    ingredients:[{name:'Eggs',qty:'4'},{name:'Canned tomatoes',qty:'400g'},{name:'Red peppers',qty:'2'},{name:'Feta cheese',qty:'80g'},{name:'Harissa',qty:'1 tbsp'},{name:'Crusty bread',qty:'to serve'}] },
  { id:9,  name:'Roast Chicken and Veg',  category:'dinner',    cuisine:'British',        diff:'medium', prep:20, cook:75, rating:4.9, tags:['comfort','high-protein'], daysAgo:35,
    ingredients:[{name:'Whole chicken',qty:'1.5kg'},{name:'Potatoes',qty:'600g'},{name:'Carrots',qty:'3'},{name:'Garlic',qty:'1 head'},{name:'Thyme',qty:'4 sprigs'},{name:'Lemon',qty:'1'}] },
  { id:10, name:'Chicken Caesar Wrap',    category:'lunch',     cuisine:'American',       diff:'easy',   prep:15, cook:0,  rating:4.1, tags:['quick','high-protein'], daysAgo:5,
    ingredients:[{name:'Grilled chicken',qty:'200g'},{name:'Romaine lettuce',qty:'1 head'},{name:'Caesar dressing',qty:'3 tbsp'},{name:'Parmesan',qty:'40g'},{name:'Flour tortilla',qty:'2'}] },
];

const SEED_GROCERY = [
  { id:1,  name:'Pork shoulder',       qty:'500g',    cat:'meat',    checked:false, haveIt:false, source:'Tacos al Pastor' },
  { id:2,  name:'Chicken thighs',      qty:'600g',    cat:'meat',    checked:false, haveIt:false, source:'Thai Green Curry' },
  { id:3,  name:'Ground beef',         qty:'500g',    cat:'meat',    checked:true,  haveIt:false, source:'Chili Con Carne' },
  { id:4,  name:'Rigatoni',            qty:'400g',    cat:'pantry',  checked:false, haveIt:false, source:'Amatriciana' },
  { id:5,  name:'Coconut milk',        qty:'400ml',   cat:'pantry',  checked:false, haveIt:true,  source:'Thai Green Curry' },
  { id:6,  name:'Canned tomatoes',     qty:'800g',    cat:'pantry',  checked:false, haveIt:false, source:'Amatriciana, Chili' },
  { id:7,  name:'Kidney beans',        qty:'400g',    cat:'pantry',  checked:false, haveIt:true,  source:'Chili Con Carne' },
  { id:8,  name:'Green curry paste',   qty:'1 jar',   cat:'pantry',  checked:false, haveIt:false, source:'Thai Green Curry' },
  { id:9,  name:'Chipotle paste',      qty:'1 jar',   cat:'pantry',  checked:true,  haveIt:false, source:'Chili Con Carne' },
  { id:10, name:'Onions',              qty:'4 large', cat:'produce', checked:false, haveIt:false, source:'Multiple' },
  { id:11, name:'Garlic',              qty:'2 heads', cat:'produce', checked:false, haveIt:false, source:'Multiple' },
  { id:12, name:'Fresh coriander',     qty:'2 bunches',cat:'produce',checked:false, haveIt:false, source:'Tacos, Curry' },
  { id:13, name:'Aubergine',           qty:'1 large', cat:'produce', checked:false, haveIt:false, source:'Thai Green Curry' },
  { id:14, name:'Cherry tomatoes',     qty:'400g',    cat:'produce', checked:false, haveIt:false, source:'Multiple' },
  { id:15, name:'Pineapple',           qty:'1 small', cat:'produce', checked:true,  haveIt:false, source:'Tacos al Pastor' },
  { id:16, name:'Limes',               qty:'4',       cat:'produce', checked:false, haveIt:false, source:'Tacos, Curry' },
  { id:17, name:'Pancetta',            qty:'150g',    cat:'meat',    checked:false, haveIt:false, source:'Amatriciana' },
  { id:18, name:'Pecorino Romano',     qty:'100g',    cat:'dairy',   checked:false, haveIt:true,  source:'Amatriciana' },
  { id:19, name:'Eggs',                qty:'12',      cat:'dairy',   checked:false, haveIt:false, source:'Multiple' },
  { id:20, name:'Dark chocolate',      qty:'50g',     cat:'pantry',  checked:false, haveIt:true,  source:'Chili Con Carne' },
  { id:21, name:'Fish sauce',          qty:'1 bottle',cat:'pantry',  checked:false, haveIt:false, source:'Thai Green Curry' },
  { id:22, name:'Corn tortillas',      qty:'24',      cat:'bakery',  checked:false, haveIt:false, source:'Tacos al Pastor' },
  { id:23, name:'Thai basil',          qty:'1 bunch', cat:'produce', checked:false, haveIt:false, source:'Thai Green Curry' },
  { id:24, name:'San Marzano tomatoes',qty:'400g',    cat:'pantry',  checked:false, haveIt:false, source:'Amatriciana' },
  { id:25, name:'Blueberries',         qty:'300g',    cat:'produce', checked:false, haveIt:false, source:'Pancakes' },
  { id:26, name:'Maple syrup',         qty:'1 bottle',cat:'pantry',  checked:false, haveIt:true,  source:'Pancakes' },
  { id:27, name:'Sourdough starter',   qty:'200g',    cat:'bakery',  checked:false, haveIt:false, source:'Pancakes' },
];

const SEED_PLAN = {
  Mon: { breakfast: null, lunch: null, dinner: { recipeId: 2, locked: false } },
  Tue: { breakfast: null, lunch: null, dinner: { recipeId: 3, locked: false } },
  Wed: { breakfast: null, lunch: null, dinner: { special: 'eat_out', locked: false } },
  Thu: { breakfast: null, lunch: null, dinner: { recipeId: 7, locked: false } },
  Fri: { breakfast: null, lunch: null, dinner: { recipeId: 9, locked: true } },
  Sat: { breakfast: { recipeId: 4, locked: false }, lunch: null, dinner: null },
  Sun: { breakfast: null, lunch: null, dinner: { special: 'leftovers', locked: false } },
};

const CATEGORIES = {
  meat:    { label: 'Meat & Seafood', color: '#e07070' },
  produce: { label: 'Produce',        color: '#7ec8a0' },
  dairy:   { label: 'Dairy & Eggs',   color: '#7eb8c8' },
  pantry:  { label: 'Pantry',         color: '#e8c547' },
  bakery:  { label: 'Bakery',         color: '#e89b5c' },
  frozen:  { label: 'Frozen',         color: '#a0b4f0' },
};

const CUISINE_DATA = [
  { name: 'Mexican',  pct: 28, color: '#e07070' },
  { name: 'Italian',  pct: 22, color: '#e89b5c' },
  { name: 'Thai',     pct: 15, color: '#7ec8a0' },
  { name: 'Japanese', pct: 12, color: '#7eb8c8' },
  { name: 'British',  pct: 10, color: '#c8a0e8' },
  { name: 'Other',    pct: 13, color: '#5c5a55' },
];

const DAY_KEYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
const DAY_FULL = { Mon:'Monday', Tue:'Tuesday', Wed:'Wednesday', Thu:'Thursday', Fri:'Friday', Sat:'Saturday', Sun:'Sunday' };
const MEAL_TYPES = ['breakfast','lunch','dinner'];

// ── APP STATE ─────────────────────────────────────────────
let RECIPES = [];
let weekPlan = {};
let groceryItems = [];
let activeFilter = 'all';
let currentSlotTarget = null;
let weekOffset = 0;
let ingredientRowCount = 0;
let hasUnsavedChanges = false;
let nextRecipeId = 100;
let nextGroceryId = 100;

// ── LOCAL STORAGE ─────────────────────────────────────────
const LS_RECIPES   = 'mise_recipes';
const LS_PLAN      = 'mise_plan';
const LS_GROCERY   = 'mise_grocery';

function loadFromStorage() {
  try {
    const r = localStorage.getItem(LS_RECIPES);
    RECIPES = r ? JSON.parse(r) : JSON.parse(JSON.stringify(SEED_RECIPES));
    const p = localStorage.getItem(LS_PLAN);
    weekPlan = p ? JSON.parse(p) : JSON.parse(JSON.stringify(SEED_PLAN));
    const g = localStorage.getItem(LS_GROCERY);
    groceryItems = g ? JSON.parse(g) : JSON.parse(JSON.stringify(SEED_GROCERY));
    // Compute nextIds
    nextRecipeId = RECIPES.reduce((m, r) => Math.max(m, r.id), 0) + 1;
    nextGroceryId = groceryItems.reduce((m, i) => Math.max(m, i.id), 0) + 1;
  } catch(e) {
    RECIPES = JSON.parse(JSON.stringify(SEED_RECIPES));
    weekPlan = JSON.parse(JSON.stringify(SEED_PLAN));
    groceryItems = JSON.parse(JSON.stringify(SEED_GROCERY));
  }
}

function saveAll() {
  try {
    localStorage.setItem(LS_RECIPES, JSON.stringify(RECIPES));
    localStorage.setItem(LS_PLAN, JSON.stringify(weekPlan));
    localStorage.setItem(LS_GROCERY, JSON.stringify(groceryItems));
    hasUnsavedChanges = false;
    updateSaveBtn(true);
    showToast('All changes saved');
  } catch(e) {
    showToast('Save failed — storage may be full');
  }
}

function markUnsaved() {
  hasUnsavedChanges = true;
  updateSaveBtn(false);
}

function updateSaveBtn(saved) {
  const btn = document.getElementById('save-btn');
  const dot = document.getElementById('unsaved-dot');
  if (saved) {
    btn.classList.add('saved');
    btn.innerHTML = `<svg class="save-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M2.5 8.5L6 12l7.5-8"/></svg> Saved`;
    dot.classList.remove('show');
    setTimeout(() => {
      btn.classList.remove('saved');
      btn.innerHTML = `<svg class="save-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M13 13H3a1 1 0 01-1-1V4a1 1 0 011-1h7.5L14 6.5V12a1 1 0 01-1 1z"/><rect x="5" y="9" width="6" height="4" rx="0.5"/><rect x="5.5" y="3" width="4" height="3" rx="0.5"/></svg> Save`;
    }, 2000);
  } else {
    btn.classList.remove('saved');
    btn.innerHTML = `<svg class="save-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M13 13H3a1 1 0 01-1-1V4a1 1 0 011-1h7.5L14 6.5V12a1 1 0 01-1 1z"/><rect x="5" y="9" width="6" height="4" rx="0.5"/><rect x="5.5" y="3" width="4" height="3" rx="0.5"/></svg> Save`;
    dot.classList.add('show');
  }
}

function exportData() {
  const data = { recipes: RECIPES, weekPlan, groceryItems, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'mise-data.json';
  a.click();
}

function clearAllData() {
  if (!confirm('Clear all saved data and reset to defaults?')) return;
  localStorage.removeItem(LS_RECIPES);
  localStorage.removeItem(LS_PLAN);
  localStorage.removeItem(LS_GROCERY);
  loadFromStorage();
  filterRecipes();
  renderPlan();
  renderGrocery();
  closeModal('modal-settings');
  showToast('Data cleared and reset to defaults');
}

// ── TAB NAVIGATION ────────────────────────────────────────
function switchTab(name, el) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
  el.classList.add('active');
  if (name === 'grocery') renderGrocery();
}

// ── RECIPES ───────────────────────────────────────────────
function getInitials(name) {
  return name.split(' ').slice(0,2).map(w => w[0]).join('').toUpperCase();
}

function setFilter(filter, el) {
  activeFilter = filter;
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  filterRecipes();
}

function filterRecipes() {
  const q = (document.getElementById('recipe-search').value || '').toLowerCase();
  let list = RECIPES;
  if (activeFilter !== 'all') {
    list = list.filter(r => r.category === activeFilter || r.tags.includes(activeFilter));
  }
  if (q) list = list.filter(r => r.name.toLowerCase().includes(q) || r.cuisine.toLowerCase().includes(q));
  renderRecipes(list);
}

function renderRecipes(list) {
  if (list === undefined) list = RECIPES;
  document.getElementById('recipe-count-sub').textContent = RECIPES.length + ' personal recipes';
  const grid = document.getElementById('recipe-grid');
  if (!list.length) {
    grid.innerHTML = `<div class="empty-state">
      <div class="empty-icon-wrap"><svg viewBox="0 0 28 28" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="4" y="4" width="8" height="8" rx="1.5"/><rect x="16" y="4" width="8" height="8" rx="1.5"/><rect x="4" y="16" width="8" height="8" rx="1.5"/><rect x="16" y="16" width="8" height="8" rx="1.5"/></svg></div>
      <div class="empty-title">No recipes found</div>
      <div class="empty-sub">Try a different search or add a new recipe with the + button.</div>
    </div>`;
    return;
  }
  grid.innerHTML = list.map(r => `
    <div class="recipe-card" onclick="openRecipe(${r.id})">
      <div class="recipe-initial">${getInitials(r.name)}</div>
      <div class="recipe-info">
        <div class="recipe-name">${r.name}</div>
        <div class="recipe-meta">
          <span class="recipe-tag tag-${r.category}">${r.category}</span>
          <span class="recipe-time">${r.prep + r.cook} min</span>
          ${r.rating ? `<span class="recipe-rating">&#9733; ${r.rating}</span>` : ''}
        </div>
        <div style="font-size:11px;color:var(--text3);margin-top:4px;">${r.cuisine}${r.tags.length ? ' &middot; ' + r.tags.map(t=>'#'+t).join(' ') : ''}</div>
      </div>
      <div class="recipe-right">
        <span class="diff-badge diff-${r.diff}">${r.diff}</span>
        <span class="days-ago">${r.daysAgo === 0 ? 'Today' : r.daysAgo + 'd ago'}</span>
      </div>
    </div>
  `).join('');
}

function openRecipe(id) {
  const r = RECIPES.find(x => x.id === id);
  if (!r) return;
  const ingrHtml = r.ingredients.length
    ? r.ingredients.map(i=>`<div class="ingr-item"><span class="ingr-name-text">${i.name}</span><span class="ingr-qty-text">${i.qty}</span></div>`).join('')
    : `<div style="color:var(--text3);font-size:13px;padding:8px 0;">No ingredients added.</div>`;
  document.getElementById('modal-recipe-content').innerHTML = `
    <div class="recipe-initial-lg">${getInitials(r.name)}</div>
    <div class="modal-title">${r.name}</div>
    <div class="meta-row">
      <span class="meta-pill">${r.cuisine}</span>
      <span class="meta-pill">${r.prep + r.cook} min</span>
      ${r.rating ? `<span class="meta-pill">&#9733; ${r.rating}</span>` : ''}
      <span class="meta-pill diff-badge diff-${r.diff}" style="padding:5px 12px;">${r.diff}</span>
    </div>
    <div style="font-size:12px;font-weight:700;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px;">Ingredients</div>
    <div class="ingr-list">${ingrHtml}</div>
    ${r.notes ? `<div style="font-size:13px;color:var(--text2);margin-bottom:12px;line-height:1.6;padding:12px;background:var(--surface2);border-radius:10px;">${r.notes}</div>` : ''}
    <div style="font-size:12px;color:var(--text3);margin-bottom:16px;">Last cooked: ${r.daysAgo === 0 ? 'today' : r.daysAgo + ' days ago'}</div>
    <button class="modal-btn modal-btn-primary" onclick="closeModal('modal-recipe'); showToast('Tap a slot in the Plan tab to place it')">+ Add to Plan</button>
    <button class="modal-btn" style="background:var(--surface2);color:var(--text2);border:1px solid var(--border);" onclick="logCooked(${r.id})">Mark as Cooked Today</button>
    <button class="modal-btn modal-btn-secondary" onclick="closeModal('modal-recipe')">Close</button>
  `;
  openModal('modal-recipe');
}

function logCooked(id) {
  const r = RECIPES.find(x => x.id === id);
  r.daysAgo = 0;
  markUnsaved();
  closeModal('modal-recipe');
  filterRecipes();
  showToast('Logged "' + r.name + '" as cooked today');
}

// ── PLAN ──────────────────────────────────────────────────
function getWeekLabel() {
  const base = new Date(2026, 1, 16); // Monday Feb 16
  const start = new Date(base);
  start.setDate(start.getDate() + weekOffset * 7);
  const end = new Date(start); end.setDate(end.getDate() + 6);
  const fmt = d => d.toLocaleDateString('en-GB', { month:'short', day:'numeric' });
  return `${fmt(start)} \u2013 ${fmt(end)}`;
}

function changeWeek(dir) {
  weekOffset += dir;
  document.getElementById('week-label').textContent = getWeekLabel();
  document.getElementById('grocery-week-label').textContent = 'Week of ' + getWeekLabel();
  renderPlan();
}

function renderPlan() {
  const baseDate = new Date(2026, 1, 16);
  baseDate.setDate(baseDate.getDate() + weekOffset * 7);

  const html = DAY_KEYS.map((key, i) => {
    const d = new Date(baseDate); d.setDate(d.getDate() + i);
    const isToday = weekOffset === 0 && i === 1;
    const dateStr = d.toLocaleDateString('en-GB', { day:'numeric', month:'short' });
    const slots = weekPlan[key] || {};

    const mealSlots = MEAL_TYPES.map(type => {
      const slot = slots[type];
      if (!slot) return `<div class="meal-slot" onclick="openSlotModal('${key}','${type}')">
        <span class="meal-type-label">${type}</span>
        <span class="meal-slot-empty">Tap to add</span>
      </div>`;

      if (slot.special) {
        const labels = { eat_out:'Eating out', leftovers:'Leftovers' };
        return `<div class="meal-slot filled" onclick="openSlotModal('${key}','${type}')">
          <span class="meal-type-label">${type}</span>
          <div class="meal-slot-content"><div class="meal-slot-name">${labels[slot.special]}</div></div>
          <span class="special-badge">${slot.special === 'eat_out' ? 'out' : 'leftover'}</span>
          ${slot.locked ? `<span class="lock-badge">${ICONS.lock} locked</span>` : ''}
        </div>`;
      }

      const recipe = slot.recipeId ? RECIPES.find(r => r.id === slot.recipeId) : null;
      if (recipe) return `<div class="meal-slot filled ${slot.locked ? 'locked' : ''}" onclick="openSlotModal('${key}','${type}')">
        <span class="meal-type-label">${type}</span>
        <div class="meal-initials">${getInitials(recipe.name)}</div>
        <div class="meal-slot-content">
          <div class="meal-slot-name">${recipe.name}</div>
          <div class="meal-slot-meta">${recipe.cuisine} &middot; ${recipe.prep + recipe.cook}min</div>
        </div>
        ${slot.locked ? `<span class="lock-badge">locked</span>` : ''}
      </div>`;

      return `<div class="meal-slot" onclick="openSlotModal('${key}','${type}')">
        <span class="meal-type-label">${type}</span>
        <span class="meal-slot-empty">Tap to add</span>
      </div>`;
    }).join('');

    return `<div class="day-card ${isToday ? 'today' : ''}">
      <div class="day-header">
        <div><div class="day-name">${DAY_FULL[key]}</div><div class="day-date">${dateStr}</div></div>
        ${isToday ? '<span class="day-badge">Today</span>' : ''}
      </div>
      <div class="day-meals">${mealSlots}</div>
    </div>`;
  }).join('');

  document.getElementById('plan-days').innerHTML = html;
}

function autoFillWeek() {
  const pool = RECIPES.slice();
  pool.sort((a,b) => b.daysAgo - a.daysAgo); // prioritise least recent
  let filled = 0;
  DAY_KEYS.forEach((key, i) => {
    if (!weekPlan[key]) weekPlan[key] = { breakfast:null, lunch:null, dinner:null };
    const slot = weekPlan[key].dinner;
    if (!slot || !slot.locked) {
      weekPlan[key].dinner = { recipeId: pool[i % pool.length].id, locked: false };
      filled++;
    }
  });
  markUnsaved();
  renderPlan();
  showToast('Filled ' + filled + ' dinner slots');
}

function openSlotModal(dayKey, mealType) {
  currentSlotTarget = { dayKey, mealType };
  document.getElementById('slot-modal-title').textContent = DAY_FULL[dayKey] + ' \u2014 ' + mealType.charAt(0).toUpperCase() + mealType.slice(1);

  const top = RECIPES.slice(0, 6);
  const recipeOpts = top.map(r => `
    <div class="slot-option" onclick="assignSlotRecipe(${r.id})">
      <div class="slot-option-initial">${getInitials(r.name)}</div>
      <div>
        <div style="font-size:14px;font-weight:600;color:var(--text)">${r.name}</div>
        <div style="font-size:11px;color:var(--text3)">${r.cuisine} &middot; ${r.prep + r.cook}min${r.rating ? ' &middot; &#9733;' + r.rating : ''}</div>
      </div>
    </div>`).join('');

  document.getElementById('slot-options').innerHTML = `
    ${recipeOpts}
    <div class="divider"></div>
    <div class="slot-option" onclick="assignSlotSpecial('eat_out')">
      <div class="slot-option-icon"><svg viewBox="0 0 16 16" fill="none" stroke="var(--text2)" stroke-width="1.8"><circle cx="8" cy="8" r="6.5"/><path d="M5 8h6M8 5v6"/></svg></div>
      <div>Eating out</div>
    </div>
    <div class="slot-option" onclick="assignSlotSpecial('leftovers')">
      <div class="slot-option-icon"><svg viewBox="0 0 16 16" fill="none" stroke="var(--text2)" stroke-width="1.8"><path d="M4 8a4 4 0 018 0M8 12V8M5 12h6"/></svg></div>
      <div>Leftovers</div>
    </div>
    <div class="slot-option" onclick="clearSlot()" style="color:var(--red)">
      <div class="slot-option-icon"><svg viewBox="0 0 16 16" fill="none" stroke="var(--red)" stroke-width="1.8"><path d="M3 3l10 10M13 3L3 13"/></svg></div>
      <div>Clear slot</div>
    </div>
  `;
  openModal('modal-slot');
}

function assignSlotRecipe(id) {
  const { dayKey, mealType } = currentSlotTarget;
  if (!weekPlan[dayKey]) weekPlan[dayKey] = {};
  weekPlan[dayKey][mealType] = { recipeId: id, locked: false };
  markUnsaved();
  closeModal('modal-slot');
  renderPlan();
  const r = RECIPES.find(x => x.id === id);
  showToast('Added "' + r.name + '"');
}

function assignSlotSpecial(type) {
  const { dayKey, mealType } = currentSlotTarget;
  if (!weekPlan[dayKey]) weekPlan[dayKey] = {};
  weekPlan[dayKey][mealType] = { special: type, locked: false };
  markUnsaved();
  closeModal('modal-slot');
  renderPlan();
}

function clearSlot() {
  const { dayKey, mealType } = currentSlotTarget;
  if (weekPlan[dayKey]) weekPlan[dayKey][mealType] = null;
  markUnsaved();
  closeModal('modal-slot');
  renderPlan();
}

// ── GROCERY ───────────────────────────────────────────────
function renderGrocery() {
  const checked = groceryItems.filter(i => i.checked).length;
  const haveIt  = groceryItems.filter(i => i.haveIt).length;
  document.getElementById('grocery-total').textContent = groceryItems.length;
  document.getElementById('grocery-checked').textContent = checked;
  document.getElementById('grocery-have').textContent = haveIt;

  const grouped = {};
  groceryItems.forEach(item => {
    if (!grouped[item.cat]) grouped[item.cat] = [];
    grouped[item.cat].push(item);
  });

  const order = ['produce','meat','dairy','pantry','bakery','frozen'];
  let html = '';
  order.forEach(cat => {
    const items = grouped[cat];
    if (!items || !items.length) return;
    const catInfo = CATEGORIES[cat] || { label: cat, color: '#888' };
    const itemsHtml = items.map(item => `
      <div class="grocery-item ${item.checked ? 'checked' : ''} ${item.haveIt ? 'have-it' : ''}" onclick="toggleCheck(${item.id})">
        <div class="check-box">${ICONS.check}</div>
        <div class="item-info">
          <div class="item-name">${item.name}</div>
          <div class="item-qty">${item.qty} &nbsp;&middot;&nbsp; <span style="font-size:10px;">${item.source}</span></div>
        </div>
        <button class="have-it-btn ${item.haveIt ? 'active' : ''}" onclick="event.stopPropagation(); toggleHaveIt(${item.id})">
          ${item.haveIt ? 'Have it' : 'Have it?'}
        </button>
      </div>`).join('');
    html += `<div class="grocery-category">
      <div class="cat-header">
        <div class="cat-title">
          <div style="width:10px;height:10px;border-radius:3px;background:${catInfo.color};flex-shrink:0;"></div>
          ${catInfo.label}
        </div>
        <span class="cat-count">${items.length}</span>
      </div>
      ${itemsHtml}
    </div>`;
  });

  document.getElementById('grocery-list').innerHTML = html || '<div style="padding:40px 0;text-align:center;color:var(--text3);font-size:14px;">No grocery items yet.</div>';
}

function toggleCheck(id) {
  const item = groceryItems.find(i => i.id === id);
  if (item) { item.checked = !item.checked; markUnsaved(); renderGrocery(); }
}

function toggleHaveIt(id) {
  const item = groceryItems.find(i => i.id === id);
  if (item) { item.haveIt = !item.haveIt; markUnsaved(); renderGrocery(); }
}

// ── INSIGHTS ──────────────────────────────────────────────
function renderCuisineBars() {
  document.getElementById('cuisine-bars').innerHTML = CUISINE_DATA.map(c => `
    <div class="cuisine-bar">
      <div class="cuisine-bar-label"><span>${c.name}</span><span style="color:var(--text3)">${c.pct}%</span></div>
      <div class="bar-track"><div class="bar-fill" style="width:0%;background:${c.color}" data-w="${c.pct}"></div></div>
    </div>`).join('');
  setTimeout(() => {
    document.querySelectorAll('.bar-fill').forEach(b => { b.style.width = b.dataset.w + '%'; });
  }, 120);
}

// ── MODALS ────────────────────────────────────────────────
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function openSettings() { openModal('modal-settings'); }

function openAddRecipe() {
  document.getElementById('new-name').value = '';
  document.getElementById('new-cuisine').value = '';
  document.getElementById('new-prep').value = '';
  document.getElementById('new-cook').value = '';
  document.getElementById('new-notes').value = '';
  document.getElementById('new-category').selectedIndex = 0;
  document.getElementById('new-diff').selectedIndex = 0;
  const labels = document.getElementById('ingr-col-labels');
  if (labels) labels.remove();
  document.getElementById('ingredient-rows').innerHTML = '';
  ingredientRowCount = 0;
  addIngredientRow();
  openModal('modal-add');
}

function addIngredientRow() {
  const container = document.getElementById('ingredient-rows');
  if (ingredientRowCount === 0) {
    container.insertAdjacentHTML('beforebegin', `
      <div class="ingr-col-labels" id="ingr-col-labels">
        <div class="ingr-col-label">Ingredient</div>
        <div class="ingr-col-label">Qty</div>
        <div class="ingr-col-label">Unit</div>
        <div class="ingr-col-label"></div>
      </div>`);
  }
  const id = ++ingredientRowCount;
  const row = document.createElement('div');
  row.className = 'ingr-row'; row.id = `ingr-row-${id}`;
  row.innerHTML = `
    <input type="text" class="form-input ingr-name" placeholder="e.g. Garlic" autocomplete="off">
    <input type="text" class="form-input ingr-qty" placeholder="2" autocomplete="off">
    <input type="text" class="form-input ingr-unit" placeholder="cloves" autocomplete="off">
    <button type="button" class="ingr-row-remove" onclick="removeIngredientRow(${id})" title="Remove">&times;</button>`;
  container.appendChild(row);
  row.querySelector('.ingr-name').focus();
}

function removeIngredientRow(id) {
  const row = document.getElementById(`ingr-row-${id}`);
  if (row) {
    row.style.opacity = '0'; row.style.transform = 'translateX(8px)'; row.style.transition = 'all 0.15s';
    setTimeout(() => {
      row.remove();
      if (!document.querySelectorAll('#ingredient-rows .ingr-row').length) {
        const l = document.getElementById('ingr-col-labels');
        if (l) l.remove();
        ingredientRowCount = 0;
      }
    }, 150);
  }
}

function saveNewRecipe() {
  const name = document.getElementById('new-name').value.trim();
  if (!name) { showToast('Please enter a recipe name'); return; }
  const cat     = document.getElementById('new-category').value.toLowerCase();
  const diff    = document.getElementById('new-diff').value.toLowerCase();
  const prep    = parseInt(document.getElementById('new-prep').value) || 15;
  const cook    = parseInt(document.getElementById('new-cook').value) || 30;
  const cuisine = document.getElementById('new-cuisine').value.trim() || 'Other';
  const notes   = document.getElementById('new-notes').value.trim();

  const ingredients = [];
  document.querySelectorAll('#ingredient-rows .ingr-row').forEach(row => {
    const n = row.querySelector('.ingr-name').value.trim();
    const q = row.querySelector('.ingr-qty').value.trim();
    const u = row.querySelector('.ingr-unit').value.trim();
    if (n) ingredients.push({ name: n, qty: [q, u].filter(Boolean).join(' ') || '' });
  });

  const newRecipe = { id: nextRecipeId++, name, category: cat, cuisine, diff, prep, cook, rating: 0, tags: [], daysAgo: 0, ingredients, notes };
  RECIPES.unshift(newRecipe);
  markUnsaved();
  closeModal('modal-add');
  filterRecipes();
  showToast('"' + name + '" added — ' + ingredients.length + ' ingredient' + (ingredients.length !== 1 ? 's' : ''));
}

// ── TOAST ─────────────────────────────────────────────────
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

// ── INIT ──────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  loadFromStorage();
  document.getElementById('week-label').textContent = getWeekLabel();
  document.getElementById('grocery-week-label').textContent = 'Week of ' + getWeekLabel();
  filterRecipes();
  renderPlan();
  renderCuisineBars();
  renderGrocery();

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
    if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveAll(); }
  });

  window.addEventListener('beforeunload', e => {
    if (hasUnsavedChanges) {
      e.preventDefault();
      e.returnValue = '';
    }
  });
});
</script>
</body>
</html>
