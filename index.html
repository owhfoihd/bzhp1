<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Travel Journal</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://accounts.google.com/gsi/client" async defer onload="onGsiLoad()"></script>
<script src="https://apis.google.com/js/api.js" async defer onload="onGapiLoad()"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
<style>
body { background:#6E8175; min-height:100vh; font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","Helvetica Neue",sans-serif; }
.photo-preview { width:80px; height:80px; object-fit:cover; border-radius:8px; cursor:pointer; }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.85); }
.modal.active { display:flex; align-items:center; justify-content:center; }
.modal img { max-width:90%; max-height:90%; }
.nav-btn { padding:8px 14px; border-radius:8px; font-weight:600; cursor:pointer; font-size:0.85rem; border:none; background:rgba(255,255,255,0.2); color:white; transition:all 0.2s; }
.nav-btn.active { background:white; color:#97AC9F; }
.nav-btn:hover:not(.active) { background:rgba(255,255,255,0.35); }
.star-btn { font-size:1.6rem; cursor:pointer; transition:opacity 0.1s; line-height:1; }
.sub-star { font-size:1.4rem; cursor:pointer; transition:opacity 0.1s; }
.zepeda-btn { padding:6px 14px; border:2px solid #97AC9F; border-radius:8px; background:white; cursor:pointer; font-weight:600; font-size:0.9rem; transition:all 0.2s; }
.zepeda-btn.active { background:#97AC9F; color:white; }
.section-header { cursor:pointer; user-select:none; }
.collapse-arrow { transition:transform 0.3s; display:inline-block; }
.collapse-arrow.collapsed { transform:rotate(-90deg); }
.tag-suggestions { position:absolute; background:white; border:1px solid #d1d5db; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1); max-height:180px; overflow-y:auto; z-index:100; display:none; width:100%; }
.tag-suggestions.active { display:block; }
.tag-suggestion-item { padding:8px 12px; cursor:pointer; border-bottom:1px solid #f3f4f6; font-size:0.9rem; }
.tag-suggestion-item:hover { background:#dde8e3; }
.sort-chip { display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:20px; font-size:0.75rem; font-weight:600; cursor:pointer; user-select:none; border:2px solid #97AC9F; color:#97AC9F; background:white; }
.sort-chip.active { background:#97AC9F; color:white; }
.sort-option { display:inline-flex; align-items:center; padding:4px 10px; border-radius:20px; font-size:0.75rem; font-weight:600; cursor:pointer; border:2px solid #d1d5db; color:#6b7280; background:white; }
.sort-option:hover { border-color:#97AC9F; color:#97AC9F; }
.filter-chip { display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:20px; font-size:0.75rem; font-weight:600; cursor:pointer; border:2px solid #d1d5db; color:#6b7280; background:white; }
.filter-chip:hover { border-color:#859EAC; color:#859EAC; }
.filter-chip.active { background:#859EAC; color:white; border-color:#859EAC; }
.detail-photo-header { width:100%; height:220px; object-fit:cover; display:block; }
.detail-photo-placeholder { width:100%; height:130px; background:linear-gradient(135deg,#6E8175,#859EAC); }
.detail-back-btn { position:absolute; top:12px; left:12px; background:rgba(0,0,0,0.45); color:white; border:none; border-radius:20px; padding:5px 14px; font-size:0.8rem; font-weight:600; cursor:pointer; }
.cal-cell { background:white; min-height:56px; padding:4px; display:flex; flex-direction:column; align-items:center; cursor:pointer; transition:background 0.15s; }
.cal-cell:hover { background:#f8faf6; }
.cal-cell.today .cal-day-num { background:#97AC9F; color:white; border-radius:50%; }
.cal-cell.selected { background:#f0f4ec !important; }
.cal-cell.other-month .cal-day-num { color:#d1d5db; }
.cal-day-num { font-size:0.8rem; font-weight:600; color:#374151; width:24px; height:24px; display:flex; align-items:center; justify-content:center; }
.cal-dot-row { display:flex; gap:2px; flex-wrap:wrap; justify-content:center; margin-top:2px; }
.cal-dot { width:6px; height:6px; border-radius:50%; background:#97AC9F; flex-shrink:0; }
.cal-dot.blue { background:#859EAC; }
.cal-range-mid  { background: rgba(151,172,159,0.22) !important; border-radius: 0 !important; }
.cal-range-start{ background: linear-gradient(90deg, transparent 20%, rgba(151,172,159,0.22) 20%) !important; border-radius: 50% 0 0 50% !important; }
.cal-range-end  { background: linear-gradient(90deg, rgba(151,172,159,0.22) 80%, transparent 80%) !important; border-radius: 0 50% 50% 0 !important; }
#successToast { position:fixed; bottom:28px; left:50%; transform:translateX(-50%) translateY(20px); background:#2d6a4f; color:white; padding:12px 24px; border-radius:999px; font-size:0.9rem; font-weight:600; box-shadow:0 4px 20px rgba(0,0,0,0.2); opacity:0; transition:opacity 0.3s,transform 0.3s; pointer-events:none; z-index:9998; }
#successToast.show { opacity:1; transform:translateX(-50%) translateY(0); }
@media print { .no-print { display:none !important; } }
input[type="range"] { -webkit-appearance:none; appearance:none; background:transparent; cursor:pointer; }
input[type="range"]::-webkit-slider-track { background:#e5e7eb; height:6px; border-radius:3px; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; background:#97AC9F; height:18px; width:18px; border-radius:50%; margin-top:-6px; }
#leafletMap { height:500px; width:100%; border-radius:0; z-index:1; }
.no-scrollbar::-webkit-scrollbar { display:none; }
.no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }
</style>
</head>
<body class="p-3">

<div class="max-w-3xl mx-auto">
<div class="bg-white rounded-xl shadow-2xl overflow-hidden">

  <!-- HEADER -->
  <div class="p-5 text-white no-print" style="background:linear-gradient(135deg,#6E8175,#859EAC);">
    <h1 class="text-2xl font-bold mb-1">My Travel Journal</h1>
    <p class="text-sm opacity-80 mb-3" id="placeCount">0 places visited</p>
    <div class="flex flex-wrap gap-2">
      <button onclick="setView('list')" id="navList" class="nav-btn active">List</button>
      <button onclick="setView('map')" id="navMap" class="nav-btn">Map</button>
      <button onclick="setView('calendar')" id="navCalendar" class="nav-btn">Calendar</button>
      <button onclick="setView('timeline')" id="navTimeline" class="nav-btn">Timeline</button>
      <button onclick="setView('stats')" id="navStats" class="nav-btn">Stats</button>
      <button onclick="setView('wishlist')" id="navWishlist" class="nav-btn">☆ Wishlist</button>
      <button onclick="showForm()" class="nav-btn" style="background:white;color:#859EAC;">+ Add Place</button>
      <button onclick="openSyncModal()" class="nav-btn" style="background:rgba(255,255,255,0.15);color:white;">⇅ Sync</button>
    </div>
  </div>

  <!-- FILTER BAR -->
  <div id="filterBar" class="p-4 bg-gray-50 border-b no-print">
    <div class="flex flex-col gap-2">
      <input type="text" id="searchInput" placeholder="Search places..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" autocomplete="off"/>
      <div class="flex gap-2">
        <button onclick="toggleFilterPanel()" id="filterToggleBtn" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white text-gray-700 font-medium">Filter ▾</button>
        <button onclick="toggleSortPanel()" id="sortToggleBtn" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white text-gray-700 font-medium">Sort ▾</button>
      </div>
      <div id="activeFilterDisplay" class="hidden flex-wrap gap-1" style="display:none;"></div>
      <div id="activeSortDisplay" class="hidden flex-wrap gap-1" style="display:none;"></div>

      <div id="filterPanel" class="hidden border border-gray-200 rounded-lg bg-white p-3 space-y-3">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Filter by Trip</div>
        <div id="filterTripOptions" class="flex flex-wrap gap-2"></div>
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Filter by Year</div>
        <div id="filterYearOptions" class="flex flex-wrap gap-2"></div>
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Filter by Rating</div>
        <div class="flex flex-wrap gap-2">
          <span class="filter-chip" data-type="rating" data-value="5" onclick="toggleFilterChip(this)">★★★★★ 5</span>
          <span class="filter-chip" data-type="rating" data-value="4.5" onclick="toggleFilterChip(this)">4.5+</span>
          <span class="filter-chip" data-type="rating" data-value="4" onclick="toggleFilterChip(this)">4+</span>
          <span class="filter-chip" data-type="rating" data-value="3" onclick="toggleFilterChip(this)">3+</span>
        </div>
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Filter by Type</div>
        <div id="filterTagOptions" class="flex flex-wrap gap-2"></div>
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Filter by Visited With</div>
        <div id="filterPeopleOptions" class="flex flex-wrap gap-2"></div>
        <button onclick="clearAllFilters()" class="text-xs text-red-400 hover:text-red-600">Clear all filters</button>
      </div>

      <div id="sortPanel" class="hidden border border-gray-200 rounded-lg bg-white p-3">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Active sorts</div>
        <div id="sortChips" class="flex flex-wrap gap-2 mb-3"></div>
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Add sort</div>
        <div id="sortOptions" class="flex flex-wrap gap-2"></div>
      </div>
    </div>
  </div>

  <!-- ADD/EDIT FORM -->
  <form id="placeForm" class="p-4 bg-gray-50 border-b hidden">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-gray-800" id="formTitle">Add New Place</h2>
    </div>
    <div id="wishlistToggleRow" class="flex items-center gap-2 pb-3 mb-1 border-b border-gray-100">
      <input type="checkbox" id="isWishlistCheck" style="width:16px;height:16px;accent-color:#97AC9F;" onchange="updateFormForWishlist()">
      <label for="isWishlistCheck" class="text-sm font-semibold text-gray-600 cursor-pointer">Add to Wishlist <span class="font-normal text-gray-400">(haven't visited yet)</span></label>
    </div>
    <div id="desireWeightRow" style="display:none;" class="pb-3 mb-1 border-b border-gray-100">
      <label class="block text-xs font-semibold mb-1 uppercase tracking-wide" style="color:#E6C8C6;">Desire Weight: <span id="desireWeightValue">3</span>/5</label>
      <div class="flex gap-1" id="desireStars">
        <span class="star-btn" onclick="setDesireWeight(1)" style="color:#E6C8C6;">★</span>
        <span class="star-btn" onclick="setDesireWeight(2)" style="color:#E6C8C6;">★</span>
        <span class="star-btn" onclick="setDesireWeight(3)" style="color:#E6C8C6;">★</span>
        <span class="star-btn" onclick="setDesireWeight(4)" style="color:#E6C8C6;">★</span>
        <span class="star-btn" onclick="setDesireWeight(5)" style="color:#E6C8C6;">★</span>
      </div>
      <input type="hidden" id="desireWeight" value="3">
    </div>
    <div class="space-y-3">

      <div>
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Place Name *</label>
        <input type="text" id="placeName" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="e.g., Eiffel Tower"/>
      </div>

      <div class="grid grid-cols-3 gap-2">
        <div class="relative">
          <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">City *</label>
          <input type="text" id="placeCity" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Paris" autocomplete="off"/>
          <div id="citySuggestions" class="tag-suggestions"></div>
        </div>
        <div class="relative">
          <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">State</label>
          <input type="text" id="placeState" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="CA" autocomplete="off"/>
          <div id="stateSuggestions" class="tag-suggestions"></div>
        </div>
        <div class="relative">
          <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Country *</label>
          <input type="text" id="placeCountry" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="France" autocomplete="off"/>
          <div id="countrySuggestions" class="tag-suggestions"></div>
        </div>
      </div>

      <div class="relative">
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Trip Group (optional)</label>
        <input type="text" id="placeTrip" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="e.g., Europe 2024" autocomplete="off"/>
        <div id="tripSuggestions" class="tag-suggestions"></div>
      </div>

      <div>
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Maps Link (optional)</label>
        <input type="text" id="placeMapLink" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Paste Google or Apple Maps link..." oninput="previewMapCoords(this.value)"/>
        <div id="mapCoordsPreview" class="text-xs mt-1" style="display:none;"></div>
      </div>

      <div>
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Visit Dates (optional)</label>
        <div id="datesContainer" class="space-y-2"></div>
        <button type="button" onclick="addDateField()" class="mt-2 text-sm px-3 py-1 border rounded-lg" style="border-color:#97AC9F;color:#97AC9F;">+ Add Date</button>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <div class="flex items-center justify-between mb-1">
            <label class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Hunter: <span id="hunterRatingValue">5</span>/5</label>
            <button type="button" id="hunterNaBtn" onclick="toggleNA('hunter')" class="text-xs px-1.5 py-0.5 rounded font-semibold border" style="border-color:#d1d5db;color:#9ca3af;">N/A</button>
          </div>
          <div class="flex gap-1" id="hunterStars">
            <span class="star-btn" onclick="setRating('hunter',1)" style="color:#97AC9F;">★</span>
            <span class="star-btn" onclick="setRating('hunter',2)" style="color:#97AC9F;">★</span>
            <span class="star-btn" onclick="setRating('hunter',3)" style="color:#97AC9F;">★</span>
            <span class="star-btn" onclick="setRating('hunter',4)" style="color:#97AC9F;">★</span>
            <span class="star-btn" onclick="setRating('hunter',5)" style="color:#97AC9F;">★</span>
          </div>
          <input type="hidden" id="hunterRating" value="5">
          <input type="hidden" id="hunterNA" value="0">
        </div>
        <div>
          <div class="flex items-center justify-between mb-1">
            <label class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Brandon: <span id="brandonRatingValue">5</span>/5</label>
            <button type="button" id="brandonNaBtn" onclick="toggleNA('brandon')" class="text-xs px-1.5 py-0.5 rounded font-semibold border" style="border-color:#d1d5db;color:#9ca3af;">N/A</button>
          </div>
          <div class="flex gap-1" id="brandonStars">
            <span class="star-btn" onclick="setRating('brandon',1)" style="color:#859EAC;">★</span>
            <span class="star-btn" onclick="setRating('brandon',2)" style="color:#859EAC;">★</span>
            <span class="star-btn" onclick="setRating('brandon',3)" style="color:#859EAC;">★</span>
            <span class="star-btn" onclick="setRating('brandon',4)" style="color:#859EAC;">★</span>
            <span class="star-btn" onclick="setRating('brandon',5)" style="color:#859EAC;">★</span>
          </div>
          <input type="hidden" id="brandonRating" value="5">
          <input type="hidden" id="brandonNA" value="0">
        </div>
      </div>

      <div>
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Zepeda Stars (optional)</label>
        <div class="flex gap-2">
          <button type="button" class="zepeda-btn" data-value="1" onclick="selectZepeda(1)">!</button>
          <button type="button" class="zepeda-btn" data-value="2" onclick="selectZepeda(2)">!!</button>
          <button type="button" class="zepeda-btn" data-value="3" onclick="selectZepeda(3)">!!!</button>
        </div>
        <input type="hidden" id="placeZepeda" value="0">
      </div>

      <div>
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Memory Weight: <span id="enjoymentRatingValue">5</span>/5</label>
        <div class="flex gap-1" id="enjoymentStars">
          <span class="star-btn" onclick="setRating('enjoyment',1)" style="color:#E6C8C6;">★</span>
          <span class="star-btn" onclick="setRating('enjoyment',2)" style="color:#E6C8C6;">★</span>
          <span class="star-btn" onclick="setRating('enjoyment',3)" style="color:#E6C8C6;">★</span>
          <span class="star-btn" onclick="setRating('enjoyment',4)" style="color:#E6C8C6;">★</span>
          <span class="star-btn" onclick="setRating('enjoyment',5)" style="color:#E6C8C6;">★</span>
        </div>
        <input type="hidden" id="enjoymentRating" value="5">
      </div>

      <div class="grid grid-cols-2 gap-2">
        <div class="relative">
          <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Type of Place</label>
          <input type="text" id="placeTypeTags" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="restaurant, museum..." autocomplete="off"/>
          <div id="typeTagSuggestions" class="tag-suggestions"></div>
        </div>
        <div class="relative">
          <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Visited With</label>
          <input type="text" id="placePeopleTags" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="family, friends..." autocomplete="off"/>
          <div id="peopleTagSuggestions" class="tag-suggestions"></div>
        </div>
      </div>

      <div class="relative">
        <label class="block text-xs font-semibold mb-1 uppercase tracking-wide" style="color:#6E8175;">Detailed Place <span class="font-normal normal-case text-gray-400">(specific descriptors)</span></label>
        <input type="text" id="placeDetailTags" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="rooftop bar, hidden gem, local favorite..." autocomplete="off"/>
        <div id="detailTagSuggestions" class="tag-suggestions"></div>
      </div>

      <div>
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Photos</label>
        <input type="file" id="placePhotos" accept="image/*" multiple class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"/>
        <div id="photoPreviewContainer" class="mt-2 flex flex-wrap gap-2"></div>
      </div>

      <div class="flex gap-4 py-1">
        <label class="flex items-center gap-2 cursor-pointer text-sm text-gray-700">
          <input type="checkbox" id="wouldRevisit" style="width:15px;height:15px;accent-color:#97AC9F;">
          <span>Would Revisit?</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer text-sm text-gray-700">
          <input type="checkbox" id="firstTimeVisit" style="width:15px;height:15px;accent-color:#97AC9F;" checked>
          <span>First Time?</span>
        </label>
      </div>

      <div>
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Notes</label>
        <div id="notesThread" class="border border-gray-200 rounded-xl bg-white mb-2 min-h-16 max-h-48 overflow-y-auto p-2 space-y-1"></div>
        <div class="flex gap-2">
          <input type="text" id="noteInput" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Add a note..."/>
          <button type="button" onclick="addNote()" class="px-3 py-2 text-white rounded-lg text-sm font-semibold" style="background:#97AC9F;">Post</button>
        </div>
        <input type="hidden" id="placeNotes" value="[]">
      </div>
    </div>

    <div class="flex gap-2 mt-4">
      <button type="submit" class="flex-1 text-white py-3 rounded-lg font-semibold text-sm" style="background:#97AC9F;">Save Place</button>
      <button type="button" onclick="cancelForm()" class="px-5 py-3 border border-gray-300 text-gray-600 rounded-lg text-sm font-semibold">Cancel</button>
    </div>
  </form>

  <!-- ADD VISIT MODAL -->
  <div id="addVisitModal" style="display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.45);align-items:flex-end;justify-content:center;" onclick="if(event.target===this)closeAddVisitModal()">
    <div style="background:white;border-radius:20px 20px 0 0;width:100%;max-width:480px;padding:24px;padding-bottom:36px;max-height:85vh;overflow-y:auto;">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800">Add Visit</h3>
        <button onclick="closeAddVisitModal()" style="background:none;border:none;font-size:1.4rem;color:#9ca3af;cursor:pointer;">✕</button>
      </div>
      <!-- Date range -->
      <div class="mb-3">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Visit Dates</label>
        <div class="flex gap-2 items-center">
          <input type="date" id="av_startDate" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"/>
          <span class="text-xs text-gray-400">→</span>
          <input type="date" id="av_endDate" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="optional"/>
        </div>
      </div>
      <!-- Type of Place -->
      <div class="mb-3 relative">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Type of Place</label>
        <input type="text" id="av_typeTags" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="restaurant, museum..." autocomplete="off"/>
        <div id="av_typeSuggestions" class="tag-suggestions"></div>
      </div>
      <!-- Detailed Place -->
      <div class="mb-3 relative">
        <label class="block text-xs font-semibold uppercase tracking-wide mb-1" style="color:#6E8175;">Detailed Place</label>
        <input type="text" id="av_detailTags" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="rooftop bar, hidden gem..." autocomplete="off"/>
        <div id="av_detailSuggestions" class="tag-suggestions"></div>
        <div id="av_detailChips" class="flex flex-wrap gap-1 mt-1.5" style="display:none;"></div>
      </div>
      <!-- Visited With -->
      <div class="mb-3 relative">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Visited With</label>
        <input type="text" id="av_peopleTags" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="family, friends..." autocomplete="off"/>
        <div id="av_peopleSuggestions" class="tag-suggestions"></div>
      </div>
      <!-- Ratings -->
      <div class="grid grid-cols-2 gap-3 mb-3">
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Hunter: <span id="av_hunterVal">5</span>/5</label>
          <div class="flex gap-1" id="av_hunterStars">
            <span onclick="avSetRating('hunter',1)" style="font-size:1.3rem;cursor:pointer;color:#97AC9F;">★</span>
            <span onclick="avSetRating('hunter',2)" style="font-size:1.3rem;cursor:pointer;color:#97AC9F;">★</span>
            <span onclick="avSetRating('hunter',3)" style="font-size:1.3rem;cursor:pointer;color:#97AC9F;">★</span>
            <span onclick="avSetRating('hunter',4)" style="font-size:1.3rem;cursor:pointer;color:#97AC9F;">★</span>
            <span onclick="avSetRating('hunter',5)" style="font-size:1.3rem;cursor:pointer;color:#97AC9F;">★</span>
          </div>
          <input type="hidden" id="av_hunterRating" value="5"/>
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Brandon: <span id="av_brandonVal">5</span>/5</label>
          <div class="flex gap-1" id="av_brandonStars">
            <span onclick="avSetRating('brandon',1)" style="font-size:1.3rem;cursor:pointer;color:#859EAC;">★</span>
            <span onclick="avSetRating('brandon',2)" style="font-size:1.3rem;cursor:pointer;color:#859EAC;">★</span>
            <span onclick="avSetRating('brandon',3)" style="font-size:1.3rem;cursor:pointer;color:#859EAC;">★</span>
            <span onclick="avSetRating('brandon',4)" style="font-size:1.3rem;cursor:pointer;color:#859EAC;">★</span>
            <span onclick="avSetRating('brandon',5)" style="font-size:1.3rem;cursor:pointer;color:#859EAC;">★</span>
          </div>
          <input type="hidden" id="av_brandonRating" value="5"/>
        </div>
      </div>
      <button onclick="saveAddVisit()" class="w-full py-3 rounded-xl font-bold text-white text-sm" style="background:#97AC9F;">Save Visit</button>
    </div>
  </div>

  <!-- LIST VIEW -->
  <div id="listView">
    <div class="px-4 pt-3 pb-2 bg-white border-b sticky top-0 z-10 no-print">
      <div class="relative">
        <input type="text" id="listSearchInput" placeholder="Search places, cities, trips..." class="w-full pl-8 pr-8 py-2 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:bg-white focus:border-gray-400 outline-none" autocomplete="off" oninput="onListSearch(this.value)"/>
        <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#9ca3af;font-size:0.85rem;pointer-events:none;">&#128269;</span>
        <button id="listSearchClear" onclick="clearListSearch()" style="display:none;position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:#9ca3af;font-size:1.1rem;cursor:pointer;padding:0;line-height:1;">&#215;</button>
      </div>
    </div>
    <div id="placesList" class="p-4"></div>
  </div>

  <!-- MAP VIEW -->
  <div id="mapView" class="hidden">
    <!-- Map mode toggle -->
    <div class="flex gap-2 p-3 pb-0" style="background:#f9fafb;border-bottom:1px solid #e5e7eb;">
      <button onclick="setMapMode('pins')" id="mapBtnPins" class="px-3 py-1.5 rounded-lg text-xs font-semibold border transition-all" style="background:#97AC9F;color:white;border-color:#97AC9F;">Pins</button>
      <button onclick="setMapMode('heat')" id="mapBtnHeat" class="px-3 py-1.5 rounded-lg text-xs font-semibold border transition-all" style="background:white;color:#6b7280;border-color:#d1d5db;">Heatmap</button>
      <button onclick="setMapMode('choropleth')" id="mapBtnChoropleth" class="px-3 py-1.5 rounded-lg text-xs font-semibold border transition-all" style="background:white;color:#6b7280;border-color:#d1d5db;">Visited</button>
    </div>
    <div id="leafletMap"></div>
    <div id="mapNoPlaces" class="p-4 text-center text-gray-400 hidden"><p class="font-medium">No places with location data yet</p><p class="text-sm mt-1">Add places with city/country to see them on the map</p></div>
  </div>

  <!-- STATS VIEW -->
  <div id="statsView" class="p-4 hidden">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-gray-800">Statistics</h2>
      <button onclick="exportPDF()" class="px-4 py-2 text-white rounded-lg text-sm font-semibold" style="background:#859EAC;">Export PDF</button>
    </div>
    <div id="statsContent"></div>
  </div>

  <!-- CALENDAR VIEW -->
  <div id="calendarView" class="p-4 hidden">
    <div class="flex items-center justify-between mb-4">
      <button onclick="calPrev()" class="w-9 h-9 rounded-full flex items-center justify-center text-xl font-bold hover:bg-gray-100" style="color:#97AC9F;border:none;background:none;cursor:pointer;">‹</button>
      <div class="text-center">
        <div class="font-bold text-gray-800 text-lg" id="calMonthLabel"></div>
        <div class="text-xs text-gray-400" id="calYearLabel"></div>
      </div>
      <button onclick="calNext()" class="w-9 h-9 rounded-full flex items-center justify-center text-xl font-bold hover:bg-gray-100" style="color:#97AC9F;border:none;background:none;cursor:pointer;">›</button>
    </div>
    <div class="grid grid-cols-7 mb-1">
      <div class="text-center text-xs font-semibold text-gray-400 py-1">Sun</div>
      <div class="text-center text-xs font-semibold text-gray-400 py-1">Mon</div>
      <div class="text-center text-xs font-semibold text-gray-400 py-1">Tue</div>
      <div class="text-center text-xs font-semibold text-gray-400 py-1">Wed</div>
      <div class="text-center text-xs font-semibold text-gray-400 py-1">Thu</div>
      <div class="text-center text-xs font-semibold text-gray-400 py-1">Fri</div>
      <div class="text-center text-xs font-semibold text-gray-400 py-1">Sat</div>
    </div>
    <div id="calGrid" class="grid grid-cols-7 gap-px bg-gray-200 rounded-xl overflow-hidden border border-gray-200"></div>
    <div id="calDayDetail" class="mt-4 space-y-2"></div>
  </div>

  <!-- WISHLIST VIEW -->
  <div id="wishlistView" class="p-4 hidden">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h2 class="text-xl font-bold text-gray-800">Wishlist</h2>
        <div class="text-sm text-gray-400 mt-0.5" id="wishlistCount"></div>
      </div>
      <button onclick="showForm(true)" class="px-4 py-2 text-white rounded-lg text-sm font-semibold" style="background:#97AC9F;">+ Add to Wishlist</button>
    </div>
    <div id="wishlistContent"></div>
  </div>

  <!-- TIMELINE VIEW -->
  <div id="timelineView" class="hidden">
    <!-- On This Day banner -->
    <div id="onThisDayBanner" class="p-4 border-b" style="background:linear-gradient(135deg,#f0f4ec,#dce8f0);"></div>
    <!-- Timeline scroll area -->
    <div id="timelineContent" class="p-4 space-y-0"></div>
  </div>

  <!-- DETAIL VIEW -->
  <div id="detailView" class="hidden overflow-hidden">
    <div class="relative" id="detailHeaderWrap"></div>
    <div class="p-4 space-y-4" id="detailBody"></div>
    <div class="p-4 pt-0 flex gap-2">
      <button onclick="detailEdit()" class="flex-1 py-3 rounded-lg font-semibold text-sm text-white" style="background:#97AC9F;">Edit</button>
      <button onclick="detailAddVisit()" class="flex-1 py-3 rounded-lg font-semibold text-sm text-white" style="background:#859EAC;">+ Add Visit</button>
      <button onclick="detailDelete()" class="px-4 py-3 rounded-lg font-semibold text-sm text-white" style="background:#e57373;">Delete</button>
    </div>
  </div>

  <!-- GROUP DETAIL VIEW (city / state / country / trip) -->
  <div id="groupDetailView" class="hidden">
    <div class="relative" id="groupDetailHeaderWrap">
      <div id="groupDetailHeader" class="w-full flex items-end px-5 pb-4" style="min-height:110px;background:linear-gradient(135deg,#6E8175,#859EAC);">
        <div class="flex-1">
          <div class="text-xs font-semibold uppercase tracking-wider mb-1" id="groupDetailType" style="color:rgba(45,55,72,0.6);"></div>
          <div class="text-xs mt-0.5" id="tripDateRange" style="display:none;color:rgba(45,55,72,0.5);"></div>
          <div class="text-2xl font-bold" id="groupDetailTitle" style="color:#2d3748;"></div>
          <div class="text-sm mt-0.5" id="groupDetailSub" style="color:#4a5568;"></div>
        </div>
        <button id="groupDetailEditBtn" onclick="openTripEdit()" style="display:none;background:rgba(0,0,0,0.1);border:none;color:#2d3748;border-radius:10px;padding:6px 12px;font-size:0.78rem;font-weight:600;cursor:pointer;">&#9998; Edit</button>
      </div>
      <button id="groupDetailBack" class="detail-back-btn">&#8592; Back</button>
    </div>
    <!-- Trip edit panel (hidden by default) -->
    <div id="tripEditPanel" style="display:none;" class="p-4 bg-gray-50 border-b space-y-3">
      <div class="text-sm font-semibold text-gray-700 mb-2">Trip Settings</div>
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Header Photo</label>
        <input type="file" id="tripPhotoInput" accept="image/*" class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2" onchange="handleTripPhoto(this)"/>
        <button onclick="clearTripPhoto()" class="mt-1 text-xs text-red-400 hover:text-red-600">Remove photo</button>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Trip Start Date</label>
          <input type="date" id="tripStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"/>
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Trip End Date</label>
          <input type="date" id="tripEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"/>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Hunter's Overall: <span id="tripHunterVal">—</span></label>
          <div class="flex gap-1" id="tripHunterStars">
            <span class="star-btn" data-who="hunter" data-n="1" onclick="setTripRating(this)" style="color:#97AC9F;">★</span>
            <span class="star-btn" data-who="hunter" data-n="2" onclick="setTripRating(this)" style="color:#97AC9F;">★</span>
            <span class="star-btn" data-who="hunter" data-n="3" onclick="setTripRating(this)" style="color:#97AC9F;">★</span>
            <span class="star-btn" data-who="hunter" data-n="4" onclick="setTripRating(this)" style="color:#97AC9F;">★</span>
            <span class="star-btn" data-who="hunter" data-n="5" onclick="setTripRating(this)" style="color:#97AC9F;">★</span>
          </div>
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Brandon's Overall: <span id="tripBrandonVal">—</span></label>
          <div class="flex gap-1" id="tripBrandonStars">
            <span class="star-btn" data-who="brandon" data-n="1" onclick="setTripRating(this)" style="color:#859EAC;">★</span>
            <span class="star-btn" data-who="brandon" data-n="2" onclick="setTripRating(this)" style="color:#859EAC;">★</span>
            <span class="star-btn" data-who="brandon" data-n="3" onclick="setTripRating(this)" style="color:#859EAC;">★</span>
            <span class="star-btn" data-who="brandon" data-n="4" onclick="setTripRating(this)" style="color:#859EAC;">★</span>
            <span class="star-btn" data-who="brandon" data-n="5" onclick="setTripRating(this)" style="color:#859EAC;">★</span>
          </div>
        </div>
      </div>
      <div class="flex gap-2">
        <button onclick="saveTripEdit()" class="flex-1 py-2 text-white rounded-lg text-sm font-semibold" style="background:#97AC9F;">Save</button>
        <button onclick="document.getElementById('tripEditPanel').style.display='none'" class="px-4 py-2 border border-gray-300 text-gray-600 rounded-lg text-sm">Cancel</button>
      </div>
    </div>
    <div class="p-4 space-y-3" id="groupDetailStats"></div>
    <div class="px-4 pb-2 text-xs font-semibold text-gray-400 uppercase tracking-wide" id="groupDetailPlacesLabel"></div>
    <div class="px-4 pb-4 space-y-2" id="groupDetailPlaces"></div>
  </div>

  <!-- AUTHOR PICKER MODAL -->
  <div id="authorModal" style="display:none;position:fixed;inset:0;z-index:3500;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;">
    <div style="background:white;border-radius:20px;padding:24px;width:80%;max-width:300px;text-align:center;box-shadow:0 20px 50px rgba(0,0,0,0.25);">
      <div style="font-size:1rem;font-weight:700;color:#2d3748;margin-bottom:6px;">Who's posting?</div>
      <div style="font-size:0.8rem;color:#888;margin-bottom:18px;">Select who this note is from</div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <button onclick="pickAuthor('Hunter')" style="padding:12px;background:#97AC9F;color:white;border:none;border-radius:12px;font-weight:700;font-size:0.95rem;cursor:pointer;">Hunter</button>
        <button onclick="pickAuthor('Brandon')" style="padding:12px;background:#859EAC;color:white;border:none;border-radius:12px;font-weight:700;font-size:0.95rem;cursor:pointer;">Brandon</button>
        <button onclick="pickAuthor('Other')" style="padding:12px;background:#e5e7eb;color:#555;border:none;border-radius:12px;font-weight:700;font-size:0.95rem;cursor:pointer;">Other</button>
        <button onclick="document.getElementById('authorModal').style.display='none'" style="padding:8px;background:none;color:#aaa;border:none;font-size:0.85rem;cursor:pointer;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- CONFIRM MODAL -->
  <div id="confirmModal" style="display:none;position:fixed;inset:0;z-index:3000;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;">
    <div style="background:white;border-radius:18px;padding:28px 24px;width:88%;max-width:360px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <div style="font-size:1.05rem;font-weight:700;color:#1a202c;margin-bottom:8px;" id="confirmTitle">Confirm</div>
      <div style="font-size:0.9rem;color:#555;margin-bottom:22px;line-height:1.5;" id="confirmMsg"></div>
      <div style="display:flex;gap:10px;">
        <button id="confirmCancelBtn" style="flex:1;padding:11px;border:1.5px solid #d1d5db;background:white;border-radius:10px;font-weight:600;font-size:0.9rem;cursor:pointer;color:#555;">Cancel</button>
        <button id="confirmOkBtn" style="flex:1;padding:11px;border:none;border-radius:10px;font-weight:600;font-size:0.9rem;cursor:pointer;color:white;background:#e57373;">Delete</button>
      </div>
    </div>
  </div>

  <!-- SYNC MODAL -->
  <div id="syncModal" style="display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;" onclick="if(event.target===this)closeSyncModal()">
    <div style="background:white;border-radius:20px;padding:0;width:92%;max-width:400px;max-height:88vh;overflow:hidden;display:flex;flex-direction:column;">

      <!-- Header -->
      <div style="padding:20px 22px 16px;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-size:1.05rem;font-weight:700;color:#1a202c;">Google Drive Sync</div>
          <div style="font-size:0.75rem;color:#888;margin-top:1px;">Your journal, saved to your Drive</div>
        </div>
        <span onclick="closeSyncModal()" style="cursor:pointer;font-size:1.5rem;color:#ccc;line-height:1;">×</span>
      </div>

      <!-- Not signed in -->
      <div id="syncSignedOut" style="padding:24px 22px;text-align:center;">
        <div style="font-size:2.5rem;margin-bottom:10px;">☁️</div>
        <div style="font-size:0.9rem;font-weight:600;color:#2d3748;margin-bottom:6px;">Sync across devices</div>
        <div style="font-size:0.82rem;color:#718096;margin-bottom:20px;line-height:1.5;">Sign in with Google to save your journal to Google Drive and access it from any device.</div>
        <button onclick="gdSignIn()" id="gdSignInBtn" style="width:100%;padding:12px;background:#4285F4;color:white;border:none;border-radius:12px;font-weight:600;font-size:0.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;">
          <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#fff" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 002.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#fff" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2.04a4.8 4.8 0 01-7.18-2.54H1.83v2.07A8 8 0 008.98 17z"/><path fill="#fff" d="M4.5 10.48A4.8 4.8 0 014.5 9a4.8 4.8 0 01.25-1.48V5.45H1.83a8 8 0 000 7.1l2.67-2.07z"/><path fill="#fff" d="M8.98 3.58c1.32 0 2.5.45 3.44 1.35l2.54-2.54A8 8 0 001.83 5.45L4.5 7.52a4.77 4.77 0 014.48-3.94z"/></svg>
          Sign in with Google
        </button>
        <div id="gdClientIdWarning" style="display:none;margin-top:12px;padding:10px;background:#fff3cd;border-radius:8px;font-size:0.75rem;color:#856404;text-align:left;">
          ⚠️ <strong>Setup required:</strong> Open the HTML file, find <code>YOUR_GOOGLE_CLIENT_ID</code> near the top of the &lt;script&gt; and replace it with your OAuth Client ID from <a href="https://console.cloud.google.com" target="_blank" style="color:#4285F4;">Google Cloud Console</a>.
        </div>
      </div>

      <!-- Signed in -->
      <div id="syncSignedIn" style="display:none;padding:20px 22px;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;padding:12px;background:#f8f9fa;border-radius:12px;">
          <img id="gdUserAvatar" src="" style="width:38px;height:38px;border-radius:50%;display:none;" />
          <div style="flex:1;min-width:0;">
            <div id="gdUserName" style="font-size:0.88rem;font-weight:600;color:#2d3748;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
            <div id="gdUserEmail" style="font-size:0.75rem;color:#718096;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
          </div>
          <button onclick="gdSignOut()" style="padding:5px 10px;border:1.5px solid #e2e8f0;background:white;border-radius:8px;font-size:0.75rem;color:#718096;cursor:pointer;white-space:nowrap;">Sign out</button>
        </div>

        <div style="display:flex;flex-direction:column;gap:10px;">
          <button onclick="gdSaveToCloud()" id="gdSaveBtn" style="width:100%;padding:12px;background:#97AC9F;color:white;border:none;border-radius:12px;font-weight:600;font-size:0.88rem;cursor:pointer;">
            ☁️ Save to Google Drive
          </button>
          <button onclick="gdLoadFromCloud()" id="gdLoadBtn" style="width:100%;padding:12px;background:#859EAC;color:white;border:none;border-radius:12px;font-weight:600;font-size:0.88rem;cursor:pointer;">
            ↓ Load from Google Drive
          </button>
        </div>

        <div id="gdSyncStatus" style="margin-top:12px;text-align:center;font-size:0.8rem;font-weight:600;min-height:20px;"></div>
        <div id="gdLastSync" style="text-align:center;font-size:0.72rem;color:#aaa;margin-top:4px;"></div>
      </div>

    </div>
  </div>

  <!-- PHOTO MODAL -->
  <div id="photoModal" class="modal">
    <span onclick="document.getElementById('photoModal').classList.remove('active')" class="absolute top-4 right-6 text-white text-4xl cursor-pointer">&times;</span>
    <img id="modalImg" src="" alt="Photo">
  </div>

</div><!-- bg-white -->
</div><!-- max-w-3xl -->

<div class="text-center mt-4 text-white text-xs opacity-70 pb-2 no-print">Data saved locally in your browser</div>
<div id="pdfContent" style="display:none;"></div>
<div id="successToast"></div>

<script>
// ================================================================
// STATE
// ================================================================
let places = [];
let editingId = null;
let currentPhotos = [];
let subRatingCounter = 0;
let subRatingClicks = {};
let currentRating = 5;
let currentView = 'list';
let activeSorts = [];
let activeFilters = [];
let calYear = new Date().getFullYear();
let calMonth = new Date().getMonth();
let calSelectedDay = null;
let detailPlaceId = null;

let allTypeTags = new Set(), allPeopleTags = new Set(), allDetailTags = new Set();
var typeToDetailMap = {};
let allCities = new Set(), allStates = new Set(), allCountries = new Set(), allTrips = new Set();

// ================================================================
// INIT
// ================================================================
document.addEventListener('DOMContentLoaded', function() {
  loadPlaces();
  backfillCoordsFromLinks();
  // Silently geocode all places then fetch elevations for any missing
  setTimeout(function() {
    geocodeAndFetchElevations(places.filter(function(p){ return !p.isWishlist; }));
  }, 2000);
  document.getElementById('placeForm').addEventListener('submit', handleSubmit);
  setupAutocomplete('placeCity', 'citySuggestions', allCities);
  setupAutocomplete('placeState', 'stateSuggestions', allStates);
  setupAutocomplete('placeCountry', 'countrySuggestions', allCountries);
  setupAutocomplete('placeTrip', 'tripSuggestions', allTrips);
  setupTagAutocomplete('placeTypeTags', 'typeTagSuggestions', allTypeTags);
  setupTagAutocomplete('placeDetailTags', 'detailTagSuggestions', allDetailTags);
  setupTagAutocomplete('placePeopleTags', 'peopleTagSuggestions', allPeopleTags);
  document.getElementById("placeTypeTags").addEventListener("input", updateDetailChips);
  document.getElementById("placeDetailTags").addEventListener("input", updateDetailChips);
  document.getElementById('placePhotos').addEventListener('change', handlePhotoUpload);
  document.getElementById('noteInput').addEventListener('keydown', function(e){ if(e.key==='Enter'){e.preventDefault();addNote();} });
  document.getElementById('searchInput').addEventListener('input', function(e) {
    var li = document.getElementById('listSearchInput');
    if (li) li.value = e.target.value;
    renderCurrentView();
  });
  renderCurrentView();
});

// ================================================================
// STORAGE
// ================================================================
// ── Get trips array from a place (supports legacy single-string p.trip) ──
function getTrips(p) {
  if (p.trips && Array.isArray(p.trips) && p.trips.length) return p.trips;
  if (p.trip) return p.trip.split(',').map(function(t){ return t.trim(); }).filter(Boolean);
  return [];
}

// ── Extract lat/lng from Google Maps or Apple Maps URL ──
function extractCoordsFromMapLink(url) {
  if (!url) return null;
  var m;
  // Google Maps @lat,lng
  m = url.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
  if (m) return [parseFloat(m[1]), parseFloat(m[2])];
  // Google/Apple Maps ?q=lat,lng
  m = url.match(/[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
  if (m) return [parseFloat(m[1]), parseFloat(m[2])];
  // ll=lat,lng (Apple Maps)
  m = url.match(/ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
  if (m) return [parseFloat(m[1]), parseFloat(m[2])];
  // Plain "lat,lng" string
  m = url.match(/^(-?\d+\.?\d*),\s*(-?\d+\.?\d*)$/);
  if (m) return [parseFloat(m[1]), parseFloat(m[2])];
  return null;
}

function previewMapCoords(val) {
  var preview = document.getElementById('mapCoordsPreview');
  if (!preview) return;
  var coords = extractCoordsFromMapLink(val.trim());
  if (coords) {
    preview.textContent = '\u{1F4CD} Coords found — looking up location…';
    preview.style.color = '#97AC9F';
    preview.style.display = 'block';

    // Reverse geocode to auto-fill city/state/country
    fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + coords[0] + '&lon=' + coords[1] + '&zoom=10&addressdetails=1')
      .then(function(r){ return r.json(); })
      .then(function(data) {
        if (data && data.address) {
          var addr = data.address;
          var city = addr.city || addr.town || addr.village || addr.hamlet || addr.municipality || addr.suburb || '';
          var state = addr.state || '';
          var country = addr.country || '';

          // Only fill if field is currently empty or user hasn't manually typed
          var cityEl = document.getElementById('placeCity');
          var stateEl = document.getElementById('placeState');
          var countryEl = document.getElementById('placeCountry');
          if (cityEl && !cityEl.value.trim()) cityEl.value = city;
          if (stateEl && !stateEl.value.trim()) stateEl.value = state;
          if (countryEl && !countryEl.value.trim()) countryEl.value = country;

          // Also fetch elevation and update preview
          return fetch('https://api.open-meteo.com/v1/elevation?latitude=' + coords[0] + '&longitude=' + coords[1])
            .then(function(r2){ return r2.json(); })
            .then(function(d2) {
              var parts = [];
              if (city) parts.push(city);
              if (country) parts.push(country);
              if (d2 && d2.elevation && d2.elevation[0] != null) parts.push(Math.round(d2.elevation[0]) + 'm');
              if (preview.style.display !== 'none') {
                preview.textContent = '\u{1F4CD} ' + (parts.length ? parts.join(' · ') : 'Coords found');
              }
            }).catch(function() {
              if (preview.style.display !== 'none') {
                preview.textContent = '\u{1F4CD} ' + [city, country].filter(Boolean).join(', ') || 'Coords found';
              }
            });
        }
      })
      .catch(function() {
        preview.textContent = '\u{1F4CD} Coords found: ' + coords[0].toFixed(5) + ', ' + coords[1].toFixed(5);
      });

  } else if (val.trim()) {
    preview.textContent = 'No coordinates detected — will use city/country for map pin';
    preview.style.color = '#9ca3af';
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none';
  }
}

// ── Backfill coords from existing mapLinks on startup ──
function backfillCoordsFromLinks() {
  places.forEach(function(p) {
    if (p._lat == null && p.mapLink) {
      var coords = extractCoordsFromMapLink(p.mapLink);
      if (coords) { p._lat = coords[0]; p._lng = coords[1]; }
    }
  });
}

function loadPlaces() {
  places = [];
  try {
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (k && k.startsWith('tj_place_')) {
        try { const v = localStorage.getItem(k); if (v) places.push(JSON.parse(v)); } catch(e) {}
      }
    }
  } catch(e) { places = []; }
  rebuildSets();
  refreshYearSelect();
}

function saveToStorage(place) {
  try { localStorage.setItem('tj_place_' + place.id, JSON.stringify(place)); } catch(e) {}
}

function deleteFromStorage(id) {
  try { localStorage.removeItem('tj_place_' + id); } catch(e) {}
}



// ================================================================
// TRIP METADATA (header photo + overall ratings per trip/location)
// ================================================================
var currentGroupType = '';
var currentGroupValue = '';
var tripMetaRatings = { hunter: 0, brandon: 0 };

function getTripMeta(type, value) {
  var key = 'tj_meta_' + type + '_' + encodeURIComponent(value);
  try { return JSON.parse(localStorage.getItem(key)) || {}; } catch(e) { return {}; }
}

function saveTripMeta(type, value, data) {
  var key = 'tj_meta_' + type + '_' + encodeURIComponent(value);
  try { localStorage.setItem(key, JSON.stringify(data)); } catch(e) {}
}

function openTripEdit() {
  var panel = document.getElementById('tripEditPanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  // Load current meta
  var meta = getTripMeta(currentGroupType, currentGroupValue);
  tripMetaRatings.hunter = meta.hunterRating || 0;
  tripMetaRatings.brandon = meta.brandonRating || 0;
  updateTripStars('hunter', tripMetaRatings.hunter);
  updateTripStars('brandon', tripMetaRatings.brandon);
  // Load dates
  document.getElementById('tripStartDate').value = meta.startDate || '';
  document.getElementById('tripEndDate').value = meta.endDate || '';
}

function updateTripStars(who, val) {
  var starsEl = document.getElementById('trip' + (who==='hunter'?'Hunter':'Brandon') + 'Stars');
  var valEl = document.getElementById('trip' + (who==='hunter'?'Hunter':'Brandon') + 'Val');
  if (!starsEl) return;
  var color = who === 'hunter' ? '#97AC9F' : '#859EAC';
  starsEl.querySelectorAll('.star-btn').forEach(function(s) {
    var n = parseInt(s.dataset.n);
    s.style.color = n <= val ? color : '#d1d5db';
  });
  if (valEl) valEl.textContent = val > 0 ? val + '/5' : '—';
}

function setTripRating(el) {
  var who = el.dataset.who;
  var n = parseInt(el.dataset.n);
  var cur = tripMetaRatings[who];
  var newVal = (cur === n) ? n - 0.5 : n;
  if (newVal < 0.5) newVal = 0;
  tripMetaRatings[who] = newVal;
  updateTripStars(who, newVal);
}

function handleTripPhoto(input) {
  if (!input.files || !input.files[0]) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    var meta = getTripMeta(currentGroupType, currentGroupValue);
    meta.photo = e.target.result;
    saveTripMeta(currentGroupType, currentGroupValue, meta);
    applyGroupHeader(currentGroupType, currentGroupValue, meta);
  };
  reader.readAsDataURL(input.files[0]);
}

function clearTripPhoto() {
  var meta = getTripMeta(currentGroupType, currentGroupValue);
  delete meta.photo;
  saveTripMeta(currentGroupType, currentGroupValue, meta);
  applyGroupHeader(currentGroupType, currentGroupValue, meta);
}

function saveTripEdit() {
  var meta = getTripMeta(currentGroupType, currentGroupValue);
  meta.hunterRating = tripMetaRatings.hunter;
  meta.brandonRating = tripMetaRatings.brandon;
  meta.startDate = document.getElementById('tripStartDate').value || '';
  meta.endDate = document.getElementById('tripEndDate').value || '';
  saveTripMeta(currentGroupType, currentGroupValue, meta);
  document.getElementById('tripEditPanel').style.display = 'none';
  // Re-render stats to show new ratings
  renderGroupDetailStats(currentGroupType, currentGroupValue,
    places.filter(function(p) {
      if (p.isWishlist) return false;
      if (currentGroupType === 'trip') return p.trip === currentGroupValue;
      if (currentGroupType === 'country') return p.country === currentGroupValue;
      if (currentGroupType === 'state') return p.state === currentGroupValue;
      if (currentGroupType === 'city') return p.city === currentGroupValue;
      return false;
    }), meta);
  // Refresh date range in header
  var dateRangeEl = document.getElementById('tripDateRange');
  if (dateRangeEl && currentGroupType === 'trip') {
    var updatedMeta = getTripMeta(currentGroupType, currentGroupValue);
    if (updatedMeta.startDate || updatedMeta.endDate) {
      var fmt = function(d) { return d ? new Date(d + 'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : ''; };
      dateRangeEl.textContent = updatedMeta.startDate && updatedMeta.endDate
        ? fmt(updatedMeta.startDate) + ' – ' + fmt(updatedMeta.endDate)
        : fmt(updatedMeta.startDate || updatedMeta.endDate);
      dateRangeEl.style.display = 'block';
    } else { dateRangeEl.style.display = 'none'; }
  }
  showToast('Trip settings saved');
}

function applyGroupHeader(type, value, meta) {
  var header = document.getElementById('groupDetailHeader');
  var titleEl = document.getElementById('groupDetailTitle');
  var subEl = document.getElementById('groupDetailSub');
  var typeEl = document.getElementById('groupDetailType');
  var dateEl = document.getElementById('tripDateRange');
  var editBtn = document.getElementById('groupDetailEditBtn');
  if (type === 'trip' && meta && meta.photo) {
    header.style.backgroundImage = 'url(' + meta.photo + ')';
    header.style.backgroundSize = 'cover';
    header.style.backgroundPosition = 'center';
    header.style.minHeight = '160px';
    header.style.boxShadow = 'inset 0 -60px 80px rgba(0,0,0,0.35)';
    if (titleEl) titleEl.style.color = 'white';
    if (subEl) subEl.style.color = 'rgba(255,255,255,0.85)';
    if (typeEl) typeEl.style.color = 'rgba(255,255,255,0.75)';
    if (dateEl) dateEl.style.color = 'rgba(255,255,255,0.65)';
    if (editBtn) { editBtn.style.background = 'rgba(255,255,255,0.25)'; editBtn.style.color = 'white'; }
  } else {
    header.style.backgroundImage = '';
    header.style.backgroundSize = '';
    header.style.boxShadow = '';
    header.style.minHeight = type === 'trip' ? '110px' : '90px';
    if (titleEl) titleEl.style.color = '#2d3748';
    if (subEl) subEl.style.color = '#4a5568';
    if (typeEl) typeEl.style.color = 'rgba(45,55,72,0.6)';
    if (dateEl) dateEl.style.color = 'rgba(45,55,72,0.5)';
    if (editBtn) { editBtn.style.background = 'rgba(0,0,0,0.1)'; editBtn.style.color = '#2d3748'; }
  }
}

function renderGroupDetailStats(type, value, matched, meta) {
  var html = '';
  meta = meta || getTripMeta(type, value);

  // For trips: show overall trip rating from meta + who went
  if (type === 'trip') {
    if ((meta.hunterRating || 0) > 0 || (meta.brandonRating || 0) > 0) {
      html += '<div class="bg-white border border-gray-100 rounded-xl p-3">' +
        '<div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Overall Trip Rating</div>' +
        '<div class="flex gap-3">' +
        (meta.hunterRating > 0 ? '<div class="flex-1 text-center"><div style="color:#97AC9F;font-size:1rem;">' + getStarText(meta.hunterRating) + '</div><div class="text-xs text-gray-400 mt-0.5">Hunter ' + meta.hunterRating + '/5</div></div>' : '') +
        (meta.brandonRating > 0 ? '<div class="flex-1 text-center"><div style="color:#859EAC;font-size:1rem;">' + getStarText(meta.brandonRating) + '</div><div class="text-xs text-gray-400 mt-0.5">Brandon ' + meta.brandonRating + '/5</div></div>' : '') +
        '</div></div>';
    }
    // Who went
    var allPeople = Array.from(new Set(matched.flatMap(function(p){ return p.peopleTags||[]; }))).sort();
    if (allPeople.length) {
      html += '<div class="bg-white border border-gray-100 rounded-xl p-3">' +
        '<div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Who Went</div>' +
        '<div class="flex flex-wrap gap-2">' +
        allPeople.map(function(t){ return '<span class="px-3 py-1 rounded-full text-sm font-medium" style="background:#dce8f0;color:#859EAC;">' + esc(t) + '</span>'; }).join('') +
        '</div></div>';
    }
  }

  // Full stats block for all types
  html += renderStatsBlock(matched, value);

  document.getElementById('groupDetailStats').innerHTML = html;
}

// ================================================================
// GROUP DETAIL VIEW (city / state / country / trip)
// ================================================================
var groupDetailPrev = 'list';

function openGroupDetail(type, value) {
  groupDetailPrev = currentView;
  hideAllViews();
  document.getElementById('filterBar').classList.add('hidden');
  document.getElementById('groupDetailView').classList.remove('hidden');
  currentView = 'groupDetail';

  // Gather matching places
  var matched = places.filter(function(p) {
    if (p.isWishlist) return false;
    if (type === 'country') return p.country === value;
    if (type === 'state')   return p.state === value;
    if (type === 'city')    return p.city === value;
    if (type === 'trip')    return getTrips(p).indexOf(value) !== -1;
    return false;
  });

  // Header labels
  var typeLabels = { country: 'Country', state: 'State', city: 'City', trip: 'Trip' };
  document.getElementById('groupDetailType').textContent = typeLabels[type] || type;
  // Show trip date range if available
  var dateRangeEl = document.getElementById('tripDateRange');
  if (dateRangeEl) {
    var tripMeta = getTripMeta(type, value);
    if (type === 'trip' && (tripMeta.startDate || tripMeta.endDate)) {
      var fmt = function(d) { return d ? new Date(d + 'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : ''; };
      var rangeStr = tripMeta.startDate && tripMeta.endDate
        ? fmt(tripMeta.startDate) + ' – ' + fmt(tripMeta.endDate)
        : fmt(tripMeta.startDate || tripMeta.endDate);
      dateRangeEl.textContent = rangeStr;
      dateRangeEl.style.display = 'block';
    } else {
      dateRangeEl.style.display = 'none';
    }
  }
  document.getElementById('groupDetailTitle').textContent = value;

  // Sub-label: e.g. "12 places · 3 cities" for country
  var sub = matched.length + ' place' + (matched.length !== 1 ? 's' : '');
  if (type === 'country') {
    var cities = new Set(matched.map(function(p){ return p.city; }).filter(Boolean));
    var states = new Set(matched.map(function(p){ return p.state; }).filter(Boolean));
    if (states.size) sub += ' · ' + states.size + ' state' + (states.size !== 1 ? 's' : '');
    if (cities.size) sub += ' · ' + cities.size + ' cit' + (cities.size !== 1 ? 'ies' : 'y');
  } else if (type === 'state') {
    var scities = new Set(matched.map(function(p){ return p.city; }).filter(Boolean));
    if (scities.size) sub += ' · ' + scities.size + ' cit' + (scities.size !== 1 ? 'ies' : 'y');
  } else if (type === 'trip') {
    var tco = new Set(matched.map(function(p){ return p.country; }).filter(Boolean));
    if (tco.size) sub += ' · ' + tco.size + ' countr' + (tco.size !== 1 ? 'ies' : 'y');
  }
  document.getElementById('groupDetailSub').textContent = sub;

  // Track current group for edit panel
  currentGroupType = type;
  currentGroupValue = value;

  // Back button
  document.getElementById('groupDetailBack').onclick = function() {
    document.getElementById('tripEditPanel').style.display = 'none';
    showAllViews(groupDetailPrev);
  };

  // Edit button: only for trips
  document.getElementById('groupDetailEditBtn').style.display = type === 'trip' ? 'block' : 'none';

  // Apply header photo (trips only)
  var meta = getTripMeta(type, value);
  applyGroupHeader(type, value, meta);

  // Stats + who went
  renderGroupDetailStats(type, value, matched, meta);

  document.getElementById('groupDetailPlacesLabel').textContent = matched.length + ' Places';
  document.getElementById('groupDetailPlaces').innerHTML = matched
    .sort(function(a,b){ return (b.rating||0)-(a.rating||0); })
    .map(function(p){ return renderCard(p); }).join('');
}

function gStatCard(val, label) {
  return '<div class="bg-white rounded-xl p-3 text-center shadow-sm border border-gray-100">' +
    '<div class="text-xl font-bold" style="color:#97AC9F;">' + val + '</div>' +
    '<div class="text-xs text-gray-500 mt-0.5">' + label + '</div></div>';
}

// ================================================================
// NAVIGATION
// ================================================================
// ================================================================
// CUSTOM CONFIRM (replaces browser confirm() which is blocked in iframes)
// ================================================================
function showConfirm(title, msg, okLabel, okColor, onOk) {
  var modal = document.getElementById('confirmModal');
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMsg').textContent = msg;
  var okBtn = document.getElementById('confirmOkBtn');
  okBtn.textContent = okLabel || 'OK';
  okBtn.style.background = okColor || '#e57373';
  modal.style.display = 'flex';
  // Clone to remove old listeners
  var newOk = okBtn.cloneNode(true);
  okBtn.parentNode.replaceChild(newOk, okBtn);
  var newCancel = document.getElementById('confirmCancelBtn').cloneNode(true);
  document.getElementById('confirmCancelBtn').parentNode.replaceChild(newCancel, document.getElementById('confirmCancelBtn'));
  newOk.onclick = function() { modal.style.display = 'none'; onOk(); };
  newCancel.onclick = function() { modal.style.display = 'none'; };
}

// Hide every known view panel
function hideAllViews() {
  ['listView','mapView','statsView','calendarView','wishlistView','timelineView','detailView','groupDetailView'].forEach(function(id) {
    var el = document.getElementById(id); if (el) el.classList.add('hidden');
  });
  document.getElementById('placeForm').classList.add('hidden');
}

function setView(view) {
  currentView = view;
  hideAllViews();
  ['list','map','stats','calendar','wishlist','timeline'].forEach(function(v) {
    var btn = document.getElementById('nav' + v.charAt(0).toUpperCase() + v.slice(1));
    if (btn) btn.classList.remove('active');
  });
  var el = document.getElementById(view + 'View');
  if (el) el.classList.remove('hidden');
  var activeBtn = document.getElementById('nav' + view.charAt(0).toUpperCase() + view.slice(1));
  if (activeBtn) activeBtn.classList.add('active');
  var hideFilter = (view === 'stats' || view === 'detail' || view === 'calendar' || view === 'groupDetail' || view === 'wishlist' || view === 'timeline');
  document.getElementById('filterBar').classList.toggle('hidden', hideFilter);
  renderCurrentView();
}

// Convenience: hide all, show one view by id without nav logic
function showAllViews(view) {
  hideAllViews();
  var el = document.getElementById(view + 'View');
  if (el) el.classList.remove('hidden');
  currentView = view;
  var hideFilter = (view === 'stats' || view === 'detail' || view === 'calendar' || view === 'groupDetail' || view === 'wishlist' || view === 'timeline');
  document.getElementById('filterBar').classList.toggle('hidden', hideFilter);
  renderCurrentView();
}


// ================================================================
// GOOGLE DRIVE SYNC
// ================================================================
// ➡️  SETUP: Replace the value below with your Google OAuth Client ID.
//    Get one free at: https://console.cloud.google.com
//    APIs & Services → Credentials → Create → OAuth 2.0 Client ID (Web)
//    Add your file's origin to "Authorized JavaScript origins"
var GD_CLIENT_ID = '1095917737002-go5eiaef0v26rm1epdls7o5lljgcu7qn.apps.googleusercontent.com';

var GD_SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
var GD_FILE_NAME = 'travel-journal-data.json';
var GD_FILE_ID_KEY = 'tj_gd_file_id';
var gdTokenClient = null;
var gdAccessToken = null;
var gdUser = null;
var gdApiReady = false;
var gdGsiReady = false;

// Called when google.accounts.id is loaded
function onGsiLoad() {
  gdGsiReady = true;
  if (gdApiReady) gdInitTokenClient();
}

// Called when gapi is loaded
function onGapiLoad() {
  gapi.load('client', function() {
    gapi.client.init({}).then(function() {
      gdApiReady = true;
      if (gdGsiReady) gdInitTokenClient();
    });
  });
}

function gdInitTokenClient() {
  if (!GD_CLIENT_ID || GD_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') return;
  gdTokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GD_CLIENT_ID,
    scope: GD_SCOPES,
    callback: function(resp) {
      if (resp.error) { gdSetStatus('Sign-in failed: ' + resp.error, '#e57373'); return; }
      gdAccessToken = resp.access_token;
      // Fetch user profile
      fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
        headers: { Authorization: 'Bearer ' + gdAccessToken }
      }).then(function(r){ return r.json(); }).then(function(info) {
        gdUser = info;
        gdShowSignedIn(info);
      }).catch(function(){ gdShowSignedIn(null); });
    }
  });
}

function openSyncModal() {
  document.getElementById('syncModal').style.display = 'flex';
  // Check if client ID has been set
  if (!GD_CLIENT_ID || GD_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
    document.getElementById('gdClientIdWarning').style.display = 'block';
  }
  if (gdAccessToken) {
    gdShowSignedIn(gdUser);
  } else {
    document.getElementById('syncSignedOut').style.display = 'block';
    document.getElementById('syncSignedIn').style.display = 'none';
  }
  // Update last sync time
  var lastSync = localStorage.getItem('tj_last_sync');
  if (lastSync) {
    var d = new Date(lastSync);
    document.getElementById('gdLastSync').textContent = 'Last synced: ' + d.toLocaleString();
  }
}

function closeSyncModal() {
  document.getElementById('syncModal').style.display = 'none';
}

function gdSignIn() {
  if (!GD_CLIENT_ID || GD_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
    document.getElementById('gdClientIdWarning').style.display = 'block';
    return;
  }
  if (!gdTokenClient) {
    gdSetStatus('Google API not ready yet, please wait a moment and try again.', '#e57373');
    return;
  }
  gdTokenClient.requestAccessToken({ prompt: 'consent' });
}

function gdSignOut() {
  if (gdAccessToken) {
    google.accounts.oauth2.revoke(gdAccessToken, function(){});
  }
  gdAccessToken = null;
  gdUser = null;
  document.getElementById('syncSignedOut').style.display = 'block';
  document.getElementById('syncSignedIn').style.display = 'none';
  document.getElementById('gdSyncStatus').textContent = '';
}

function gdShowSignedIn(user) {
  document.getElementById('syncSignedOut').style.display = 'none';
  document.getElementById('syncSignedIn').style.display = 'block';
  if (user) {
    document.getElementById('gdUserName').textContent = user.name || '';
    document.getElementById('gdUserEmail').textContent = user.email || '';
    if (user.picture) {
      var av = document.getElementById('gdUserAvatar');
      av.src = user.picture; av.style.display = 'block';
    }
  }
}

function gdSetStatus(msg, color) {
  var el = document.getElementById('gdSyncStatus');
  el.textContent = msg;
  el.style.color = color || '#97AC9F';
}

function gdSetBtnLoading(btnId, loading, label) {
  var btn = document.getElementById(btnId);
  if (!btn) return;
  btn.disabled = loading;
  btn.textContent = loading ? '⏳ Please wait...' : label;
  btn.style.opacity = loading ? '0.7' : '1';
}

// Save all places to Drive appdata folder
function gdSaveToCloud() {
  if (!gdAccessToken) { gdSignIn(); return; }
  gdSetBtnLoading('gdSaveBtn', true, '☁️ Save to Google Drive');
  gdSetStatus('Saving...', '#97AC9F');

  var data = JSON.stringify({ version: 1, saved: new Date().toISOString(), places: places });
  var fileId = localStorage.getItem(GD_FILE_ID_KEY);

  function upload(method, url) {
    var boundary = 'traveljournalboundary';
    // Only include parents on initial POST — PATCH must not include it
    var metaObj = { name: GD_FILE_NAME };
    if (method === 'POST') metaObj.parents = ['appDataFolder'];
    var meta = JSON.stringify(metaObj);
    var CRLF = '\r\n';
    var body = '--' + boundary + CRLF +
      'Content-Type: application/json; charset=UTF-8' + CRLF + CRLF +
      meta + CRLF +
      '--' + boundary + CRLF +
      'Content-Type: application/json; charset=UTF-8' + CRLF + CRLF +
      data + CRLF +
      '--' + boundary + '--';
    return fetch(url, {
      method: method,
      headers: { Authorization: 'Bearer ' + gdAccessToken, 'Content-Type': 'multipart/related; boundary=' + boundary },
      body: body
    }).then(function(r) {
      return r.json().then(function(json) {
        if (!r.ok) throw new Error((json.error && json.error.message) || ('HTTP ' + r.status));
        return json;
      });
    });
  }

  var p;
  if (fileId) {
    p = upload('PATCH', 'https://www.googleapis.com/upload/drive/v3/files/' + fileId + '?uploadType=multipart');
  } else {
    p = upload('POST', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart');
  }

  p.then(function(resp) {
    if (resp.id) {
      localStorage.setItem(GD_FILE_ID_KEY, resp.id);
      localStorage.setItem('tj_last_sync', new Date().toISOString());
      document.getElementById('gdLastSync').textContent = 'Last synced: ' + new Date().toLocaleString();
      gdSetStatus('✓ Saved to Google Drive (' + places.length + ' places)', '#97AC9F');
      showToast('☁️ Saved to Google Drive');
    } else {
      var detail = resp.error ? resp.error.message : JSON.stringify(resp);
      gdSetStatus('Save failed: ' + detail, '#e57373');
    }
    gdSetBtnLoading('gdSaveBtn', false, '☁️ Save to Google Drive');
  }).catch(function(e) {
    gdSetStatus('Error: ' + e.message, '#e57373');
    gdSetBtnLoading('gdSaveBtn', false, '☁️ Save to Google Drive');
  });
}

// Load places from Drive, merge with local
function gdLoadFromCloud() {
  if (!gdAccessToken) { gdSignIn(); return; }
  gdSetBtnLoading('gdLoadBtn', true, '↓ Load from Google Drive');
  gdSetStatus('Loading...', '#859EAC');

  var fileId = localStorage.getItem(GD_FILE_ID_KEY);

  function loadFile(id) {
    return fetch('https://www.googleapis.com/drive/v3/files/' + id + '?alt=media', {
      headers: { Authorization: 'Bearer ' + gdAccessToken }
    }).then(function(r){ return r.json(); });
  }

  function findAndLoad() {
    // Search appdata for our file
    return fetch("https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&q=name='" + GD_FILE_NAME + "'&fields=files(id,name,modifiedTime)", {
      headers: { Authorization: 'Bearer ' + gdAccessToken }
    }).then(function(r){ return r.json(); }).then(function(resp) {
      if (resp.files && resp.files.length > 0) {
        var id = resp.files[0].id;
        localStorage.setItem(GD_FILE_ID_KEY, id);
        return loadFile(id);
      } else {
        return null;
      }
    });
  }

  var loadPromise = fileId ? loadFile(fileId).catch(function(){ return findAndLoad(); }) : findAndLoad();

  loadPromise.then(function(data) {
    if (!data) {
      gdSetStatus('No saved journal found in Drive.', '#e57373');
      gdSetBtnLoading('gdLoadBtn', false, '↓ Load from Google Drive');
      return;
    }
    var incoming = data.places || (Array.isArray(data) ? data : null);
    if (!incoming) {
      gdSetStatus('File found but could not read data.', '#e57373');
      gdSetBtnLoading('gdLoadBtn', false, '↓ Load from Google Drive');
      return;
    }
    // Merge: add new places, update existing
    var added = 0, updated = 0;
    incoming.forEach(function(p) {
      if (!p.id || !p.name) return;
      var idx = places.findIndex(function(x){ return x.id === p.id; });
      if (idx >= 0) { places[idx] = p; updated++; }
      else { places.push(p); added++; }
      saveToStorage(p);
    });
    rebuildSets(); refreshYearSelect();
    localStorage.setItem('tj_last_sync', new Date().toISOString());
    document.getElementById('gdLastSync').textContent = 'Last synced: ' + new Date().toLocaleString();
    gdSetStatus('✓ Loaded: ' + added + ' added, ' + updated + ' updated', '#97AC9F');
    showToast('↓ Loaded from Google Drive');
    gdSetBtnLoading('gdLoadBtn', false, '↓ Load from Google Drive');
  }).catch(function(e) {
    gdSetStatus('Load failed: ' + e.message, '#e57373');
    gdSetBtnLoading('gdLoadBtn', false, '↓ Load from Google Drive');
  });
}

function renderCurrentView() {
  if (currentView === 'list') renderList();
  else if (currentView === 'map') renderMap();
  else if (currentView === 'stats') renderStats();
  else if (currentView === 'calendar') renderCalendar();
  else if (currentView === 'wishlist') renderWishlist();
  else if (currentView === 'timeline') renderTimeline();
}

// ================================================================
// FORM
// ================================================================
function showForm(asWishlist) {
  ['listView','mapView','statsView','calendarView','wishlistView','timelineView','detailView'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.classList.add('hidden');
  });
  document.getElementById('filterBar').classList.add('hidden');
  document.getElementById('placeForm').classList.remove('hidden');
  if (asWishlist && !editingId) {
    document.getElementById('isWishlistCheck').checked = true;
    updateFormForWishlist();
  }
  document.getElementById('formTitle').textContent = editingId ? 'Edit Place' : (document.getElementById('isWishlistCheck').checked ? '☆ Add to Wishlist' : 'Add New Place');
}

function cancelForm() {
  editingId = null;
  currentPhotos = [];
  subRatingCounter = 0;
  subRatingClicks = {};
  currentRating = 5;
  document.getElementById('isWishlistCheck').checked = false;
  updateFormForWishlist();
  document.getElementById('placeForm').reset();
  document.getElementById('placeDetailTags').value = '';
  var _dc = document.getElementById("detailTagChips"); if (_dc) { _dc.innerHTML=""; _dc.style.display="none"; }
  document.getElementById('wouldRevisit').checked = false;
  document.getElementById('firstTimeVisit').checked = true;
  document.getElementById('placeForm').classList.add('hidden');
  document.getElementById('hunterRating').value = '5';
  document.getElementById('brandonRating').value = '5';
  document.getElementById('enjoymentRating').value = '5';
  document.getElementById('hunterRatingValue').textContent = '5';
  document.getElementById('brandonRatingValue').textContent = '5';
  document.getElementById('enjoymentRatingValue').textContent = '5';
  document.getElementById('placeZepeda').value = '0';
  document.getElementById('noteInput').value = '';
  document.getElementById('placeNotes').value = '[]';
  document.getElementById('notesThread').innerHTML = '';
  document.getElementById('photoPreviewContainer').innerHTML = '';
  document.getElementById('subRatingsContainer').innerHTML = '';
  document.getElementById('datesContainer').innerHTML = '';
  // Reset desire weight
  document.getElementById('desireWeight').value = '3';
  document.getElementById('desireWeightValue').textContent = '3';
  var dStars = document.querySelectorAll('#desireStars .star-btn');
  dStars.forEach(function(s, i){ s.style.color = i < 3 ? '#E6C8C6' : '#d1d5db'; });
  document.getElementById('desireWeightRow').style.display = 'none';
  document.getElementById('hunterNA').value = '0';
  document.getElementById('brandonNA').value = '0';
  document.getElementById('hunterNaBtn').style.cssText = 'border-color:#d1d5db;color:#9ca3af;font-size:0.75rem;padding:2px 6px;border-radius:4px;font-weight:600;border-width:1px;border-style:solid;';
  document.getElementById('brandonNaBtn').style.cssText = 'border-color:#d1d5db;color:#9ca3af;font-size:0.75rem;padding:2px 6px;border-radius:4px;font-weight:600;border-width:1px;border-style:solid;';
  document.getElementById('hunterStars').style.opacity = '1';
  document.getElementById('brandonStars').style.opacity = '1';
  document.getElementById('hunterStars').style.pointerEvents = '';
  document.getElementById('brandonStars').style.pointerEvents = '';
  updateStars('hunterStars', 5, '#97AC9F');
  updateStars('brandonStars', 5, '#859EAC');
  updateStars('enjoymentStars', 5, '#E6C8C6');
  document.querySelectorAll('.zepeda-btn').forEach(function(b) { b.classList.remove('active'); });
  if (currentView !== 'wishlist') setView('list');
  else renderWishlist();
}

function handleSubmit(e) {
  e.preventDefault();
  var name = document.getElementById('placeName').value.trim();
  var city = document.getElementById('placeCity').value.trim();
  var country = document.getElementById('placeCountry').value.trim();
  if (!name || !city || !country) {
    alert('Please fill in Place Name, City, and Country.');
    return;
  }
  var state = document.getElementById('placeState').value.trim();
  var rawTypeTags = document.getElementById('placeTypeTags').value;
  var rawPeopleTags = document.getElementById('placePeopleTags').value;
  var rawDetailTags = document.getElementById('placeDetailTags').value;
  var detailTags = rawDetailTags.split(',').map(function(t){ return t.trim(); }).filter(Boolean);
  var typeTags = rawTypeTags.split(',').map(function(t){ return t.trim(); }).filter(Boolean);
  var peopleTags = rawPeopleTags.split(',').map(function(t){ return t.trim(); }).filter(Boolean);
  var wasEditing = !!editingId;
  var existingPlace = wasEditing ? places.find(function(p){ return p.id === editingId; }) : null;

  var hunterNA = document.getElementById('hunterNA').value === '1';
  var brandonNA = document.getElementById('brandonNA').value === '1';
  var hunterRating = hunterNA ? null : (parseFloat(document.getElementById('hunterRating').value) || 5);
  var brandonRating = brandonNA ? null : (parseFloat(document.getElementById('brandonRating').value) || 5);
  var enjoymentRating = parseFloat(document.getElementById('enjoymentRating').value) || 5;
  var notesRaw = document.getElementById('placeNotes').value;
  var notesArr = [];
  try { notesArr = JSON.parse(notesRaw); if (!Array.isArray(notesArr)) notesArr = []; } catch(e) { notesArr = []; }
  var wouldRevisit = document.getElementById('wouldRevisit').checked;
  var firstTimeVisit = document.getElementById('firstTimeVisit').checked;
  var place = {
    id: editingId || String(Date.now()),
    name: name,
    city: city,
    state: state,
    country: country,
    location: state ? city + ', ' + state + ', ' + country : city + ', ' + country,
    trip: document.getElementById('placeTrip').value.trim(),
    mapLink: document.getElementById('placeMapLink').value.trim(),
    dates: getVisitDates(),
    visits: existingPlace ? existingPlace.visits : [],
    hunterRating: hunterRating,
    enjoymentRating: enjoymentRating,
    brandonRating: brandonRating,
    hunterNA: hunterNA,
    brandonNA: brandonNA,
    rating: (hunterNA && brandonNA) ? 0 : hunterNA ? brandonRating : brandonNA ? hunterRating : (hunterRating + brandonRating) / 2,
    wouldRevisit: wouldRevisit,
    firstTime: firstTimeVisit,
    zepedaStars: parseInt(document.getElementById('placeZepeda').value) || 0,
    subRatings: getSubRatings(),
    typeTags: typeTags,
    detailTags: detailTags,
    peopleTags: peopleTags,
    tags: typeTags.concat(peopleTags),
    notes: notesArr,
    photos: currentPhotos.slice(),
    isWishlist: document.getElementById('isWishlistCheck').checked,
    desireWeight: document.getElementById('isWishlistCheck').checked ? (parseInt(document.getElementById('desireWeight').value) || 3) : null,
    createdAt: existingPlace ? existingPlace.createdAt : new Date().toISOString()
  };
  var coords = extractCoordsFromMapLink(place.mapLink);
  if (coords) { place._lat = coords[0]; place._lng = coords[1]; }
  else if (existingPlace && existingPlace._lat != null) { place._lat = existingPlace._lat; place._lng = existingPlace._lng; }

  if (wasEditing) {
    var idx = places.findIndex(function(p){ return p.id === place.id; });
    if (idx >= 0) places[idx] = place; else places.push(place);
  } else {
    places.push(place);
  }

  saveToStorage(place);
  rebuildSets(); // debounced
  refreshYearSelect();
  var savedIsWishlist = place.isWishlist;
  cancelForm();
  if (savedIsWishlist) { setView('wishlist'); }
  showToast(wasEditing ? '✓ Place updated!' : (savedIsWishlist ? '☆ Added to Wishlist!' : '✓ Place saved!'));
  // Silently fetch elevation in background if coords available
  if (place._lat != null && place._elevation == null) {
    fetchElevation(place, function(){});
  }
}


// ================================================================
// NOTES THREAD
// ================================================================
var pendingNoteText = '';

function addNote() {
  var text = document.getElementById('noteInput').value.trim();
  if (!text) return;
  pendingNoteText = text;
  document.getElementById('noteInput').value = '';
  // Show author picker modal
  document.getElementById('authorModal').style.display = 'flex';
}

function pickAuthor(author) {
  document.getElementById('authorModal').style.display = 'none';
  if (!pendingNoteText) return;
  var note = { author: author, text: pendingNoteText, ts: new Date().toISOString() };
  pendingNoteText = '';
  // Get current notes array from hidden field
  var notesArr = [];
  try { notesArr = JSON.parse(document.getElementById('placeNotes').value); if (!Array.isArray(notesArr)) notesArr = []; } catch(e) { notesArr = []; }
  notesArr.push(note);
  document.getElementById('placeNotes').value = JSON.stringify(notesArr);
  renderNotesThread(notesArr);
}

function renderNotesThread(notes) {
  var el = document.getElementById('notesThread');
  if (!el) return;
  if (!notes || !notes.length) { el.innerHTML = '<div style="color:#aaa;font-size:0.8rem;text-align:center;padding:8px;">No notes yet</div>'; return; }
  el.innerHTML = notes.map(function(n) {
    var isHunter = n.author === 'Hunter';
    var isBrandon = n.author === 'Brandon';
    var align = isHunter ? 'flex-end' : (isBrandon ? 'flex-start' : 'center');
    var bg = isHunter ? '#97AC9F' : (isBrandon ? '#859EAC' : '#e5e7eb');
    var color = (isHunter || isBrandon) ? 'white' : '#555';
    var dateStr = n.ts ? new Date(n.ts).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
    if (n.author === 'Other') {
      return '<div style="display:flex;justify-content:center;margin:4px 0;">' +
        '<div style="background:#f3f4f6;border-radius:10px;padding:4px 10px;max-width:90%;text-align:center;">' +
        '<div style="font-size:0.75rem;color:#888;">' + esc(n.text) + '</div>' +
        (dateStr ? '<div style="font-size:0.65rem;color:#bbb;margin-top:1px;">' + dateStr + '</div>' : '') +
        '</div></div>';
    }
    return '<div style="display:flex;justify-content:' + align + ';margin:3px 0;">' +
      '<div style="max-width:80%;">' +
      '<div style="font-size:0.65rem;font-weight:600;color:#888;margin-bottom:1px;text-align:' + (isHunter?'right':'left') + ';">' + esc(n.author) + '</div>' +
      '<div style="background:' + bg + ';color:' + color + ';border-radius:' + (isHunter?'14px 14px 4px 14px':'14px 14px 14px 4px') + ';padding:7px 12px;font-size:0.82rem;line-height:1.4;">' + esc(n.text) + '</div>' +
      (dateStr ? '<div style="font-size:0.62rem;color:#bbb;margin-top:2px;text-align:' + (isHunter?'right':'left') + ';">' + dateStr + '</div>' : '') +
      '</div></div>';
  }).join('');
  el.scrollTop = el.scrollHeight;
}

// ================================================================
// DATES
// ================================================================
function addDateField(entry) {
  var startVal = '', endVal = '';
  if (typeof entry === 'object' && entry !== null) { startVal = entry.start||''; endVal = entry.end||''; }
  else if (typeof entry === 'string') { startVal = entry; }
  var div = document.createElement('div');
  div.className = 'visit-date-row rounded-lg border border-gray-200 bg-gray-50 p-2 space-y-1.5';
  function mkRow(lbl, cls, val, hint) {
    var row = document.createElement('div'); row.className = 'flex items-center gap-2';
    var l = document.createElement('span'); l.className = 'text-xs text-gray-500 w-10 flex-shrink-0'; l.textContent = lbl;
    var inp = document.createElement('input'); inp.type = 'date'; inp.value = val;
    inp.className = cls + ' flex-1 px-2 py-1 border border-gray-300 rounded-lg text-sm';
    row.appendChild(l); row.appendChild(inp);
    if (hint) { var h = document.createElement('span'); h.className = 'text-xs text-gray-400 italic'; h.textContent = hint; row.appendChild(h); }
    return row;
  }
  div.appendChild(mkRow('Start', 'visit-date visit-date-start', startVal, null));
  div.appendChild(mkRow('End', 'visit-date-end', endVal, 'optional'));
  var btn = document.createElement('button'); btn.type = 'button'; btn.textContent = 'Remove';
  btn.className = 'text-red-400 text-xs self-end px-1';
  btn.onclick = function() { div.remove(); };
  div.appendChild(btn);
  document.getElementById('datesContainer').appendChild(div);
}

function getVisitDates() {
  var rows = document.querySelectorAll('.visit-date-row');
  if (!rows.length) {
    return Array.from(document.querySelectorAll('.visit-date')).map(function(i){ return i.value; }).filter(Boolean).sort();
  }
  var result = [];
  rows.forEach(function(row) {
    var s = row.querySelector('.visit-date-start'), e = row.querySelector('.visit-date-end');
    var start = s ? s.value : '', end = e ? e.value : '';
    if (start) result.push({start: start, end: end || null});
  });
  return result.sort(function(a,b){ return a.start.localeCompare(b.start); });
}

function normaliseDates(p) {
  var raw = (p.dates && p.dates.length ? p.dates : []).concat(p.date ? [p.date] : []);
  return raw.filter(Boolean).map(function(d) {
    if (typeof d === 'object' && d !== null) return {start:(d.start||'').slice(0,10), end:d.end?d.end.slice(0,10):null};
    return {start: d.slice(0,10), end: null};
  });
}
function getDateStarts(p) {
  return normaliseDates(p).map(function(e){ return e.start; }).filter(Boolean).sort();
}

// ================================================================
// RATINGS
// ================================================================
function toggleNA(who) {
  var naId = who + 'NA';
  var btnId = who + 'NaBtn';
  var starsId = who + 'Stars';
  var labelId = who + 'RatingValue';
  var inputId = who + 'Rating';
  var color = who === 'hunter' ? '#97AC9F' : '#859EAC';
  var isNA = document.getElementById(naId).value === '1';
  if (isNA) {
    // Turn off N/A — restore stars
    document.getElementById(naId).value = '0';
    document.getElementById(btnId).style.cssText = 'border-color:#d1d5db;color:#9ca3af;font-size:0.75rem;padding:2px 6px;border-radius:4px;font-weight:600;border-width:1px;border-style:solid;';
    document.getElementById(starsId).style.opacity = '1';
    document.getElementById(starsId).style.pointerEvents = '';
    var cur = parseFloat(document.getElementById(inputId).value) || 5;
    document.getElementById(labelId).textContent = cur;
    updateStars(starsId, cur, color);
  } else {
    // Turn on N/A — grey out stars
    document.getElementById(naId).value = '1';
    document.getElementById(btnId).style.cssText = 'background:#97AC9F;border-color:#97AC9F;color:white;font-size:0.75rem;padding:2px 6px;border-radius:4px;font-weight:600;border-width:1px;border-style:solid;';
    document.getElementById(starsId).style.opacity = '0.25';
    document.getElementById(starsId).style.pointerEvents = 'none';
    document.getElementById(labelId).textContent = 'N/A';
  }
}

function setDesireWeight(n) {
  var cur = parseInt(document.getElementById('desireWeight').value) || 3;
  var newVal = (cur === n) ? Math.max(1, n - 1) : n;
  document.getElementById('desireWeight').value = newVal;
  document.getElementById('desireWeightValue').textContent = newVal;
  var stars = document.querySelectorAll('#desireStars .star-btn');
  stars.forEach(function(s, i) {
    s.style.color = i < newVal ? '#E6C8C6' : '#d1d5db';
  });
}

function setRating(who, n) {
  var inputId = who === 'hunter' ? 'hunterRating' : (who === 'enjoyment' ? 'enjoymentRating' : 'brandonRating');
  var labelId = who === 'hunter' ? 'hunterRatingValue' : (who === 'enjoyment' ? 'enjoymentRatingValue' : 'brandonRatingValue');
  var starsId = who === 'hunter' ? 'hunterStars' : (who === 'enjoyment' ? 'enjoymentStars' : 'brandonStars');
  var starColor = who === 'hunter' ? '#97AC9F' : (who === 'enjoyment' ? '#E6C8C6' : '#859EAC');
  var cur = parseFloat(document.getElementById(inputId).value);
  var newVal = (cur === n) ? n - 0.5 : n;
  if (newVal < 0.5) newVal = 0.5;
  document.getElementById(inputId).value = newVal;
  document.getElementById(labelId).textContent = newVal;
  updateStars(starsId, newVal, starColor);
}

function updateStars(containerId, r, color) {
  var stars = document.querySelectorAll('#' + containerId + ' .star-btn');
  var full = Math.floor(r), half = (r % 1 !== 0);
  stars.forEach(function(s, i) {
    if (i < full) { s.textContent = '★'; s.style.color = color; }
    else if (i === full && half) { s.textContent = '½'; s.style.color = color; }
    else { s.textContent = '★'; s.style.color = '#d1d5db'; }
  });
}

function updateMainStars(r) { updateStars('hunterStars', r, '#97AC9F'); }

function getStarText(r) {
  if (!r) return '☆';
  var full = Math.floor(r), half = (r % 1 !== 0);
  return '★'.repeat(full) + (half ? '½' : '') + '☆'.repeat(5 - full - (half ? 1 : 0));
}

function selectZepeda(v) {
  var cur = parseInt(document.getElementById('placeZepeda').value) || 0;
  var newVal = (cur === v) ? 0 : v;
  document.getElementById('placeZepeda').value = newVal;
  document.querySelectorAll('.zepeda-btn').forEach(function(b) {
    b.classList.toggle('active', parseInt(b.dataset.value) === newVal);
  });
}

// ================================================================
// SUB-RATINGS
// ================================================================
function addSubRating(cat, rating) {
  cat = cat || ''; rating = rating || 5;
  var id = subRatingCounter++;
  subRatingClicks[id] = { last: 0, count: 0 };
  var div = document.createElement('div');
  div.className = 'border border-gray-200 rounded-lg p-2 bg-white';
  div.innerHTML =
    '<div class="flex gap-2 mb-1">' +
    '<input type="text" class="sub-rating-category flex-1 px-2 py-1 border border-gray-200 rounded text-sm" placeholder="e.g., Food" value="' + esc(cat) + '"/>' +
    '<button type="button" onclick="this.closest(\'.border\').remove()" class="text-red-500 text-sm">Remove</button>' +
    '</div>' +
    '<div class="flex gap-1" data-sub-id="' + id + '">' +
    [1,2,3,4,5].map(function(n){ return '<span class="sub-star" style="color:#859EAC;cursor:pointer;" onclick="setSubRating(this,' + n + ',' + id + ')">★</span>'; }).join('') +
    '</div>' +
    '<input type="hidden" class="sub-rating-value" value="' + rating + '">';
  document.getElementById('subRatingsContainer').appendChild(div);
  updateSubStars(div.querySelectorAll('.sub-star'), rating);
}

function setSubRating(el, n, id) {
  var div = el.closest('.border');
  var stars = div.querySelectorAll('.sub-star');
  var input = div.querySelector('.sub-rating-value');
  var d = subRatingClicks[id] || { last: 0, count: 0 };
  if (d.last === n) {
    d.count++;
    if (d.count === 2) { input.value = n - 0.5; updateSubStars(stars, n - 0.5); }
    else { d.count = 1; input.value = n; updateSubStars(stars, n); }
  } else {
    d.last = n; d.count = 1; input.value = n; updateSubStars(stars, n);
  }
  subRatingClicks[id] = d;
}

function updateSubStars(stars, r) {
  var full = Math.floor(r), half = (r % 1 !== 0);
  stars.forEach(function(s, i) {
    if (i < full) { s.textContent = '★'; s.style.color = '#859EAC'; }
    else if (i === full && half) { s.textContent = '½'; s.style.color = '#859EAC'; }
    else { s.textContent = '★'; s.style.color = '#d1d5db'; }
  });
}

function getSubRatings() {
  var obj = {};
  document.querySelectorAll('#subRatingsContainer .border').forEach(function(div) {
    var cat = div.querySelector('.sub-rating-category').value.trim();
    var val = parseFloat(div.querySelector('.sub-rating-value').value);
    if (cat) obj[cat] = val;
  });
  return obj;
}

// ================================================================
// PHOTOS
// ================================================================
function handlePhotoUpload(e) {
  Array.from(e.target.files).forEach(function(file) {
    var r = new FileReader();
    r.onload = function(ev) { currentPhotos.push(ev.target.result); renderPhotoPreview(); };
    r.readAsDataURL(file);
  });
}

function renderPhotoPreview() {
  var c = document.getElementById('photoPreviewContainer');
  c.innerHTML = '';
  currentPhotos.forEach(function(ph, i) {
    var wrap = document.createElement('div');
    wrap.className = 'relative';
    var img = document.createElement('img');
    img.className = 'photo-preview';
    img.src = ph;
    img.onclick = function() { openPhoto(ph); };
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center';
    btn.textContent = '×';
    btn.onclick = function() { currentPhotos.splice(i, 1); renderPhotoPreview(); };
    wrap.appendChild(img);
    wrap.appendChild(btn);
    c.appendChild(wrap);
  });
}

function openPhoto(src) {
  document.getElementById('modalImg').src = src;
  document.getElementById('photoModal').classList.add('active');
}

// ================================================================
// LIST VIEW
// ================================================================
function renderList() {
  var visited = places.filter(function(p){ return !p.isWishlist; });
  var count = visited.length;
  document.getElementById('placeCount').textContent = count + ' place' + (count !== 1 ? 's' : '') + ' visited';

  var el = document.getElementById('placesList');
  var filtered = getFilteredSorted();
  if (!filtered.length) {
    el.innerHTML = count === 0
      ? '<div class="text-center py-12 text-gray-400"><p class="text-lg font-medium">No places yet</p><p class="text-sm mt-1">Tap + Add Place to get started</p></div>'
      : '<div class="text-center py-10 text-gray-400"><p class="font-medium">No places match your filters</p></div>';
    return;
  }

  // Flat list when a sort is active
  if (activeSorts.length > 0) {
    el.innerHTML = '<div class="space-y-2">' + filtered.map(function(p){ return renderCard(p); }).join('') + '</div>';
    return;
  }

  // Nested hierarchy: country → state (if present) → city
  var hier = {};
  filtered.forEach(function(p) {
    var co = p.country || 'Unknown';
    var st = p.state || '_none';
    var ci = p.city || 'Unknown';
    if (!hier[co]) hier[co] = {};
    if (!hier[co][st]) hier[co][st] = {};
    if (!hier[co][st][ci]) hier[co][st][ci] = [];
    hier[co][st][ci].push(p);
  });

  var html = '';
  Object.keys(hier).sort().forEach(function(co) {
    var coId = 'co-' + co.replace(/[^a-zA-Z0-9]/g, '-');
    html += '<div class="mb-3">';
    html += '<div class="section-header flex justify-between items-center p-3 rounded-lg font-bold text-base" style="background:#dde8e3;">';
    html += '<span style="color:#97AC9F;cursor:pointer;flex:1;" data-gd-type="country" data-gd-value="' + esc(co) + '" onclick="gdClick(this)">' + esc(co) + '</span>';
    html += '<span id="' + coId + '-arrow" class="collapse-arrow text-gray-500 text-sm" onclick="toggleSection(\'' + coId + '\')">▼</span></div>';
    html += '<div id="' + coId + '" class="mt-1 ml-2">';

    Object.keys(hier[co]).sort().forEach(function(st) {
      var cities = hier[co][st];
      if (st !== '_none') {
        var stId = coId + '-' + st.replace(/[^a-zA-Z0-9]/g, '-');
        html += '<div class="mb-2">';
        html += '<div class="section-header flex justify-between items-center p-2 px-3 rounded-lg font-semibold text-sm" style="background:#dce8f0;">';
        html += '<span style="color:#859EAC;cursor:pointer;flex:1;" data-gd-type="state" data-gd-value="' + esc(st) + '" onclick="gdClick(this)">' + esc(st) + '</span>';
        html += '<span id="' + stId + '-arrow" class="collapse-arrow text-gray-400 text-xs" onclick="toggleSection(\'' + stId + '\')">▼</span></div>';
        html += '<div id="' + stId + '" class="mt-1 ml-2">';
        Object.keys(cities).sort().forEach(function(ci) {
          html += buildCitySection(stId + '-' + ci.replace(/[^a-zA-Z0-9]/g, '-'), ci, cities[ci]);
        });
        html += '</div></div>';
      } else {
        Object.keys(cities).sort().forEach(function(ci) {
          html += buildCitySection(coId + '-' + ci.replace(/[^a-zA-Z0-9]/g, '-'), ci, cities[ci]);
        });
      }
    });
    html += '</div></div>';
  });

  el.innerHTML = html;
}

function buildCitySection(id, city, arr) {
  var html = '<div class="mb-2">';
  html += '<div class="section-header flex justify-between items-center p-2 px-3 rounded-lg font-medium text-sm bg-gray-100">';
  html += '<span class="text-gray-700" style="cursor:pointer;flex:1;" data-gd-type="city" data-gd-value="' + esc(city) + '" onclick="gdClick(this)">' + esc(city) + '</span>';
  html += '<span id="' + id + '-arrow" class="collapse-arrow text-gray-400 text-xs" onclick="toggleSection(\'' + id + '\')">▼</span></div>';
  html += '<div id="' + id + '" class="mt-1 ml-2 space-y-2">';
  arr.forEach(function(p) { html += renderCard(p); });
  html += '</div></div>';
  return html;
}

function renderCard(p) {
  var dates = getDateStarts(p);
  var latestDate = dates.length ? new Date(dates[dates.length-1]).toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'}) : '';
  var visitsLabel = dates.length > 1 ? dates.length + ' visits' : latestDate;
  var thumb = p.photos && p.photos[0];
  var safeId = p.id;

  var html = '<div class="bg-white border border-gray-200 rounded-lg overflow-hidden cursor-pointer hover:shadow-md" style="transition:box-shadow 0.2s;" onclick="openDetailById(\'' + safeId + '\')">';
  html += '<div class="flex items-stretch">';
  if (thumb) {
    html += '<div class="w-20 flex-shrink-0" style="min-height:72px;overflow:hidden;"><img style="width:100%;height:100%;object-fit:cover;min-height:72px;" src="' + thumb + '"></div>';
  } else {
    html += '<div class="w-2 flex-shrink-0" style="background:#97AC9F;border-radius:8px 0 0 8px;"></div>';
  }
  html += '<div class="flex-1 p-3 min-w-0">';
  html += '<div class="flex justify-between items-start gap-2">';
  html += '<div class="font-bold text-gray-800 text-sm leading-tight" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + esc(p.name) + '</div>';
  var avgR = p.rating || ((p.hunterRating||5) + (p.brandonRating||5)) / 2;
  html += '<div class="flex-shrink-0 text-right"><div class="text-xs font-bold" style="color:#6E8175;">' + getStarText(avgR) + '</div>' +
    '<div style="font-size:0.6rem;color:#aaa;line-height:1;">' + (p.hunterRating||'?') + '/' + (p.brandonRating||'?') + '</div></div>';
  html += '</div>';
  html += '<div class="text-xs text-gray-400 mt-0.5">' + (visitsLabel || 'No date') + '</div>';
  html += '<div class="flex flex-wrap gap-1 mt-1">';
  getTrips(p).forEach(function(t){ html += '<span class="px-1.5 py-0.5 rounded-full text-xs font-medium" style="background:#E6C8C6;color:#6E8175;cursor:pointer;" data-gd-type="trip" data-gd-value="' + esc(t) + '" onclick="event.stopPropagation();gdClick(this)">' + esc(t) + '</span>'; });
  (p.typeTags||[]).slice(0,2).forEach(function(t){ html += '<span class="px-1.5 py-0.5 rounded-full text-xs" style="background:#dde8e3;color:#97AC9F;">' + esc(t) + '</span>'; });
  (p.detailTags||[]).slice(0,2).forEach(function(t){ html += '<span class="px-1.5 py-0.5 rounded-full text-xs" style="background:#e8ede5;color:#6E8175;">' + esc(t) + '</span>'; });
  (p.peopleTags||[]).slice(0,2).forEach(function(t){ html += '<span class="px-1.5 py-0.5 rounded-full text-xs" style="background:#dce8f0;color:#859EAC;">' + esc(t) + '</span>'; });
  if (p.zepedaStars > 0) html += '<span class="px-1.5 py-0.5 rounded-full text-xs font-bold" style="background:#dce8f0;color:#859EAC;">' + '!'.repeat(p.zepedaStars) + '</span>';
  html += '</div></div></div></div>';
  return html;
}

function toggleSection(id) {
  var el = document.getElementById(id);
  var arrow = document.getElementById(id + '-arrow');
  if (el) el.classList.toggle('hidden');
  if (arrow) arrow.classList.toggle('collapsed');
}

// ================================================================
// FILTER & SORT

// ================================================================
// WISHLIST VIEW
// ================================================================
function updateFormForWishlist() {
  var isWishlist = document.getElementById('isWishlistCheck').checked;
  document.getElementById('formTitle').textContent =
    isWishlist ? '☆ Add to Wishlist' : (window.editingId ? 'Edit Place' : 'Add New Place');
  // Show desire weight only for wishlist
  var dRow = document.getElementById('desireWeightRow');
  if (dRow) dRow.style.display = isWishlist ? 'block' : 'none';
  // Dim (don't hide) rating sections since they can still be noted
  ['hunterRatingValue','brandonRatingValue','enjoymentRatingValue'].forEach(function(id){
    var el = document.getElementById(id);
    if (el) el.closest('div')&&(el.closest('div').style.opacity = isWishlist ? '0.4' : '1');
  });
}

function renderWishlist() {
  var wishlist = places.filter(function(p){ return p.isWishlist; });
  var el = document.getElementById('wishlistContent');
  if (!el) return;
  var countEl = document.getElementById('wishlistCount');
  if (countEl) countEl.textContent = wishlist.length + ' place' + (wishlist.length !== 1 ? 's' : '') + ' on your list';

  if (!wishlist.length) {
    el.innerHTML = '<div class="text-center py-14 text-gray-400">' +
      '<div style="font-size:2.8rem;margin-bottom:10px;">☆</div>' +
      '<div class="font-semibold text-gray-500 mb-1 text-base">Nothing on your wishlist yet</div>' +
      '<div class="text-sm mt-1">Use <b>+ Add to Wishlist</b> to save places to visit.</div>' +
      '</div>';
    return;
  }

  // Group by country → city
  var grouped = {};
  wishlist.forEach(function(p) {
    var co = p.country || 'Unknown';
    var ci = (p.state ? p.city + ', ' + p.state : p.city) || 'Unknown';
    if (!grouped[co]) grouped[co] = {};
    if (!grouped[co][ci]) grouped[co][ci] = [];
    grouped[co][ci].push(p);
  });

  var html = '';
  Object.keys(grouped).sort().forEach(function(co) {
    html += '<div class="mb-5">';
    html += '<div class="flex items-center gap-2 mb-2">' +
      '<span class="text-sm font-bold text-gray-600">' + esc(co) + '</span>' +
      '<div class="flex-1 h-px" style="background:#e5e7eb;"></div>' +
      '</div>';
    Object.keys(grouped[co]).sort().forEach(function(ci) {
      if (ci !== 'Unknown') {
        html += '<div class="text-xs font-semibold uppercase tracking-wide mb-1.5 px-0.5" style="color:#859EAC;">' + esc(ci) + '</div>';
      }
      grouped[co][ci].forEach(function(p) {
        html += '<div class="bg-white border border-gray-100 rounded-xl p-3 mb-2 shadow-sm flex items-start gap-3">';
        if (p.photos && p.photos[0]) {
          html += '<img src="' + p.photos[0] + '" style="width:54px;height:54px;object-fit:cover;border-radius:10px;flex-shrink:0;">';
        } else {
          html += '<div style="width:54px;height:54px;border-radius:10px;flex-shrink:0;background:linear-gradient(135deg,#f0f4ec,#dce8f0);display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:#97AC9F;">☆</div>';
        }
        html += '<div class="flex-1 min-w-0">';
        html += '<div class="font-semibold text-gray-800 text-sm leading-snug">' + esc(p.name) + '</div>';
        if (p.desireWeight) {
          var dw = p.desireWeight;
          var dwStars = '<span style="color:#E6C8C6;font-size:0.8rem;">' + '★'.repeat(dw) + '<span style="color:#d1d5db;">' + '★'.repeat(5-dw) + '</span></span>';
          html += '<div class="text-xs mt-0.5 flex items-center gap-1"><span class="text-gray-400">Desire:</span>' + dwStars + '</div>';
        }
        var pTrips = getTrips(p); if (pTrips.length) html += '<div class="text-xs mt-0.5" style="color:#E6C8C6;">✈ ' + pTrips.map(esc).join(', ') + '</div>';
        if (p.typeTags && p.typeTags.length) {
          html += '<div class="flex flex-wrap gap-1 mt-1">' +
            p.typeTags.slice(0,3).map(function(t){ return '<span class="px-1.5 py-0.5 rounded-full text-xs" style="background:#dde8e3;color:#97AC9F;">' + esc(t) + '</span>'; }).join('') +
            '</div>';
        }
        var notesArr = Array.isArray(p.notes) ? p.notes : (p.notes ? [{text:p.notes}] : []);
        if (notesArr.length && notesArr[0].text) {
          html += '<div class="text-xs text-gray-400 mt-1 italic" style="overflow:hidden;white-space:nowrap;text-overflow:ellipsis;max-width:200px;">' + esc(notesArr[0].text) + '</div>';
        }
        html += '</div>';
        html += '<div class="flex flex-col gap-1.5 items-end flex-shrink-0">';
        html += '<button data-wid="' + p.id + '" onclick="editPlaceById(this.dataset.wid)" class="text-xs px-2.5 py-1 rounded-lg font-semibold" style="background:#f0f4ec;color:#97AC9F;border:none;cursor:pointer;">Edit</button>';
        html += '<button data-wid="' + p.id + '" onclick="markVisited(this.dataset.wid)" class="text-xs px-2.5 py-1 rounded-lg font-semibold text-white" style="background:#97AC9F;border:none;cursor:pointer;">✓ Visited</button>';
        html += '<button data-wid="' + p.id + '" onclick="deleteWishlist(this.dataset.wid)" class="text-xs px-2.5 py-1 rounded-lg font-semibold" style="background:#fef2f2;color:#e57373;border:none;cursor:pointer;">Remove</button>';
        html += '</div>';
        html += '</div>';
      });
    });
    html += '</div>';
  });

  el.innerHTML = html;
}

function markVisited(id) {
  var p = places.find(function(x){ return x.id === id; });
  if (!p) return;
  p.isWishlist = false;
  p.desireWeight = null;  // clear desire weight once visited
  saveToStorage(p);
  rebuildSets();
  renderWishlist();
  showToast('✓ Moved to visited!');
}

function deleteWishlist(id) {
  showConfirm('Remove from Wishlist', 'Remove this place from your wishlist?', 'Remove', '#e57373', function() {
    places = places.filter(function(x){ return x.id !== id; });
    deleteFromStorage(id);
    rebuildSets();
    renderWishlist();
    showToast('Removed from wishlist');
  });
}


// ================================================================
// TIMELINE VIEW
// ================================================================
function renderTimeline() {
  var visited = places.filter(function(p){ return !p.isWishlist; });

  // ── "On This Day" banner ──
  var banner = document.getElementById('onThisDayBanner');
  var today = new Date();
  var mm = String(today.getMonth()+1).padStart(2,'0');
  var dd = String(today.getDate()).padStart(2,'0');
  var todayMMDD = mm + '-' + dd;
  var onThisDay = visited.filter(function(p) {
    return getDateStarts(p).some(function(d) {
      return d.slice(5) === todayMMDD && d.slice(0,4) !== String(today.getFullYear());
    });
  });
  if (onThisDay.length) {
    var bannerHtml = '<div class="flex items-start gap-3">' +
      '<div style="font-size:1.6rem;line-height:1;">📅</div>' +
      '<div class="flex-1">' +
      '<div class="text-xs font-bold uppercase tracking-wide mb-1" style="color:#6E8175;">On This Day</div>';
    onThisDay.forEach(function(p) {
      var yr = getDateStarts(p).find(function(d){ return d.slice(5)===todayMMDD; });
      yr = yr ? yr.slice(0,4) : '';
      bannerHtml += '<div class="text-sm font-semibold text-gray-800">' + esc(p.name) + '</div>' +
        '<div class="text-xs text-gray-500">' + esc(p.location||'') + (yr ? ' · ' + yr : '') + '</div>';
    });
    bannerHtml += '</div></div>';
    banner.innerHTML = bannerHtml;
    banner.style.display = '';
  } else {
    banner.style.display = 'none';
  }

  // ── Build flat list of events sorted by date ──
  var events = [];
  visited.forEach(function(p) {
    var dates = getDateStarts(p);
    if (!dates.length) {
      events.push({date: null, place: p});
    } else {
      dates.forEach(function(d) { events.push({date: d, place: p}); });
    }
  });
  // Sort newest first; undated at end
  events.sort(function(a,b) {
    if (!a.date && !b.date) return 0;
    if (!a.date) return 1;
    if (!b.date) return -1;
    return b.date.localeCompare(a.date);
  });
  // Deduplicate same place appearing multiple times on same date
  var seen = {};
  events = events.filter(function(e) {
    var key = e.place.id + '|' + (e.date||'');
    if (seen[key]) return false;
    seen[key] = true; return true;
  });

  if (!events.length) {
    document.getElementById('timelineContent').innerHTML =
      '<div class="text-center py-14 text-gray-400"><div style="font-size:2.5rem">🗺️</div><div class="mt-2 font-medium">No places yet</div></div>';
    return;
  }

  var html = '';
  var prevYear = null, prevMonth = null;
  events.forEach(function(e, i) {
    var p = e.place;
    var d = e.date ? new Date(e.date + 'T12:00:00') : null;
    var yr = d ? d.getFullYear() : null;
    var mo = d ? d.getMonth() : null;

    // Year divider
    if (yr !== prevYear) {
      html += '<div class="flex items-center gap-3 mb-3 mt-' + (i===0?'0':'6') + '">' +
        '<div class="text-lg font-extrabold" style="color:#6E8175;">' + (yr||'Undated') + '</div>' +
        '<div class="flex-1 h-px" style="background:#d1d5db;"></div></div>';
      prevYear = yr; prevMonth = null;
    }
    // Month divider
    if (d && mo !== prevMonth) {
      html += '<div class="text-xs font-semibold uppercase tracking-widest mb-2 ml-7" style="color:#859EAC;">' +
        d.toLocaleDateString('en-US',{month:'long'}) + '</div>';
      prevMonth = mo;
    }

    // Timeline entry
    var photoHtml = (p.photos && p.photos[0])
      ? '<img src="' + p.photos[0] + '" style="width:48px;height:48px;object-fit:cover;border-radius:8px;flex-shrink:0;">'
      : '<div style="width:48px;height:48px;border-radius:8px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:1.3rem;background:linear-gradient(135deg,#f0f4ec,#dce8f0);">📍</div>';

    var dateStr = d ? d.toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '—';
    var ratingStr = p.rating ? getStarText(p.rating) : '';

    html += '<div class="flex mb-3" style="gap:0;">' +
      // Left: date label + vertical line
      '<div class="flex flex-col items-center" style="width:40px;flex-shrink:0;">' +
        '<div class="text-xs text-gray-400 font-medium text-center" style="width:40px;line-height:1.3;">' + dateStr + '</div>' +
        '<div style="width:2px;flex:1;background:#e5e7eb;margin:3px auto 0;"></div>' +
      '</div>' +
      // Dot centred on the line
      '<div style="width:16px;flex-shrink:0;display:flex;flex-direction:column;align-items:center;padding-top:2px;">' +
        '<div style="width:10px;height:10px;border-radius:50%;background:#97AC9F;border:2px solid white;box-shadow:0 0 0 2px #97AC9F;"></div>' +
        '<div style="width:2px;flex:1;background:#e5e7eb;margin-top:2px;"></div>' +
      '</div>' +
      // Card
      '<div class="flex-1 bg-white border border-gray-100 rounded-xl p-3 shadow-sm flex gap-3 cursor-pointer" style="margin-left:8px;margin-bottom:4px;" data-place-id="' + p.id + '" onclick="openDetailById(this.dataset.placeId)">' +
        photoHtml +
        '<div class="flex-1 min-w-0">' +
          '<div class="font-semibold text-gray-800 text-sm leading-snug">' + esc(p.name) + '</div>' +
          '<div class="text-xs text-gray-400 mt-0.5 truncate">' + esc(p.location||'') + '</div>' +
          (getTrips(p).length ? '<div class="text-xs mt-0.5" style="color:#E6C8C6;">✈ ' + getTrips(p).map(esc).join(', ') + '</div>' : '') +
          (ratingStr ? '<div class="text-xs mt-1" style="color:#97AC9F;">' + ratingStr + '</div>' : '') +
          (p.typeTags && p.typeTags.length ? '<div class="flex flex-wrap gap-1 mt-1">' + p.typeTags.slice(0,2).map(function(t){return '<span class="px-1.5 py-0.5 rounded-full text-xs" style="background:#dde8e3;color:#97AC9F;">' + esc(t) + '</span>';}).join('') + '</div>' : '') +
        '</div>' +
      '</div>' +
    '</div>';
  });

  document.getElementById('timelineContent').innerHTML = html;
}

// ================================================================
function onListSearch(val) {
  document.getElementById('searchInput').value = val;
  var clearBtn = document.getElementById('listSearchClear');
  if (clearBtn) clearBtn.style.display = val ? 'block' : 'none';
  renderList();
}

function clearListSearch() {
  document.getElementById('listSearchInput').value = '';
  document.getElementById('searchInput').value = '';
  var clearBtn = document.getElementById('listSearchClear');
  if (clearBtn) clearBtn.style.display = 'none';
  renderList();
}

function getFilteredSorted(wishlistOnly) {
  var search = document.getElementById('searchInput').value.toLowerCase();
  var tripFilters = activeFilters.filter(function(f){ return f.type==='trip'; }).map(function(f){ return f.value; });
  var yearFilters = activeFilters.filter(function(f){ return f.type==='year'; }).map(function(f){ return parseInt(f.value); });
  var typeTagFilters = activeFilters.filter(function(f){ return f.type==='typeTag'; }).map(function(f){ return f.value; });
  var peopleFilters = activeFilters.filter(function(f){ return f.type==='people'; }).map(function(f){ return f.value; });
  var ratingFilter = activeFilters.find(function(f){ return f.type==='rating'; });
  var minRating = ratingFilter ? parseFloat(ratingFilter.value) : null;

  var result = places.filter(function(p) {
    if (wishlistOnly) return !!p.isWishlist;
    if (p.isWishlist) return false;
    if (search) {
      var hay = (p.name+' '+(p.location||'')+' '+(p.notes||'')+' '+getTrips(p).join(' ')+' '+(p.detailTags||[]).join(' ')).toLowerCase();
      if (hay.indexOf(search) === -1) return false;
    }
    if (tripFilters.length && !tripFilters.some(function(tf){ return getTrips(p).indexOf(tf) !== -1; })) return false;
    if (yearFilters.length) {
      var pYears = getDateStarts(p).map(function(d){ return new Date(d).getFullYear(); });
      if (!yearFilters.some(function(y){ return pYears.indexOf(y) >= 0; })) return false;
    }
    if (typeTagFilters.length && !typeTagFilters.every(function(t){ return (p.typeTags||[]).indexOf(t) >= 0; })) return false;
    if (peopleFilters.length && !peopleFilters.every(function(t){ return (p.peopleTags||[]).indexOf(t) >= 0; })) return false;
    if (minRating !== null && (p.rating||0) < minRating) return false;
    return true;
  });

  if (activeSorts.length === 0) {
    result = sortBy(result, 'date-desc');
  } else {
    var sorts = activeSorts.slice().reverse();
    sorts.forEach(function(key) { result = sortBy(result, key); });
  }
  return result;
}

function sortBy(arr, key) {
  var a = arr.slice();
  a.sort(function(x, y) {
    switch(key) {
      case 'date-desc':   return getLastDate(y) - getLastDate(x);
      case 'date-asc':    return getLastDate(x) - getLastDate(y);
      case 'rating-desc': return (y.rating||0) - (x.rating||0);
      case 'rating-asc':  return (x.rating||0) - (y.rating||0);
      case 'zepeda-desc': return (y.zepedaStars||0) - (x.zepedaStars||0);
      case 'name-asc':    return (x.name||'').localeCompare(y.name||'');
      case 'name-desc':   return (y.name||'').localeCompare(x.name||'');
      case 'visits-desc': return normaliseDates(y).length - normaliseDates(x).length;
      case 'country-asc': return (x.country||'').localeCompare(y.country||'');
      case 'city-asc':    return (x.city||'').localeCompare(y.city||'');
      case 'trip-asc':    return (x.trip||'').localeCompare(y.trip||'');
      default: return 0;
    }
  });
  return a;
}

function getLastDate(p) {
  var _ds = getDateStarts(p);
  return _ds.length ? new Date(_ds[_ds.length-1]).getTime() : 0;
}

// Sort panel
var SORT_OPTIONS = [
  {value:'date-desc',label:'Newest First'},{value:'date-asc',label:'Oldest First'},
  {value:'rating-desc',label:'Top Rated'},{value:'rating-asc',label:'Lowest Rated'},
  {value:'zepeda-desc',label:'Most Zepeda'},{value:'name-asc',label:'Name A-Z'},
  {value:'name-desc',label:'Name Z-A'},{value:'visits-desc',label:'Most Visited'},
  {value:'country-asc',label:'Country A-Z'},{value:'city-asc',label:'City A-Z'},
  {value:'trip-asc',label:'Trip A-Z'}
];

function toggleSortPanel() {
  document.getElementById('sortPanel').classList.toggle('hidden');
  renderSortPanel();
}

function renderSortPanel() {
  var chips = document.getElementById('sortChips');
  var opts = document.getElementById('sortOptions');
  chips.innerHTML = activeSorts.map(function(v, i) {
    var label = (SORT_OPTIONS.find(function(o){ return o.value===v; })||{}).label||v;
    return '<span class="sort-chip active">' + label +
      (i > 0 ? '<span onclick="moveSortUp(' + i + ')" style="cursor:pointer;margin-left:2px;">↑</span>' : '') +
      '<span onclick="removeSort(\'' + v + '\')" style="cursor:pointer;margin-left:4px;opacity:0.7;">×</span></span>';
  }).join('');
  var active = activeSorts;
  opts.innerHTML = SORT_OPTIONS.filter(function(o){ return active.indexOf(o.value) === -1; })
    .map(function(o){ return '<span class="sort-option" onclick="addSort(\'' + o.value + '\')">' + o.label + '</span>'; }).join('');
  var btn = document.getElementById('sortToggleBtn');
  btn.textContent = activeSorts.length ? 'Sort (' + activeSorts.length + ') ▾' : 'Sort ▾';
  btn.style.color = activeSorts.length ? '#97AC9F' : '';
}

function addSort(v) { if (activeSorts.indexOf(v) === -1) activeSorts.push(v); renderSortPanel(); renderCurrentView(); }
function removeSort(v) { activeSorts = activeSorts.filter(function(x){ return x !== v; }); renderSortPanel(); renderCurrentView(); }
function moveSortUp(i) { var t = activeSorts[i-1]; activeSorts[i-1] = activeSorts[i]; activeSorts[i] = t; renderSortPanel(); renderCurrentView(); }

// Filter panel
function toggleFilterPanel() {
  document.getElementById('filterPanel').classList.toggle('hidden');
  if (!document.getElementById('filterPanel').classList.contains('hidden')) renderFilterPanel();
}

function renderFilterPanel() {
  var trips = Array.from(new Set(places.filter(function(p){ return !p.isWishlist && p.trip; }).map(function(p){ return p.trip; }))).sort();
  document.getElementById('filterTripOptions').innerHTML = trips.map(function(t) {
    var active = activeFilters.some(function(f){ return f.type==='trip' && f.value===t; });
    return '<span class="filter-chip' + (active?' active':'') + '" data-type="trip" data-value="' + esc(t) + '" data-label="Trip: ' + esc(t) + '" onclick="toggleFilterChip(this)">' + esc(t) + '</span>';
  }).join('') || '<span class="text-xs text-gray-400 italic">No trips yet</span>';
  // Year filter chips
  var years = Array.from(new Set(places.filter(function(p){ return !p.isWishlist; }).flatMap(function(p){
    return (p.dates||[p.date]).filter(Boolean).map(function(d){ return String(new Date(d).getFullYear()); });
  }))).sort(function(a,b){ return b-a; });
  document.getElementById('filterYearOptions').innerHTML = years.map(function(y) {
    var active = activeFilters.some(function(f){ return f.type==='year' && f.value===y; });
    return '<span class="filter-chip' + (active?' active':'') + '" data-type="year" data-value="' + y + '" data-label="Year: ' + y + '" onclick="toggleFilterChip(this)">' + y + '</span>';
  }).join('') || '<span class="text-xs text-gray-400 italic">No dates yet</span>';

  var typeTags = Array.from(new Set(places.flatMap(function(p){ return p.typeTags||[]; }))).sort();
  document.getElementById('filterTagOptions').innerHTML = typeTags.map(function(t) {
    var active = activeFilters.some(function(f){ return f.type==='typeTag' && f.value===t; });
    return '<span class="filter-chip' + (active?' active':'') + '" data-type="typeTag" data-value="' + esc(t) + '" data-label="Type: ' + esc(t) + '" onclick="toggleFilterChip(this)">' + esc(t) + '</span>';
  }).join('') || '<span class="text-xs text-gray-400 italic">No types yet</span>';

  var people = Array.from(new Set(places.flatMap(function(p){ return p.peopleTags||[]; }))).sort();
  document.getElementById('filterPeopleOptions').innerHTML = people.map(function(t) {
    var active = activeFilters.some(function(f){ return f.type==='people' && f.value===t; });
    return '<span class="filter-chip' + (active?' active':'') + '" data-type="people" data-value="' + esc(t) + '" data-label="With: ' + esc(t) + '" onclick="toggleFilterChip(this)">' + esc(t) + '</span>';
  }).join('') || '<span class="text-xs text-gray-400 italic">No people yet</span>';

  document.querySelectorAll('#filterPanel [data-type="rating"]').forEach(function(chip) {
    chip.classList.toggle('active', activeFilters.some(function(f){ return f.type==='rating' && f.value===chip.dataset.value; }));
    chip.dataset.label = 'Rating: ' + chip.dataset.value + '+';
  });
}

function gdClick(el) {
  openGroupDetail(el.dataset.gdType, el.dataset.gdValue);
}
function filterClick(el) {
  filterByTag(el.dataset.filterType, el.dataset.filterValue);
}

function filterByTag(type, value) {
  // Close detail, go to list, apply filter
  activeFilters = activeFilters.filter(function(f){ return f.type !== type; });
  var labelMap = { typeTag: 'Type: ', people: 'With: ', trip: 'Trip: ' };
  activeFilters.push({ type: type, value: value, label: (labelMap[type]||'') + value });
  document.getElementById('detailView').classList.add('hidden');
  document.getElementById('filterBar').classList.remove('hidden');
  updateActiveFilterDisplay();
  setView('list');
}

function toggleFilterChip(el) {
  var type = el.dataset.type, value = el.dataset.value, label = el.dataset.label || (type + ': ' + value);
  var idx = activeFilters.findIndex(function(f){ return f.type===type && f.value===value; });
  if (idx >= 0) { activeFilters.splice(idx,1); el.classList.remove('active'); }
  else {
    if (type === 'rating') activeFilters = activeFilters.filter(function(f){ return f.type!=='rating'; });
    activeFilters.push({type:type, value:value, label:label});
    el.classList.add('active');
  }
  updateActiveFilterDisplay();
  renderCurrentView();
}

function removeFilter(type, value) {
  activeFilters = activeFilters.filter(function(f){ return !(f.type===type && f.value===value); });
  updateActiveFilterDisplay();
  renderFilterPanel();
  renderCurrentView();
}

function clearAllFilters() {
  activeFilters = [];
  updateActiveFilterDisplay();
  renderFilterPanel();
  renderCurrentView();
}

function updateActiveFilterDisplay() {
  var el = document.getElementById('activeFilterDisplay');
  var btn = document.getElementById('filterToggleBtn');
  if (!activeFilters.length) {
    el.style.display = 'none';
    btn.textContent = 'Filter ▾';
    btn.style.color = '';
  } else {
    el.style.display = 'flex';
    el.innerHTML = activeFilters.map(function(f) {
      return '<span class="filter-chip active" style="font-size:0.7rem;padding:2px 8px;">' + esc(f.label) +
        '<span onclick="removeFilter(\'' + esc(f.type) + '\',\'' + esc(f.value) + '\')" style="cursor:pointer;margin-left:4px;"> ×</span></span>';
    }).join('');
    btn.textContent = 'Filter (' + activeFilters.length + ') ▾';
    btn.style.color = '#859EAC';
  }
}

// ================================================================
// DETAIL VIEW
// ================================================================
function renderDetailNotes(el, notes) {
  el.innerHTML = notes.map(function(n) {
    var isHunter = n.author === 'Hunter';
    var isBrandon = n.author === 'Brandon';
    var bg = isHunter ? '#97AC9F' : (isBrandon ? '#859EAC' : '#f3f4f6');
    var color = (isHunter || isBrandon) ? 'white' : '#555';
    var align = isHunter ? 'flex-end' : (isBrandon ? 'flex-start' : 'center');
    var dateStr = n.ts ? new Date(n.ts).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
    if (n.author === 'Other') {
      return '<div style="display:flex;justify-content:center;margin:4px 0;"><div style="background:#f3f4f6;border-radius:10px;padding:4px 10px;max-width:90%;text-align:center;"><div style="font-size:0.75rem;color:#888;">' + esc(n.text) + '</div>' + (dateStr?'<div style="font-size:0.65rem;color:#bbb;">'+dateStr+'</div>':'') + '</div></div>';
    }
    return '<div style="display:flex;justify-content:'+align+';margin:3px 0;"><div style="max-width:80%;"><div style="font-size:0.65rem;font-weight:600;color:#888;margin-bottom:1px;text-align:'+(isHunter?'right':'left')+';">'+esc(n.author)+'</div><div style="background:'+bg+';color:'+color+';border-radius:'+(isHunter?'14px 14px 4px 14px':'14px 14px 14px 4px')+';padding:7px 12px;font-size:0.82rem;line-height:1.4;">'+esc(n.text)+'</div>'+(dateStr?'<div style="font-size:0.62rem;color:#bbb;margin-top:2px;text-align:'+(isHunter?'right':'left')+';">'+dateStr+'</div>':'')+'</div></div>';
  }).join('');
}

function openDetailById(id) {
  var p = places.find(function(x){ return x.id === id; });
  if (p) openDetail(p);
}

function openDetail(p) {
  detailPlaceId = p.id;
  var prevView = currentView;
  ['listView','mapView','statsView','calendarView','wishlistView','timelineView'].forEach(function(id) {
    var el = document.getElementById(id); if (el) el.classList.add('hidden');
  });
  document.getElementById('filterBar').classList.add('hidden');
  document.getElementById('detailView').classList.remove('hidden');

  var photos = p.photos || [];
  var wrap = document.getElementById('detailHeaderWrap');
  wrap.innerHTML = '';
  if (photos.length) {
    var img = document.createElement('img');
    img.className = 'detail-photo-header';
    img.style.cursor = 'pointer';
    img.src = photos[0];
    img.onclick = function() { openPhoto(photos[0]); };
    wrap.appendChild(img);
  } else {
    var ph = document.createElement('div');
    ph.className = 'detail-photo-placeholder';
    wrap.appendChild(ph);
  }
  var backBtn = document.createElement('button');
  backBtn.className = 'detail-back-btn';
  var backLabels = { list:'List', timeline:'Timeline', wishlist:'Wishlist', map:'Map', calendar:'Calendar', stats:'Stats' };
  backBtn.innerHTML = '&#8592; ' + (backLabels[prevView] || 'Back');
  backBtn.onclick = function() { closeDetail(prevView); };
  wrap.appendChild(backBtn);
  if (photos.length > 1) {
    var badge = document.createElement('div');
    badge.className = 'absolute bottom-2 right-3 text-white text-xs rounded-full px-2 py-0.5';
    badge.style.background = 'rgba(0,0,0,0.4)';
    badge.textContent = photos.length + ' photos';
    wrap.appendChild(badge);
  }

  var _de = normaliseDates(p);
  var fmtD = function(s){ return new Date(s+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',year:'numeric',month:'long',day:'numeric'}); };
  var dateList = _de.length
    ? _de.map(function(e){ return e.end&&e.end!==e.start?fmtD(e.start)+' &rarr; '+fmtD(e.end):fmtD(e.start); }).join('<br>')
    : '<span class="text-gray-400 italic">No dates recorded</span>';

  var subHtml = '';
  if (Object.keys(p.subRatings||{}).length) {
    subHtml = '<div class="bg-white border border-gray-100 rounded-xl p-3"><div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Sub-Ratings</div>';
    Object.entries(p.subRatings).forEach(function(kv) {
      subHtml += '<div class="flex justify-between py-1 border-b border-gray-50"><span class="text-sm text-gray-500">' + esc(kv[0]) + '</span><span class="text-sm" style="color:#859EAC;">' + getStarText(kv[1]) + '</span></div>';
    });
    subHtml += '</div>';
  }

  var body = document.getElementById('detailBody');
  body.innerHTML = '';

  function el(tag, attrs, text) {
    var e = document.createElement(tag);
    if (attrs) Object.keys(attrs).forEach(function(k) {
      if (k === 'style') e.style.cssText = attrs[k];
      else if (k === 'class') e.className = attrs[k];
      else e.setAttribute(k, attrs[k]);
    });
    if (text !== undefined) e.textContent = text;
    return e;
  }
  function div(cls, style) { return el('div', cls ? {'class':cls} : (style ? {'style':style} : {})); }
  function ap(parent, child) { parent.appendChild(child); return child; }
  function tx(parent, html) { parent.innerHTML = html; return parent; }

  // ── Name / location / map link ──
  var nameDiv = ap(body, div(''));
  tx(ap(nameDiv, el('h2','class' in {} ? {} : {'class':'text-2xl font-bold text-gray-900'})), '').textContent = '';
  var h2 = document.createElement('h2');
  h2.className = 'text-2xl font-bold text-gray-900';
  h2.textContent = p.name;
  nameDiv.appendChild(h2);
  var locP = document.createElement('p');
  locP.className = 'text-gray-500 text-sm mt-0.5';
  locP.textContent = p.location || '';
  nameDiv.appendChild(locP);
  if (p._elevation != null) {
    var elevP = document.createElement('p');
    elevP.className = 'text-xs mt-0.5';
    elevP.style.color = '#859EAC';
    elevP.textContent = '▲ ' + p._elevation.toLocaleString() + 'm elevation';
    nameDiv.appendChild(elevP);
  }
  if (p.mapLink) {
    var mapA = document.createElement('a');
    mapA.href = p.mapLink; mapA.target = '_blank';
    mapA.className = 'text-sm font-medium hover:underline mt-1 inline-block';
    mapA.style.color = '#97AC9F';
    mapA.textContent = 'View on Maps ↗';
    nameDiv.appendChild(mapA);
  }

  // ── Dual ratings ──
  var ratingsBox = document.createElement('div');
  ratingsBox.className = 'bg-gray-50 rounded-xl p-2';
  var ratingsRow = document.createElement('div');
  ratingsRow.className = 'flex gap-1 items-stretch';
  ratingsBox.appendChild(ratingsRow);

  function ratingCol(label, rating, color) {
    var col = document.createElement('div');
    col.className = 'flex-1 text-center';
    col.style.padding = '4px 2px';
    var lbl = document.createElement('div');
    lbl.className = 'font-semibold mb-0.5';
    lbl.style.cssText = 'font-size:0.7rem;color:' + color + ';';
    lbl.textContent = label;
    var stars = document.createElement('div');
    stars.className = 'text-sm'; stars.style.color = color;
    stars.textContent = getStarText(rating || 0);
    var num = document.createElement('div');
    num.style.cssText = 'font-size:0.65rem;color:#9ca3af;margin-top:1px;';
    num.textContent = (rating || 0) + '/5';
    col.appendChild(lbl); col.appendChild(stars); col.appendChild(num);
    return col;
  }
  function divider() {
    var d = document.createElement('div');
    d.style.cssText = 'width:1px;background:#e5e7eb;align-self:stretch;';
    return d;
  }
  ratingsRow.appendChild(ratingCol('Hunter', p.hunterRating || p.rating, '#97AC9F'));
  ratingsRow.appendChild(divider());
  var avgCol = ratingCol('Avg', p.rating, '#6E8175');
  // Override stars to show full precision
  var avgStarsEl = avgCol.querySelector('.text-sm');
  if (avgStarsEl) avgStarsEl.textContent = getStarText(p.rating || 0);
  // Override number to show 1 decimal
  var avgNumEls = avgCol.querySelectorAll('div');
  if (avgNumEls.length >= 3) avgNumEls[2].textContent = Number(p.rating || 0).toFixed(1) + '/5';
  ratingsRow.appendChild(avgCol);
  ratingsRow.appendChild(divider());
  ratingsRow.appendChild(ratingCol('Brandon', p.brandonRating || p.rating, '#859EAC'));

  // Enjoyment rating row below
  if (p.enjoymentRating) {
    var enjoyRow = document.createElement('div');
    enjoyRow.className = 'mt-2 pt-2 border-t border-gray-200 flex items-center justify-between';
    var enjoyLbl = document.createElement('div');
    enjoyLbl.className = 'text-xs font-semibold text-gray-400 uppercase tracking-wide';
    enjoyLbl.textContent = 'Memory Weight';
    var enjoyStars = document.createElement('div');
    enjoyStars.style.color = '#E6C8C6';
    enjoyStars.textContent = getStarText(p.enjoymentRating);
    var enjoyNum = document.createElement('div');
    enjoyNum.className = 'text-xs text-gray-400';
    enjoyNum.textContent = p.enjoymentRating + '/5';
    enjoyRow.appendChild(enjoyLbl);
    var enjoyRight = document.createElement('div');
    enjoyRight.className = 'text-right';
    enjoyRight.appendChild(enjoyStars);
    enjoyRight.appendChild(enjoyNum);
    enjoyRow.appendChild(enjoyRight);
    ratingsBox.appendChild(enjoyRow);
  }

  // Would Revisit + First Time badges
  if (p.wouldRevisit !== undefined || p.firstTime !== undefined) {
    var metaRow = document.createElement('div');
    metaRow.className = 'mt-2 pt-2 border-t border-gray-200 flex gap-2 flex-wrap justify-center';
    if (p.firstTime) {
      var ftSpan = document.createElement('span');
      ftSpan.style.cssText = 'font-size:0.7rem;font-weight:700;background:#e8ede5;color:#6E8175;border-radius:20px;padding:2px 10px;';
      ftSpan.textContent = '✦ First Time';
      metaRow.appendChild(ftSpan);
    }
    if (p.wouldRevisit) {
      var wrSpan = document.createElement('span');
      wrSpan.style.cssText = 'font-size:0.7rem;font-weight:700;background:#dde8e3;color:#97AC9F;border-radius:20px;padding:2px 10px;';
      wrSpan.textContent = '↩ Would Revisit';
      metaRow.appendChild(wrSpan);
    } else if (p.wouldRevisit === false && (p.wouldRevisit !== undefined)) {
      var nrSpan = document.createElement('span');
      nrSpan.style.cssText = 'font-size:0.7rem;font-weight:700;background:#f3f4f6;color:#9ca3af;border-radius:20px;padding:2px 10px;';
      nrSpan.textContent = '✕ Would Not Revisit';
      metaRow.appendChild(nrSpan);
    }
    if (metaRow.children.length) ratingsBox.appendChild(metaRow);
  }

  // Repeat: same city visited in multiple separate journal entries, OR this place has multiple visit dates
  var sameCity = p.city ? places.filter(function(x){ return !x.isWishlist && x.city === p.city && x.id !== p.id; }).length : 0;
  var multiVisit = normaliseDates(p).length > 1;
  var isRepeat = sameCity > 1 || multiVisit;
  if (p.zepedaStars > 0 || isRepeat) {
    var zRow = document.createElement('div');
    zRow.className = 'mt-2 pt-2 border-t border-gray-200 flex items-center justify-center gap-3';
    if (p.zepedaStars > 0) {
      var zSpan = document.createElement('span');
      zSpan.className = 'text-lg font-bold'; zSpan.style.color = '#859EAC';
      zSpan.textContent = '!'.repeat(p.zepedaStars);
      var zLbl = document.createElement('span');
      zLbl.className = 'text-xs text-gray-400'; zLbl.textContent = 'Zepeda Stars';
      zRow.appendChild(zSpan); zRow.appendChild(zLbl);
    }
    if (isRepeat) {
      if (p.zepedaStars > 0) { var sep = document.createElement('span'); sep.className = 'text-gray-200'; sep.textContent = '|'; zRow.appendChild(sep); }
      var repSpan = document.createElement('span');
      repSpan.style.cssText = 'font-size:1.5rem;color:#97AC9F;';
      repSpan.textContent = '\u27F3';  // ⟳ repeat symbol
      var repLbl = document.createElement('span');
      repLbl.className = 'text-xs text-gray-400'; repLbl.textContent = 'Repeat Location';
      zRow.appendChild(repSpan); zRow.appendChild(repLbl);
    }
    ratingsBox.appendChild(zRow);
  }
  body.appendChild(ratingsBox);

  // ── Sub-ratings (legacy) ──
  if (p.subRatings && Object.keys(p.subRatings).length) {
    var subBox = document.createElement('div');
    subBox.className = 'bg-white border border-gray-100 rounded-xl p-3';
    var subTitle = document.createElement('div');
    subTitle.className = 'text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2';
    subTitle.textContent = 'Sub-Ratings';
    subBox.appendChild(subTitle);
    Object.entries(p.subRatings).forEach(function(kv) {
      var row = document.createElement('div');
      row.className = 'flex justify-between py-1 border-b border-gray-50';
      var name = document.createElement('span'); name.className = 'text-sm text-gray-500'; name.textContent = kv[0];
      var val = document.createElement('span'); val.className = 'text-sm'; val.style.color = '#859EAC'; val.textContent = getStarText(kv[1]);
      row.appendChild(name); row.appendChild(val); subBox.appendChild(row);
    });
    body.appendChild(subBox);
  }

  // ── Visits breakdown (per-visit detail) ──
  var fmtD2 = function(s){ return new Date(s+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',year:'numeric',month:'long',day:'numeric'}); };

  // Helper: render a tag chip
  function makeTagChip(t, bg, color, onClick) {
    var span = document.createElement('span');
    span.className = 'px-2 py-0.5 rounded-full text-xs font-medium';
    span.style.cssText = 'background:' + bg + ';color:' + color + ';cursor:pointer;';
    span.textContent = t;
    if (onClick) span.onclick = onClick;
    return span;
  }

  // Build per-visit cards
  var visits = p.visits && p.visits.length ? p.visits : null;
  var allDates = normaliseDates(p);

  if (visits) {
    var visitsTitle = document.createElement('div');
    visitsTitle.className = 'text-xs font-semibold text-gray-400 uppercase tracking-wide';
    visitsTitle.textContent = visits.length + ' Visit' + (visits.length > 1 ? 's' : '');
    body.appendChild(visitsTitle);

    visits.forEach(function(v, vi) {
      var card = document.createElement('div');
      card.className = 'bg-white border border-gray-100 rounded-xl p-3 space-y-2';

      // Visit number + date
      var vDates = normaliseDates({dates: v.dates||[], date: null});
      var dateStr = vDates.length
        ? vDates.map(function(e){ return e.end&&e.end!==e.start ? fmtD2(e.start)+' → '+fmtD2(e.end) : fmtD2(e.start); }).join(', ')
        : 'No date recorded';

      var vHeader = document.createElement('div');
      vHeader.className = 'flex items-start justify-between gap-2';
      var vDateDiv = document.createElement('div');
      var vNum = document.createElement('span');
      vNum.className = 'text-xs font-bold uppercase tracking-wide';
      vNum.style.color = '#97AC9F';
      vNum.textContent = 'Visit ' + (vi + 1);
      vDateDiv.appendChild(vNum);
      var vDateText = document.createElement('div');
      vDateText.className = 'text-xs text-gray-500 mt-0.5';
      vDateText.textContent = dateStr;
      vDateDiv.appendChild(vDateText);
      vHeader.appendChild(vDateDiv);
      // Badges: first time / would revisit
      var badgeRow = document.createElement('div');
      badgeRow.className = 'flex gap-1 flex-shrink-0';
      if (v.firstTime) {
        var ftBadge = document.createElement('span');
        ftBadge.style.cssText = 'font-size:0.65rem;font-weight:700;background:#e8ede5;color:#6E8175;border-radius:20px;padding:2px 7px;';
        ftBadge.textContent = '1st';
        badgeRow.appendChild(ftBadge);
      }
      if (v.wouldRevisit) {
        var wrBadge = document.createElement('span');
        wrBadge.style.cssText = 'font-size:0.65rem;font-weight:700;background:#dde8e3;color:#97AC9F;border-radius:20px;padding:2px 7px;';
        wrBadge.textContent = '↩ revisit';
        badgeRow.appendChild(wrBadge);
      }
      vHeader.appendChild(badgeRow);
      card.appendChild(vHeader);

      // Mini ratings
      if (!v.hunterNA || !v.brandonNA) {
        var rRow = document.createElement('div');
        rRow.className = 'flex gap-3 text-xs';
        if (!v.hunterNA && v.hunterRating) {
          var hr = document.createElement('span');
          hr.style.color = '#97AC9F';
          hr.textContent = 'Hunter ' + getStarText(v.hunterRating) + ' ' + v.hunterRating;
          rRow.appendChild(hr);
        }
        if (!v.brandonNA && v.brandonRating) {
          var br = document.createElement('span');
          br.style.color = '#859EAC';
          br.textContent = 'Brandon ' + getStarText(v.brandonRating) + ' ' + v.brandonRating;
          rRow.appendChild(br);
        }
        card.appendChild(rRow);
      }

      // Tags for this visit
      var vHasTags = (v.typeTags&&v.typeTags.length)||(v.detailTags&&v.detailTags.length)||(v.peopleTags&&v.peopleTags.length);
      if (vHasTags) {
        var tagRow = document.createElement('div');
        tagRow.className = 'flex flex-wrap gap-1';
        (v.typeTags||[]).forEach(function(t){ tagRow.appendChild(makeTagChip(t,'#dde8e3','#97AC9F',function(){ filterClick({dataset:{filterType:'typeTag',filterValue:t}}); })); });
        (v.detailTags||[]).forEach(function(t){ tagRow.appendChild(makeTagChip(t,'#e8ede5','#6E8175',function(){ var s=document.getElementById('searchInput'); if(s){s.value=t;s.dispatchEvent(new Event('input'));} showView('list'); })); });
        (v.peopleTags||[]).forEach(function(t){ tagRow.appendChild(makeTagChip(t,'#dce8f0','#859EAC',function(){ filterClick({dataset:{filterType:'people',filterValue:t}}); })); });
        card.appendChild(tagRow);
      }

      body.appendChild(card);
    });
  } else {
    // No visits array — show simple dates + tags (legacy/non-visit mode)
    if (allDates.length) {
      var datesBox = document.createElement('div');
      datesBox.className = 'bg-white border border-gray-100 rounded-xl p-3';
      var datesTitle = document.createElement('div');
      datesTitle.className = 'text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2';
      datesTitle.textContent = allDates.length > 1 ? allDates.length + ' Visits' : 'Visit Date';
      datesBox.appendChild(datesTitle);
      var datesBody = document.createElement('div');
      datesBody.className = 'text-sm text-gray-700 leading-relaxed';
      datesBody.innerHTML = allDates.map(function(e){ return e.end&&e.end!==e.start?fmtD2(e.start)+' → '+fmtD2(e.end):fmtD2(e.start); }).join('<br>');
      datesBox.appendChild(datesBody);
      body.appendChild(datesBox);
    }

    // Tags flat display for legacy places
    var hasTags = (p.typeTags&&p.typeTags.length)||(p.peopleTags&&p.peopleTags.length)||(p.detailTags&&p.detailTags.length);
    if (hasTags) {
      var tagsBox = document.createElement('div');
      tagsBox.className = 'bg-white border border-gray-100 rounded-xl p-3 space-y-2';
      if (p.typeTags && p.typeTags.length) {
        var ttTitle = document.createElement('div'); ttTitle.className = 'text-xs font-semibold text-gray-400 uppercase mb-1'; ttTitle.textContent = 'Type of Place';
        var ttRow = document.createElement('div'); ttRow.className = 'flex flex-wrap gap-1';
        p.typeTags.forEach(function(t){ ttRow.appendChild(makeTagChip(t,'#dde8e3','#97AC9F',function(){ filterClick({dataset:{filterType:'typeTag',filterValue:t}}); })); });
        tagsBox.appendChild(ttTitle); tagsBox.appendChild(ttRow);
      }
      if (p.detailTags && p.detailTags.length) {
        var dtTitle = document.createElement('div'); dtTitle.className = 'text-xs font-semibold uppercase mb-1'; dtTitle.style.color='#6E8175'; dtTitle.textContent = 'Detailed Place';
        var dtRow = document.createElement('div'); dtRow.className = 'flex flex-wrap gap-1';
        p.detailTags.forEach(function(t){ dtRow.appendChild(makeTagChip(t,'#e8ede5','#6E8175',function(){ var s=document.getElementById('searchInput'); if(s){s.value=t;s.dispatchEvent(new Event('input'));} showView('list'); })); });
        tagsBox.appendChild(dtTitle); tagsBox.appendChild(dtRow);
      }
      if (p.peopleTags && p.peopleTags.length) {
        var ptTitle = document.createElement('div'); ptTitle.className = 'text-xs font-semibold text-gray-400 uppercase mb-1'; ptTitle.textContent = 'Visited With';
        var ptRow = document.createElement('div'); ptRow.className = 'flex flex-wrap gap-1';
        p.peopleTags.forEach(function(t){ ptRow.appendChild(makeTagChip(t,'#dce8f0','#859EAC',function(){ filterClick({dataset:{filterType:'people',filterValue:t}}); })); });
        tagsBox.appendChild(ptTitle); tagsBox.appendChild(ptRow);
      }
      body.appendChild(tagsBox);
    }
  }

  // ── Trip ──
  if (getTrips(p).length) {
    var tripRow = document.createElement('div');
    tripRow.className = 'flex items-center gap-2 flex-wrap';
    var tripLbl = document.createElement('span');
    tripLbl.className = 'text-xs font-semibold text-gray-400 uppercase';
    tripLbl.textContent = 'Trip';
    var tripBadge = document.createElement('span');
    tripBadge.className = 'px-3 py-1 rounded-full text-sm font-medium';
    tripBadge.style.cssText = 'background:#E6C8C6;color:#6E8175;cursor:pointer;';
    tripBadge.textContent = getTrips(p).join(', ');
    tripBadge.dataset.gdType = 'trip';
    tripBadge.dataset.gdValue = getTrips(p)[0];
    tripBadge.onclick = function() { gdClick(this); };
    tripRow.appendChild(tripLbl); tripRow.appendChild(tripBadge);
    body.appendChild(tripRow);
  }

  // ── Notes thread ──
  var notesArr = Array.isArray(p.notes) ? p.notes : (p.notes ? [{author:'Other', text:p.notes, ts:''}] : []);
  if (notesArr.length) {
    var notesBox = document.createElement('div');
    notesBox.className = 'bg-white border border-gray-100 rounded-xl p-3';
    var notesTitle = document.createElement('div');
    notesTitle.className = 'text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2';
    notesTitle.textContent = 'Notes';
    notesBox.appendChild(notesTitle);
    var notesThread = document.createElement('div');
    notesThread.id = 'detailNotesThread';
    notesThread.className = 'space-y-1 max-h-48 overflow-y-auto mb-2';
    notesBox.appendChild(notesThread);
    // Inline note composer
    var authorRow = document.createElement('div');
    authorRow.className = 'flex gap-1 mb-1';
    ['Hunter','Brandon','Other'].forEach(function(name) {
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = name;
      btn.dataset.author = name;
      btn.className = 'detail-note-author-btn';
      btn.style.cssText = 'padding:2px 10px;border-radius:20px;font-size:0.7rem;font-weight:600;border:1px solid #d1d5db;background:white;color:#9ca3af;cursor:pointer;';
      if (name === 'Hunter') { btn.style.borderColor = '#97AC9F'; btn.style.color = '#97AC9F'; btn.dataset.active = '1'; }
      btn.onclick = function() {
        authorRow.querySelectorAll('.detail-note-author-btn').forEach(function(b) {
          b.style.background = 'white';
          b.style.color = b.dataset.author === 'Hunter' ? '#97AC9F' : b.dataset.author === 'Brandon' ? '#859EAC' : '#9ca3af';
          b.style.borderColor = b.dataset.author === 'Hunter' ? '#97AC9F' : b.dataset.author === 'Brandon' ? '#859EAC' : '#d1d5db';
          delete b.dataset.active;
        });
        btn.style.background = name === 'Hunter' ? '#97AC9F' : name === 'Brandon' ? '#859EAC' : '#6b7280';
        btn.style.color = 'white';
        btn.dataset.active = '1';
      };
      authorRow.appendChild(btn);
    });
    notesBox.appendChild(authorRow);
    var inputRow = document.createElement('div');
    inputRow.className = 'flex gap-2';
    var noteIn = document.createElement('input');
    noteIn.type = 'text';
    noteIn.id = 'detailNoteInput';
    noteIn.placeholder = 'Add a note...';
    noteIn.className = 'flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm';
    var postBtn = document.createElement('button');
    postBtn.type = 'button';
    postBtn.textContent = 'Post';
    postBtn.className = 'px-3 py-2 text-white rounded-lg text-sm font-semibold';
    postBtn.style.background = '#97AC9F';
    postBtn.onclick = function() {
      var text = noteIn.value.trim();
      if (!text) return;
      var activeBtn = authorRow.querySelector('[data-active]');
      var author = activeBtn ? activeBtn.dataset.author : 'Hunter';
      var place = places.find(function(x){ return x.id === detailPlaceId; });
      if (!place) return;
      if (!Array.isArray(place.notes)) place.notes = place.notes ? [{author:'Other',text:place.notes,ts:''}] : [];
      place.notes.push({author:author, text:text, ts:new Date().toISOString()});
      saveToStorage(place);
      noteIn.value = '';
      // Re-render notes thread
      var thread = document.getElementById('detailNotesThread');
      if (thread) renderDetailNotes(thread, place.notes);
      thread.scrollTop = thread.scrollHeight;
    };
    noteIn.addEventListener('keydown', function(e){ if(e.key==='Enter'){e.preventDefault();postBtn.click();} });
    inputRow.appendChild(noteIn);
    inputRow.appendChild(postBtn);
    notesBox.appendChild(inputRow);
    body.appendChild(notesBox);
  }

  // ── Photo strip placeholder ──
  if (photos.length > 1) {
    var stripWrap = document.createElement('div');
    var stripTitle = document.createElement('div');
    stripTitle.className = 'text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2';
    stripTitle.textContent = 'All Photos';
    var strip2 = document.createElement('div');
    strip2.id = 'detailPhotoStrip';
    strip2.className = 'flex gap-2 flex-wrap';
    stripWrap.appendChild(stripTitle); stripWrap.appendChild(strip2);
    body.appendChild(stripWrap);
  }

  if (photos.length > 1) {
    var strip = document.getElementById('detailPhotoStrip');
    photos.forEach(function(ph) {
      var img2 = document.createElement('img');
      img2.className = 'photo-preview';
      img2.src = ph;
      img2.onclick = (function(src){ return function(){ openPhoto(src); }; })(ph);
      strip.appendChild(img2);
    });
  }
  // Render notes thread in detail view
  var detailNotesEl = document.getElementById('detailNotesThread');
  if (detailNotesEl) {
    var detailNotesArr = Array.isArray(p.notes) ? p.notes : (p.notes ? [{author:'Other',text:p.notes,ts:''}] : []);
    renderDetailNotes(detailNotesEl, detailNotesArr);
    detailNotesEl.scrollTop = detailNotesEl.scrollHeight;
  }
}

function closeDetail(prev) {
  showAllViews(prev || 'list');
}

function detailDelete() {
  var p = places.find(function(x){ return x.id === detailPlaceId; });
  if (!p) return;
  var name = p.name;
  var id = detailPlaceId;
  showConfirm('Delete Place', 'Delete "' + name + '"? This cannot be undone.', 'Delete', '#e57373', function() {
    places = places.filter(function(x){ return x.id !== id; });
    deleteFromStorage(id);
    rebuildSets();
    refreshYearSelect();
    showAllViews('list');
    showToast('"' + name + '" deleted');
  });
}

function detailEdit() {
  var p = places.find(function(x){ return x.id === detailPlaceId; });
  if (p) {
    document.getElementById('detailView').classList.add('hidden');
    editPlace(p);
  }
}

function detailAddVisit() {
  var p = places.find(function(x){ return x.id === detailPlaceId; });
  if (!p) return;
  openAddVisitModal(p);
}

function openAddVisitModal(p) {
  // Reset fields
  document.getElementById('av_startDate').value = '';
  document.getElementById('av_endDate').value = '';
  document.getElementById('av_typeTags').value = '';
  document.getElementById('av_detailTags').value = '';
  document.getElementById('av_peopleTags').value = '';
  document.getElementById('av_hunterRating').value = '5';
  document.getElementById('av_brandonRating').value = '5';
  document.getElementById('av_hunterVal').textContent = '5';
  document.getElementById('av_brandonVal').textContent = '5';
  avUpdateStars('hunter', 5);
  avUpdateStars('brandon', 5);
  // Wire autocomplete for this modal
  setupTagAutocomplete('av_typeTags', 'av_typeSuggestions', allTypeTags);
  setupTagAutocomplete('av_detailTags', 'av_detailSuggestions', allDetailTags);
  setupTagAutocomplete('av_peopleTags', 'av_peopleSuggestions', allPeopleTags);
  // Detail chips based on type
  document.getElementById('av_typeTags').addEventListener('input', avUpdateDetailChips);
  document.getElementById('av_detailTags').addEventListener('input', avUpdateDetailChips);
  var modal = document.getElementById('addVisitModal');
  modal.style.display = 'flex';
  modal._placeId = p.id;
}

function avUpdateDetailChips() {
  var chipsEl = document.getElementById('av_detailChips');
  if (!chipsEl) return;
  var typeVal = document.getElementById('av_typeTags').value;
  var types = typeVal.split(',').map(function(t){ return t.trim().toLowerCase(); }).filter(Boolean);
  var candidates = new Set();
  types.forEach(function(type) {
    Object.keys(typeToDetailMap).forEach(function(key) {
      if (key === type || key.startsWith(type) || type.startsWith(key)) {
        typeToDetailMap[key].forEach(function(d){ candidates.add(d); });
      }
    });
  });
  var current = document.getElementById('av_detailTags').value.split(',').map(function(t){ return t.trim().toLowerCase(); }).filter(Boolean);
  var chips = Array.from(candidates).filter(function(d){ return current.indexOf(d.toLowerCase()) === -1; });
  if (!chips.length || !types.length) { chipsEl.style.display = 'none'; chipsEl.innerHTML = ''; return; }
  chipsEl.style.display = 'flex';
  chipsEl.innerHTML = chips.slice(0,10).map(function(chip) {
    return '<button type="button" onclick="avAddDetailChip(' + JSON.stringify(chip) + ')" style="background:#e8ede5;color:#6E8175;border:none;border-radius:20px;padding:2px 10px;font-size:0.72rem;font-weight:600;cursor:pointer;">' + esc(chip) + '</button>';
  }).join('');
}

function avAddDetailChip(val) {
  var inp = document.getElementById('av_detailTags');
  var parts = inp.value.split(',').map(function(t){ return t.trim(); }).filter(Boolean);
  if (parts.indexOf(val) === -1) parts.push(val);
  inp.value = parts.join(', ');
  avUpdateDetailChips();
}

function avSetRating(who, val) {
  document.getElementById('av_' + who + 'Rating').value = val;
  document.getElementById('av_' + who + 'Val').textContent = val;
  avUpdateStars(who, val);
}

function avUpdateStars(who, val) {
  var color = who === 'hunter' ? '#97AC9F' : '#859EAC';
  var stars = document.querySelectorAll('#av_' + who + 'Stars span');
  stars.forEach(function(s, i){ s.style.color = i < val ? color : '#d1d5db'; });
}

function closeAddVisitModal() {
  document.getElementById('addVisitModal').style.display = 'none';
}

function saveAddVisit() {
  var modal = document.getElementById('addVisitModal');
  var placeId = modal._placeId;
  var p = places.find(function(x){ return x.id === placeId; });
  if (!p) { closeAddVisitModal(); return; }

  var start = document.getElementById('av_startDate').value;
  var end = document.getElementById('av_endDate').value;
  var typeTags = document.getElementById('av_typeTags').value.split(',').map(function(t){ return t.trim(); }).filter(Boolean);
  var detailTags = document.getElementById('av_detailTags').value.split(',').map(function(t){ return t.trim(); }).filter(Boolean);
  var peopleTags = document.getElementById('av_peopleTags').value.split(',').map(function(t){ return t.trim(); }).filter(Boolean);
  var hunterRating = parseFloat(document.getElementById('av_hunterRating').value) || 5;
  var brandonRating = parseFloat(document.getElementById('av_brandonRating').value) || 5;
  var newVisit = {
    dates: start ? [{start: start, end: end||null}] : [],
    typeTags: typeTags,
    detailTags: detailTags,
    peopleTags: peopleTags,
    hunterRating: hunterRating,
    brandonRating: brandonRating,
    enjoymentRating: p.enjoymentRating || 5,
    hunterNA: false, brandonNA: false,
    addedAt: new Date().toISOString()
  };

  // Append visit to place
  var visits = p.visits && p.visits.length ? p.visits.slice() : [{
    dates: normaliseDates(p),
    typeTags: p.typeTags||[], detailTags: p.detailTags||[], peopleTags: p.peopleTags||[],
    hunterRating: p.hunterRating, brandonRating: p.brandonRating, enjoymentRating: p.enjoymentRating||5,
    hunterNA: !!p.hunterNA, brandonNA: !!p.brandonNA,
    wouldRevisit: !!p.wouldRevisit, firstTime: p.firstTime !== false, addedAt: p.createdAt||new Date().toISOString()
  }];
  visits.push(newVisit);

  // Merge tags
  p.typeTags = Array.from(new Set(visits.flatMap(function(v){ return v.typeTags||[]; })));
  p.detailTags = Array.from(new Set(visits.flatMap(function(v){ return v.detailTags||[]; })));
  p.peopleTags = Array.from(new Set(visits.flatMap(function(v){ return v.peopleTags||[]; })));
  p.tags = p.typeTags.concat(p.peopleTags);

  // Append dates
  if (start) {
    var existingDates = normaliseDates(p);
    existingDates.push({start: start, end: end||null});
    p.dates = existingDates;
  }

  // Average ratings across visits
  function avgR(field, naField) {
    var vals = visits.filter(function(v){ return !v[naField] && v[field]!=null; }).map(function(v){ return v[field]; });
    return vals.length ? Math.round((vals.reduce(function(a,b){return a+b;},0)/vals.length)*10)/10 : null;
  }
  p.hunterRating = avgR('hunterRating','hunterNA');
  p.brandonRating = avgR('brandonRating','brandonNA');
  p.rating = ((p.hunterRating||0) + (p.brandonRating||0)) / (p.hunterRating && p.brandonRating ? 2 : 1);
  p.wouldRevisit = wouldRevisit; // latest visit wins
  p.visits = visits;

  saveToStorage(p);
  rebuildSets(); // debounced
  closeAddVisitModal();
  openDetail(p); // refresh detail view
  showToast('✓ Visit added!');
}

function editPlaceById(id) { var p = places.find(function(x){ return x.id === id; }); if (p) editPlace(p); }

function editPlace(p) {
  editingId = p.id;
  currentPhotos = (p.photos||[]).slice();
  document.getElementById('isWishlistCheck').checked = !!p.isWishlist;
  showForm();
  updateFormForWishlist();
  document.getElementById('placeName').value = p.name || '';
  document.getElementById('placeCity').value = p.city || '';
  document.getElementById('placeState').value = p.state || '';
  document.getElementById('placeCountry').value = p.country || '';
  document.getElementById('placeTrip').value = p.trip || '';
  document.getElementById('placeMapLink').value = p.mapLink || '';
  var hr = p.hunterRating || p.rating || 5;
  var br = p.brandonRating || p.rating || 5;
  var er = p.enjoymentRating || 5;
  document.getElementById('hunterRating').value = hr;
  document.getElementById('brandonRating').value = br;
  document.getElementById('enjoymentRating').value = er;
  document.getElementById('hunterRatingValue').textContent = hr;
  document.getElementById('brandonRatingValue').textContent = br;
  document.getElementById('enjoymentRatingValue').textContent = er;
  document.getElementById('placeZepeda').value = p.zepedaStars || 0;
  document.getElementById('placeTypeTags').value = (p.typeTags||[]).join(', ');
  setTimeout(updateDetailChips, 0);
  document.getElementById('placeDetailTags').value = (p.detailTags||[]).join(', ');
  document.getElementById('wouldRevisit').checked = !!p.wouldRevisit;
  document.getElementById('firstTimeVisit').checked = p.firstTime !== false;
  document.getElementById('placePeopleTags').value = (p.peopleTags||[]).join(', ');
  var notesArr = Array.isArray(p.notes) ? p.notes : (p.notes ? [{author:'Other',text:p.notes,ts:p.createdAt||''}] : []);
  document.getElementById('placeNotes').value = JSON.stringify(notesArr);
  document.getElementById('noteInput').value = '';
  renderNotesThread(notesArr);
  // Restore desire weight for wishlist items
  var dw = p.desireWeight || 3;
  document.getElementById('desireWeight').value = dw;
  document.getElementById('desireWeightValue').textContent = dw;
  var dEditStars = document.querySelectorAll('#desireStars .star-btn');
  dEditStars.forEach(function(s, i){ s.style.color = i < dw ? '#E6C8C6' : '#d1d5db'; });
  // Restore N/A state
  if (p.hunterNA) {
    document.getElementById('hunterNA').value = '1';
    document.getElementById('hunterNaBtn').style.cssText = 'background:#97AC9F;border-color:#97AC9F;color:white;font-size:0.75rem;padding:2px 6px;border-radius:4px;font-weight:600;border-width:1px;border-style:solid;';
    document.getElementById('hunterStars').style.opacity = '0.25';
    document.getElementById('hunterStars').style.pointerEvents = 'none';
    document.getElementById('hunterRatingValue').textContent = 'N/A';
  } else { updateStars('hunterStars', hr, '#97AC9F'); }
  if (p.brandonNA) {
    document.getElementById('brandonNA').value = '1';
    document.getElementById('brandonNaBtn').style.cssText = 'background:#97AC9F;border-color:#97AC9F;color:white;font-size:0.75rem;padding:2px 6px;border-radius:4px;font-weight:600;border-width:1px;border-style:solid;';
    document.getElementById('brandonStars').style.opacity = '0.25';
    document.getElementById('brandonStars').style.pointerEvents = 'none';
    document.getElementById('brandonRatingValue').textContent = 'N/A';
  } else { updateStars('brandonStars', br, '#859EAC'); }
  updateStars('enjoymentStars', er, '#E6C8C6');
  document.querySelectorAll('.zepeda-btn').forEach(function(b) {
    b.classList.toggle('active', parseInt(b.dataset.value) === (p.zepedaStars||0));
  });
  document.getElementById('datesContainer').innerHTML = '';
  normaliseDates(p).forEach(function(e){ addDateField(e); });
  document.getElementById('subRatingsContainer').innerHTML = '';
  subRatingCounter = 0; subRatingClicks = {};
  Object.entries(p.subRatings||{}).forEach(function(kv){ addSubRating(kv[0], kv[1]); });
  renderPhotoPreview();
}

function deletePlace(id) {
  var p = places.find(function(x){ return x.id === id; });
  var name = p ? p.name : 'this place';
  showConfirm('Delete Place', 'Delete "' + name + '"? This cannot be undone.', 'Delete', '#e57373', function() {
    places = places.filter(function(x){ return x.id !== id; });
    deleteFromStorage(id);
    rebuildSets();
    refreshYearSelect();
    renderCurrentView();
    showToast('"' + name + '" deleted');
  });
}

// ================================================================
// MAP VIEW (Leaflet + OpenStreetMap geocoding)
// ================================================================
var leafletMap = null;
var leafletMarkers = [];
var heatLayer = null;
var choroplethLayer = null;
var geocodeCache = {};
var mapMode = 'pins'; // 'pins' | 'heat' | 'choropleth'

function setMapMode(mode) {
  mapMode = mode;
  // Update button styles
  ['pins','heat','choropleth'].forEach(function(m) {
    var btn = document.getElementById('mapBtn' + m.charAt(0).toUpperCase() + m.slice(1));
    if (!btn) return;
    if (m === mode) {
      btn.style.background = '#97AC9F'; btn.style.color = 'white'; btn.style.borderColor = '#97AC9F';
    } else {
      btn.style.background = 'white'; btn.style.color = '#6b7280'; btn.style.borderColor = '#d1d5db';
    }
  });
  applyMapMode();
}

function applyMapMode() {
  if (!leafletMap || !mapAllCoords) return;

  // Clear everything
  leafletMarkers.forEach(function(m){ leafletMap.removeLayer(m); });
  leafletMarkers = [];
  if (heatLayer) { leafletMap.removeLayer(heatLayer); heatLayer = null; }
  if (choroplethLayer) { leafletMap.removeLayer(choroplethLayer); choroplethLayer = null; }

  if (mapMode === 'pins') {
    renderPins();
  } else if (mapMode === 'heat') {
    renderHeat();
  } else if (mapMode === 'choropleth') {
    renderChoropleth();
  }
}

var mapAllCoords = null; // [{place, lat, lng}] built once after geocoding

function renderPins() {
  var icon = L.divIcon({
    html: '<div style="width:14px;height:14px;background:#97AC9F;border:2.5px solid white;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
    className: '', iconSize:[14,14], iconAnchor:[7,7], popupAnchor:[0,-10]
  });
  var exactIcon = L.divIcon({
    html: '<div style="width:14px;height:14px;background:#6E8175;border:2.5px solid white;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.4);"></div>',
    className: '', iconSize:[14,14], iconAnchor:[7,7], popupAnchor:[0,-10]
  });
  mapAllCoords.forEach(function(item) {
    var p = item.place;
    var marker = L.marker([item.lat, item.lng], {icon: item.exact ? exactIcon : icon}).addTo(leafletMap);
    var popup = '<div style="min-width:160px;">' +
      '<div style="font-weight:700;font-size:0.9rem;color:#1a202c;margin-bottom:2px;">' + esc(p.name) + '</div>' +
      '<div style="font-size:0.75rem;color:#718096;margin-bottom:4px;">' + esc(p.location||'') + '</div>' +
      '<div style="color:#97AC9F;font-size:0.85rem;margin-bottom:6px;">' + getStarText(p.rating) + '</div>' +
      (item.exact ? '<div style="font-size:0.68rem;color:#97AC9F;margin-bottom:4px;">📍 Exact location</div>' : '') +
      '<button data-place-id="' + esc(p.id) + '" onclick="openDetailById(this.dataset.placeId)" style="background:#97AC9F;color:white;border:none;border-radius:6px;padding:4px 10px;font-size:0.78rem;font-weight:600;cursor:pointer;width:100%;">View Details</button>' +
      '</div>';
    marker.bindPopup(popup, {maxWidth:200});
    leafletMarkers.push(marker);
  });
}

function renderHeat() {
  var points = mapAllCoords.map(function(item) {
    return [item.lat, item.lng, 1];
  });
  if (typeof L.heatLayer !== 'undefined') {
    heatLayer = L.heatLayer(points, {
      radius: 30, blur: 20, maxZoom: 10,
      gradient: {0.2:'#859EAC', 0.5:'#97AC9F', 0.8:'#6E8175', 1.0:'#3d5245'}
    }).addTo(leafletMap);
  }
}

// GeoJSON cache
var _geoJsonCountries = null;
var _geoJsonUs = null;

function renderChoropleth() {
  // Build sets of visited countries and US states (normalised lower-case)
  var visitedCountries = {};
  var visitedStates = {};
  places.filter(function(p){ return !p.isWishlist; }).forEach(function(p) {
    if (p.country) visitedCountries[p.country.trim().toLowerCase()] = (visitedCountries[p.country.trim().toLowerCase()]||0) + 1;
    if (p.state)   visitedStates[p.state.trim().toLowerCase()]     = (visitedStates[p.state.trim().toLowerCase()]||0)   + 1;
  });

  function styleCountry(feature) {
    var name = (feature.properties.ADMIN || feature.properties.name || '').trim().toLowerCase();
    var visited = !!visitedCountries[name];
    return {
      fillColor:   visited ? '#6E8175' : '#e5e7eb',
      fillOpacity: visited ? 0.65      : 0.15,
      color:       visited ? '#4a5e52' : '#d1d5db',
      weight:      visited ? 1         : 0.5
    };
  }

  function styleState(feature) {
    var name = (feature.properties.NAME || feature.properties.name || '').trim().toLowerCase();
    var visited = !!visitedStates[name];
    return {
      fillColor:   visited ? '#859EAC' : 'transparent',
      fillOpacity: visited ? 0.6       : 0,
      color:       visited ? '#5d7a8a' : 'transparent',
      weight:      visited ? 1         : 0
    };
  }

  function addPopup(feature, layer) {
    var name = feature.properties.ADMIN || feature.properties.NAME || feature.properties.name || '';
    var key = name.trim().toLowerCase();
    var count = visitedCountries[key] || visitedStates[key] || 0;
    if (count) {
      layer.bindPopup('<div style="font-weight:700;font-size:0.9rem;">' + esc(name) + '</div>' +
        '<div style="font-size:0.8rem;color:#718096;">' + count + ' place' + (count>1?'s':'') + ' visited</div>');
    }
  }

  function drawLayers() {
    if (_geoJsonCountries) {
      var lyr = L.geoJSON(_geoJsonCountries, { style: styleCountry, onEachFeature: addPopup }).addTo(leafletMap);
      leafletMarkers.push(lyr);
    }
    if (_geoJsonUs) {
      var usLyr = L.geoJSON(_geoJsonUs, { style: styleState, onEachFeature: addPopup }).addTo(leafletMap);
      leafletMarkers.push(usLyr);
    }
  }

  var fetchCountries = _geoJsonCountries ? Promise.resolve() :
    fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
      .then(function(r){ return r.json(); })
      .then(function(d){ _geoJsonCountries = d; });

  var fetchStates = _geoJsonUs ? Promise.resolve() :
    fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json')
      .then(function(r){ return r.json(); })
      .then(function(d){ _geoJsonUs = d; });

  Promise.all([fetchCountries, fetchStates])
    .then(drawLayers)
    .catch(function(err) {
      // Fallback: if network fails, just draw visited markers
      console.warn('GeoJSON load failed, falling back to pins', err);
      renderPins();
    });
}

function renderMap() {
  var visited = places.filter(function(p){ return !p.isWishlist && (p.city || p.country); });
  document.getElementById('mapNoPlaces').classList.toggle('hidden', visited.length > 0);
  if (!visited.length) return;

  // Init map once
  if (!leafletMap) {
    leafletMap = L.map('leafletMap', { zoomControl: true }).setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 19
    }).addTo(leafletMap);
  }

  // Gather all coords (exact first, then geocode missing)
  var coordItems = [];
  var pending = 0;

  function onAllResolved() {
    mapAllCoords = coordItems;
    var latlngs = coordItems.map(function(i){return [i.lat,i.lng];});
    if (latlngs.length === 1) { leafletMap.setView(latlngs[0], 10); }
    else if (latlngs.length > 1) { leafletMap.fitBounds(latlngs, {padding:[40,40], maxZoom:12}); }
    leafletMap.invalidateSize();
    applyMapMode();
  }

  visited.forEach(function(p) {
    if (p._lat != null) {
      coordItems.push({place:p, lat:p._lat, lng:p._lng, exact:true});
    } else {
      pending++;
      var cacheKey = (p.city||'') + '|' + (p.state||'') + '|' + (p.country||'');
      if (geocodeCache[cacheKey]) {
        coordItems.push({place:p, lat:geocodeCache[cacheKey][0], lng:geocodeCache[cacheKey][1], exact:false});
        pending--;
      } else {
        var query = [p.city, p.state, p.country].filter(Boolean).join(', ');
        fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(query) + '&limit=1')
          .then(function(r){ return r.json(); })
          .then(function(data) {
            if (data && data[0]) {
              var lat = parseFloat(data[0].lat), lng = parseFloat(data[0].lon);
              geocodeCache[cacheKey] = [lat, lng];
              coordItems.push({place:p, lat:lat, lng:lng, exact:false});
            }
          })
          .catch(function(){})
          .finally(function(){
            pending--;
            if (pending === 0) onAllResolved();
          });
      }
    }
  });

  if (pending === 0) onAllResolved();
}

// ================================================================
// CALENDAR VIEW
// ================================================================
function renderCalendar() {
  var MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calMonthLabel').textContent = MONTHS[calMonth];
  document.getElementById('calYearLabel').textContent = calYear;

  var dateMap = {};
  places.filter(function(p){ return !p.isWishlist; }).forEach(function(p) {
    normaliseDates(p).forEach(function(entry) {
      if (!entry.start) return;
      var end = entry.end && entry.end !== entry.start ? entry.end : null;
      if (!end) {
        if (!dateMap[entry.start]) dateMap[entry.start] = [];
        dateMap[entry.start].push({place:p,isStart:true,isEnd:true,isRange:false});
      } else {
        var cur = new Date(entry.start+'T12:00:00'), endD = new Date(end+'T12:00:00');
        while (cur <= endD) {
          var k = cur.toISOString().slice(0,10);
          if (!dateMap[k]) dateMap[k] = [];
          dateMap[k].push({place:p,isStart:k===entry.start,isEnd:k===end,isRange:true});
          cur.setDate(cur.getDate()+1);
        }
      }
    });
  });

  var todayKey = new Date().toISOString().slice(0,10);
  var firstDay = new Date(calYear, calMonth, 1).getDay();
  var daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
  var daysInPrev = new Date(calYear, calMonth, 0).getDate();
  var totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
  var grid = document.getElementById('calGrid');
  grid.innerHTML = '';

  for (var i = 0; i < totalCells; i++) {
    var day, offset = 0;
    if (i < firstDay) { day = daysInPrev - firstDay + 1 + i; offset = -1; }
    else if (i >= firstDay + daysInMonth) { day = i - firstDay - daysInMonth + 1; offset = 1; }
    else { day = i - firstDay + 1; }

    var cellDate = new Date(calYear, calMonth + offset, day);
    var key = cellDate.toISOString().slice(0,10);
    var cellEntries = dateMap[key]||[];
    var cellPlaces = cellEntries.map(function(e){ return e.place; });
    var anyRange = cellEntries.some(function(e){ return e.isRange; });
    var anyStart = cellEntries.some(function(e){ return e.isStart&&e.isRange; });
    var anyEnd   = cellEntries.some(function(e){ return e.isEnd&&e.isRange; });

    var cell = document.createElement('div');
    cell.className = 'cal-cell' +
      (offset !== 0 ? ' other-month' : '') +
      (key === todayKey ? ' today' : '') +
      (key === calSelectedDay ? ' selected' : '') +
      (anyRange&&!anyStart&&!anyEnd ? ' cal-range-mid' : '') +
      (anyStart&&!anyEnd ? ' cal-range-start' : '') +
      (anyEnd&&!anyStart ? ' cal-range-end' : '');

    var dayNum = document.createElement('div');
    dayNum.className = 'cal-day-num';
    dayNum.textContent = day;
    cell.appendChild(dayNum);

    if (cellPlaces.length) {
      var dotRow = document.createElement('div');
      dotRow.className = 'cal-dot-row';
      cellPlaces.slice(0,4).forEach(function(_, idx) {
        var dot = document.createElement('div');
        dot.className = 'cal-dot' + (idx > 0 ? ' blue' : '');
        dotRow.appendChild(dot);
      });
      if (cellPlaces.length > 4) {
        var more = document.createElement('div');
        more.style.cssText = 'font-size:9px;color:#97AC9F;font-weight:700;';
        more.textContent = '+' + (cellPlaces.length - 4);
        dotRow.appendChild(more);
      }
      cell.appendChild(dotRow);
    }

    (function(k) { cell.addEventListener('click', function() { calSelectedDay = k; renderCalendar(); }); })(key);
    grid.appendChild(cell);
  }

  var detail = document.getElementById('calDayDetail');
  if (!calSelectedDay) { detail.innerHTML = ''; return; }
  var _dE = dateMap[calSelectedDay]||[]; var dayPlaces = _dE.map(function(e){ return e.place; });
  var label = new Date(calSelectedDay + 'T12:00:00').toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  if (!dayPlaces.length) {
    detail.innerHTML = '<div class="text-center py-4 text-gray-400 text-sm">No visits on ' + label + '</div>';
  } else {
    detail.innerHTML = '<div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">' + label + '</div>' +
      dayPlaces.map(function(p){ return renderCard(p); }).join('');
  }
}

function calPrev() { calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; } calSelectedDay = null; renderCalendar(); }
function calNext() { calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; } calSelectedDay = null; renderCalendar(); }

// ================================================================
// STATS VIEW
// ================================================================
var rebuildSetsTimer = null;
function rebuildSets(immediate) {
  if (immediate) {
    clearTimeout(rebuildSetsTimer);
    rebuildSetsTimer = null;
    _rebuildSetsNow();
  } else {
    // Debounce: wait 100ms for more saves before rebuilding
    clearTimeout(rebuildSetsTimer);
    rebuildSetsTimer = setTimeout(_rebuildSetsNow, 100);
  }
}

function _rebuildSetsNow() {
  [allTypeTags, allPeopleTags, allCities, allStates, allCountries, allTrips].forEach(function(s){ s.clear(); });
  allDetailTags.clear();
  typeToDetailMap = {};
  places.filter(function(p){ return !p.isWishlist; }).forEach(function(p) {
    (p.typeTags||[]).forEach(function(t){ allTypeTags.add(t); });
    (p.detailTags||[]).forEach(function(t){ allDetailTags.add(t); });
    if ((p.detailTags||[]).length) {
      (p.typeTags||[]).forEach(function(type) {
        var key = type.toLowerCase().trim();
        if (!typeToDetailMap[key]) typeToDetailMap[key] = new Set();
        p.detailTags.forEach(function(d){ typeToDetailMap[key].add(d); });
      });
    }
    (p.peopleTags||[]).forEach(function(t){ allPeopleTags.add(t); });
    if (p.city) allCities.add(p.city);
    if (p.state) allStates.add(p.state);
    if (p.country) allCountries.add(p.country);
    if (p.trip) allTrips.add(p.trip);
  });
}

function refreshYearSelect() { /* no-op */ }

// ── Home location: Dallas, TX ──
var HOME_LAT = 32.7767, HOME_LNG = -96.7970;

function haversineMiles(lat1, lng1, lat2, lng2) {
  var R = 3958.8; // Earth radius in miles
  var dLat = (lat2 - lat1) * Math.PI / 180;
  var dLng = (lng2 - lng1) * Math.PI / 180;
  var a = Math.sin(dLat/2)*Math.sin(dLat/2) +
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
    Math.sin(dLng/2)*Math.sin(dLng/2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// ── Helper: compute stats for a set of places ──
function computeStats(ps) {
  var avg = function(arr) { return arr.length ? (arr.reduce(function(a,b){return a+b;},0)/arr.length) : 0; };
  var avgR = avg(ps.map(function(p){return p.rating||0;}));
  var avgH = avg(ps.map(function(p){return p.hunterRating||p.rating||0;}));
  var avgB = avg(ps.map(function(p){return p.brandonRating||p.rating||0;}));
  var avgE = avg(ps.filter(function(p){return p.enjoymentRating;}).map(function(p){return p.enjoymentRating;}));

  // Top 5 people
  var peopleCounts = {};
  ps.forEach(function(p){ (p.peopleTags||[]).forEach(function(t){ peopleCounts[t]=(peopleCounts[t]||0)+1; }); });
  var topPeople = Object.keys(peopleCounts).sort(function(a,b){return peopleCounts[b]-peopleCounts[a];}).slice(0,5);

  // Top 5 place types
  var typeCounts = {};
  ps.forEach(function(p){ (p.typeTags||[]).forEach(function(t){ typeCounts[t]=(typeCounts[t]||0)+1; }); });
  var topTypes = Object.keys(typeCounts).sort(function(a,b){return typeCounts[b]-typeCounts[a];}).slice(0,5);

  var detailCounts = {};
  ps.forEach(function(p){ (p.detailTags||[]).forEach(function(t){ detailCounts[t]=(detailCounts[t]||0)+1; }); });
  var topDetails = Object.keys(detailCounts).sort(function(a,b){return detailCounts[b]-detailCounts[a];}).slice(0,8);

  // Avg ratings for coffee, restaurant, museum
  var byType = function(type) {
    var sub = ps.filter(function(p){ return (p.typeTags||[]).some(function(t){ return t.toLowerCase().includes(type); }); });
    return sub.length ? avg(sub.map(function(p){return p.rating||0;})).toFixed(1) : null;
  };

  // Northernmost / southernmost — use cached lat on place objects
  var north = null, south = null;
  ps.forEach(function(p) {
    if (p._lat == null) return;
    if (north === null || p._lat > north._lat) north = p;
    if (south === null || p._lat < south._lat) south = p;
  });

  // Top 5 rated
  var topRated = ps.slice().sort(function(a,b){return (b.rating||0)-(a.rating||0);}).slice(0,5);
  // Top 5 enjoyment
  var topEnjoy = ps.filter(function(p){return p.enjoymentRating;}).sort(function(a,b){return b.enjoymentRating-a.enjoymentRating;}).slice(0,5);

  // Days per country / state (sum of dates per place)
  var countryDays = {}, stateDays = {};
  ps.forEach(function(p) {
    var d = Math.max(1, normaliseDates(p).length);
    if (p.country) countryDays[p.country] = (countryDays[p.country]||0) + d;
    if (p.state)   stateDays[p.state]   = (stateDays[p.state]||0)   + d;
  });

  // Highest / lowest elevation
  var highest = null, lowest = null;
  ps.forEach(function(p) {
    if (p._elevation == null) return;
    if (highest === null || p._elevation > highest._elevation) highest = p;
    if (lowest === null || p._elevation < lowest._elevation) lowest = p;
  });

  // Furthest from home (Dallas)
  var furthest = null, furthestMiles = 0;
  ps.forEach(function(p) {
    if (p._lat == null) return;
    var miles = haversineMiles(HOME_LAT, HOME_LNG, p._lat, p._lng);
    if (miles > furthestMiles) { furthestMiles = miles; furthest = p; }
  });

  return { avgR:avgR, avgH:avgH, avgB:avgB, avgE:avgE, topPeople:topPeople, peopleCounts:peopleCounts,
           topTypes:topTypes, typeCounts:typeCounts, topDetails:topDetails, detailCounts:detailCounts, byType:byType, topRated:topRated, topEnjoy:topEnjoy,
           northPlace:north, southPlace:south, count:ps.length,
           countryDays:countryDays, stateDays:stateDays,
           highestPlace:highest, lowestPlace:lowest,
           furthestPlace:furthest, furthestMiles:Math.round(furthestMiles) };
}


// ── Helper: inline SVG pie chart ──
function pieChart(items, totalOverride, compact) {
  if (!items.length) return '';
  var total = totalOverride || items.reduce(function(a,b){return a+b.val;},0);
  if (total === 0) return '';
  var COLORS = ['#97AC9F','#859EAC','#6E8175','#E6C8C6','#b8cfc8','#a3b8c4','#8fa69a','#c9a9a7','#d4e0da','#bdd0d8'];
  var size = compact ? 90 : 120;
  var cx = size/2, cy = size/2, r = compact ? 36 : 52;
  var svgParts = '<svg width="' + size + '" height="' + size + '" viewBox="0 0 ' + size + ' ' + size + '">';
  var startAngle = -Math.PI / 2;
  items.forEach(function(item, i) {
    var fraction = item.val / total;
    var endAngle = startAngle + fraction * 2 * Math.PI;
    if (fraction >= 0.999) {
      svgParts += '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="' + COLORS[i % COLORS.length] + '"/>';
    } else {
      var x1 = cx + r * Math.cos(startAngle), y1 = cy + r * Math.sin(startAngle);
      var x2 = cx + r * Math.cos(endAngle),   y2 = cy + r * Math.sin(endAngle);
      var large = fraction > 0.5 ? 1 : 0;
      svgParts += '<path d="M' + cx + ',' + cy + ' L' + x1.toFixed(2) + ',' + y1.toFixed(2) +
        ' A' + r + ',' + r + ' 0 ' + large + ',1 ' + x2.toFixed(2) + ',' + y2.toFixed(2) + ' Z" fill="' + COLORS[i % COLORS.length] + '"/>';
    }
    startAngle = endAngle;
  });
  // donut hole
  svgParts += '<circle cx="' + cx + '" cy="' + cy + '" r="' + Math.round(r * 0.54) + '" fill="white"/>';
  svgParts += '</svg>';

  var legend = '<div class="space-y-1 flex-1 min-w-0">';
  items.forEach(function(item, i) {
    var pct = Math.round(item.val / total * 100);
    legend += '<div class="flex items-center gap-1.5 text-xs">' +
      '<div style="width:10px;height:10px;border-radius:2px;flex-shrink:0;background:' + COLORS[i % COLORS.length] + ';"></div>' +
      '<span class="text-gray-600 truncate flex-1">' + esc(item.label) + '</span>' +
      '<span class="text-gray-400 flex-shrink-0">' + item.val + ' (' + pct + '%)</span></div>';
  });
  legend += '</div>';

  if (compact) return '<div class="flex flex-col items-center gap-1">' + svgParts + '<div class="text-center">' + legend.replace('space-y-1.5','space-y-0.5') + '</div></div>';
  return '<div class="flex items-center gap-3">' + svgParts + legend + '</div>';
}

// ── Helper: ratings distribution bar chart (how many places got each star rating) ──
function ratingsDistChart(ps) {
  if (!ps.length) return '';
  // Always show ALL 10 half-star buckets — every rating gets a column
  var keys = ['0.5','1','1.5','2','2.5','3','3.5','4','4.5','5'];
  var buckets = {};
  keys.forEach(function(k){ buckets[k] = 0; });
  ps.forEach(function(p) {
    var r = Math.round((p.rating || 0) * 2) / 2;
    r = Math.min(5, Math.max(0.5, r));
    var key = String(r % 1 === 0 ? r.toFixed(0) : r.toFixed(1));
    if (buckets[key] !== undefined) buckets[key]++;
  });
  var max = Math.max.apply(null, keys.map(function(k){ return buckets[k]; }));
  if (max === 0) return '';

  var color = '#859EAC';
  var chartH = 80;
  var barW = 22;
  var gapW = 4;

  var html = '<div style="display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 0;">';
  html += '<div style="display:flex;align-items:flex-end;gap:' + gapW + 'px;height:' + (chartH + 18) + 'px;">';
  keys.forEach(function(k) {
    var v = buckets[k];
    var barH = v > 0 ? Math.max(3, Math.round((v / max) * chartH)) : 0;
    html += '<div style="display:flex;flex-direction:column;align-items:center;width:' + barW + 'px;">' +
      '<div style="font-size:0.6rem;color:#6b7280;font-weight:600;margin-bottom:2px;height:14px;display:flex;align-items:flex-end;">' + (v > 0 ? v : '') + '</div>' +
      '<div style="width:' + barW + 'px;height:' + (v > 0 ? barH : 2) + 'px;background:' + color + ';border-radius:3px 3px 0 0;opacity:' + (v > 0 ? '1' : '0.2') + ';"></div>' +
      '</div>';
  });
  html += '</div>';
  html += '<div style="display:flex;gap:' + gapW + 'px;">';
  keys.forEach(function(k) {
    html += '<div style="width:' + barW + 'px;text-align:center;font-size:0.6rem;color:#9ca3af;font-weight:500;">' + k + '</div>';
  });
  html += '</div>';
  html += '</div>';
  return html;
}

// ── Helper: SVG horizontal bar chart ──
function barChart(items, maxVal, colorFn) {
  if (!items.length) return '';
  var html = '<div class="space-y-2 mt-2">';
  items.forEach(function(item) {
    var pct = maxVal > 0 ? Math.round((item.val / maxVal) * 100) : 0;
    html += '<div>' +
      '<div class="flex justify-between text-xs mb-0.5"><span class="text-gray-600 font-medium">' + esc(item.label) + '</span><span class="font-semibold" style="color:' + colorFn(item) + ';">' + item.display + '</span></div>' +
      '<div style="background:#f0f0f0;border-radius:4px;height:10px;overflow:hidden;">' +
      '<div style="height:100%;border-radius:4px;background:' + colorFn(item) + ';width:' + pct + '%;transition:width 0.5s;"></div>' +
      '</div></div>';
  });
  return html + '</div>';
}

// ── Helper: render a full stats block HTML ──
function renderStatsBlock(ps, yearLabel, isMainStats) {
  if (!ps.length) return '<div class="text-center py-6 text-gray-400">No places ' + (yearLabel ? 'in ' + yearLabel : 'yet') + '</div>';
  var s = computeStats(ps);
  var countries = new Set(ps.map(function(p){return p.country;}).filter(Boolean));
  var cities = new Set(ps.map(function(p){return p.city;}).filter(Boolean));
  var trips = new Set(ps.flatMap(function(p){ return getTrips(p); }).filter(Boolean));
  var allDates = ps.flatMap(function(p){ return getDateStarts(p); }).filter(Boolean).sort();
  var html = '';

  // Overview cards
  html += '<div class="grid grid-cols-3 gap-2 mb-3">' +
    statCard(ps.length,'Places') + statCard(countries.size,'Countries') + statCard(cities.size,'Cities') + '</div>';
  html += '<div class="grid grid-cols-2 gap-2 mb-3">' +
    statCard(trips.size,'Trips') + statCard(allDates.length ? new Date(allDates[0]).toLocaleDateString('en-US',{month:'short',year:'numeric'}) : '—', allDates.length>1?'First Visit':'Visited') + '</div>';

  // Ratings distribution bar chart
  var ratingsDist = ratingsDistChart(ps);
  if (ratingsDist) {
    html += '<div class="bg-white border border-gray-100 rounded-xl p-3 mb-3">' +
      '<div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-1">Ratings Distribution</div>' +
      ratingsDist + '</div>';
  }

  // Ratings averages
  html += '<div class="bg-white border border-gray-100 rounded-xl p-3 mb-3">' +
    '<div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Ratings</div>' +
    '<div class="grid grid-cols-3 gap-2 text-center">' +
    '<div><div style="color:#97AC9F;font-size:1.1rem;">' + getStarText(s.avgH) + '</div><div class="text-xs text-gray-400 mt-0.5">Hunter ' + s.avgH.toFixed(1) + '</div></div>' +
    '<div><div style="color:#6E8175;font-size:1.1rem;">' + getStarText(s.avgR) + '</div><div class="text-xs text-gray-400 mt-0.5">Avg ' + s.avgR.toFixed(1) + '</div></div>' +
    '<div><div style="color:#859EAC;font-size:1.1rem;">' + getStarText(s.avgB) + '</div><div class="text-xs text-gray-400 mt-0.5">Brandon ' + s.avgB.toFixed(1) + '</div></div>' +
    '</div>' +
    (s.avgE > 0 ? '<div class="mt-2 pt-2 border-t border-gray-100 flex justify-between items-center"><span class="text-xs text-gray-400">Avg Memory Weight</span><span style="color:#E6C8C6;">' + getStarText(s.avgE) + ' <span class="text-xs text-gray-400">' + s.avgE.toFixed(1) + '</span></span></div>' : '') +
    '</div>';

  // Category ratings
  var coffee = s.byType('coffee'), rest = s.byType('restaurant'), museum = s.byType('museum');
  if (coffee || rest || museum) {
    html += '<div class="bg-white border border-gray-100 rounded-xl p-3 mb-3">' +
      '<div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Category Averages</div>';
    var catItems = [];
    if (coffee) catItems.push({label:'Coffee',val:parseFloat(coffee),display:coffee+'★'});
    if (rest) catItems.push({label:'Restaurant',val:parseFloat(rest),display:rest+'★'});
    if (museum) catItems.push({label:'Museum',val:parseFloat(museum),display:museum+'★'});
    var maxCat = Math.max.apply(null, catItems.map(function(x){return x.val;}));
    html += barChart(catItems, 5, function(){return '#97AC9F';}) + '</div>';
  }

  // Top 5 people bar + pie (bar only on main stats for space)
  if (s.topPeople.length) {
    var peopleItems = s.topPeople.map(function(t){return {label:t,val:s.peopleCounts[t],display:s.peopleCounts[t]+' places'};});
    var maxPeople = Math.max.apply(null,s.topPeople.map(function(t){return s.peopleCounts[t];}));
    html += '<div class="bg-white border border-gray-100 rounded-xl p-3 mb-3">' +
      '<div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-1">Travel Companions</div>' +
      barChart(peopleItems, maxPeople, function(){return '#859EAC';}) +
      '</div>';
  }

  // Top 4 countries by days (excl. USA) — main stats only
  if (isMainStats) {
    var countryDayItems = Object.keys(s.countryDays)
      .filter(function(k){ return k.toLowerCase() !== 'united states' && k.toLowerCase() !== 'usa' && k.toLowerCase() !== 'us'; })
      .map(function(k){ return {label:k, val:s.countryDays[k], display:s.countryDays[k]+' days'}; })
      .sort(function(a,b){return b.val-a.val;}).slice(0,4);
    if (countryDayItems.length) {
      html += '<div class="bg-white border border-gray-100 rounded-xl p-3 mb-3">' +
        '<div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-1">Top Countries by Days (excl. USA)</div>' +
        barChart(countryDayItems, countryDayItems[0].val, function(){return '#97AC9F';}) + '</div>';
    }
    // Top 5 states by days (excl. Texas)
    var stateDayItems = Object.keys(s.stateDays)
      .filter(function(k){ return k.toLowerCase() !== 'texas' && k.toLowerCase() !== 'tx'; })
      .map(function(k){ return {label:k, val:s.stateDays[k], display:s.stateDays[k]+' days'}; })
      .sort(function(a,b){return b.val-a.val;}).slice(0,5);
    if (stateDayItems.length) {
      html += '<div class="bg-white border border-gray-100 rounded-xl p-3 mb-3">' +
        '<div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-1">Top States by Days (excl. Texas)</div>' +
        barChart(stateDayItems, stateDayItems[0].val, function(){return '#859EAC';}) + '</div>';
    }
  }

  // Side-by-side pie charts: Place Types + Travel Companions
  var typeItemsForPie = s.topTypes.length ? s.topTypes.map(function(t){return {label:t,val:s.typeCounts[t],display:s.typeCounts[t]+' places'};}) : [];
  var peopleItemsForPie = s.topPeople.length ? s.topPeople.map(function(t){return {label:t,val:s.peopleCounts[t],display:s.peopleCounts[t]+' places'};}) : [];
  if (typeItemsForPie.length || peopleItemsForPie.length) {
    html += '<div class="bg-white border border-gray-100 rounded-xl p-3 mb-3">' +
      '<div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3">Distribution</div>' +
      '<div class="grid grid-cols-2 gap-2">';
    if (typeItemsForPie.length) {
      html += '<div class="flex flex-col items-center">' +
        '<div class="text-xs font-medium text-gray-500 mb-2">Place Types</div>' +
        pieChart(typeItemsForPie, null, true) + '</div>';
    }
    if (peopleItemsForPie.length) {
      html += '<div class="flex flex-col items-center">' +
        '<div class="text-xs font-medium text-gray-500 mb-2">With</div>' +
        pieChart(peopleItemsForPie, null, true) + '</div>';
    }
    html += '</div></div>';
  }
  // Types bar chart (standalone, no extra pie)
  if (s.topTypes.length) {
    var typeItems = s.topTypes.map(function(t){return {label:t,val:s.typeCounts[t],display:s.typeCounts[t]+' places'};});
    html += '<div class="bg-white border border-gray-100 rounded-xl p-3 mb-3">' +
      '<div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Place Types</div>' +
      barChart(typeItems, Math.max.apply(null,s.topTypes.map(function(t){return s.typeCounts[t];})), function(){return '#6E8175';}) + '</div>';
  }

  // Detailed Place tags — weighted tag cloud
  if (s.topDetails && s.topDetails.length) {
    var maxD = Math.max.apply(null, s.topDetails.map(function(t){ return s.detailCounts[t]; }));
    html += '<div class="bg-white border border-gray-100 rounded-xl p-3 mb-3">' +
      '<div class="text-xs font-semibold uppercase tracking-wide mb-2" style="color:#6E8175;">Detailed Place Tags</div>' +
      '<div class="flex flex-wrap gap-1.5">';
    s.topDetails.forEach(function(t) {
      var cnt = s.detailCounts[t];
      var scale = maxD > 1 ? 0.75 + 0.45 * (cnt / maxD) : 1;
      var fontSize = (Math.round(10 * scale * 10) / 10) + 'px';
      html += '<span style="display:inline-flex;align-items:center;gap:3px;background:#e8ede5;color:#6E8175;border-radius:20px;padding:3px 10px;font-size:' + fontSize + ';font-weight:600;">' +
        esc(t) + '<span style="font-size:9px;font-weight:400;opacity:0.65;">' + cnt + '</span></span>';
    });
    html += '</div></div>';
  }

  // Geographic extremes: north/south + highest/lowest elevation
  var hasGeo = s.northPlace || s.southPlace;
  var hasElev = s.highestPlace || s.lowestPlace;
  if (isMainStats && (hasGeo || hasElev)) {
    html += '<div class="bg-white border border-gray-100 rounded-xl p-3 mb-3" id="geoExtremesBlock">' +
      '<div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Geographic Extremes</div>';
    if (hasGeo) {
      var np = s.northPlace, sp = s.southPlace;
      html += '<div class="flex justify-between mb-2">' +
        '<div><div class="text-xs text-gray-400 mb-0.5">↑ Northernmost</div>' +
        '<div class="text-sm font-medium text-gray-700">' + esc(np ? np.name : '—') + '</div>' +
        '<div class="text-xs text-gray-400">' + esc(np ? (np.city||'') + (np.country ? ', '+np.country : '') : '') + '</div></div>' +
        '<div class="text-right"><div class="text-xs text-gray-400 mb-0.5">↓ Southernmost</div>' +
        '<div class="text-sm font-medium text-gray-700">' + esc(sp ? sp.name : '—') + '</div>' +
        '<div class="text-xs text-gray-400">' + esc(sp ? (sp.city||'') + (sp.country ? ', '+sp.country : '') : '') + '</div></div>' +
        '</div>';
    }
    if (hasGeo && hasElev) {
      html += '<div class="border-t border-gray-100 pt-2 mt-1"></div>';
    }
    if (hasElev) {
      var hi = s.highestPlace, lo = s.lowestPlace;
      var fmtElev = function(p) { return p._elevation.toLocaleString() + 'm (' + Math.round(p._elevation * 3.28084).toLocaleString() + 'ft)'; };
      html += '<div class="flex justify-between mt-1">' +
        '<div><div class="text-xs text-gray-400 mb-0.5">▲ Highest Elevation</div>' +
        '<div class="text-sm font-medium text-gray-700">' + esc(hi ? hi.name : '—') + '</div>' +
        '<div class="text-xs font-semibold" style="color:#859EAC;">' + (hi ? fmtElev(hi) : '') + '</div></div>' +
        '<div class="text-right"><div class="text-xs text-gray-400 mb-0.5">▼ Lowest Elevation</div>' +
        '<div class="text-sm font-medium text-gray-700">' + esc(lo ? lo.name : '—') + '</div>' +
        '<div class="text-xs font-semibold" style="color:#859EAC;">' + (lo ? fmtElev(lo) : '') + '</div></div>' +
        '</div>';
    }
    if (s.furthestPlace) {
      if (hasGeo || hasElev) html += '<div class="border-t border-gray-100 pt-2 mt-2"></div>';
      html += '<div><div class="text-xs text-gray-400 mb-0.5">✈ Furthest from Dallas</div>' +
        '<div class="text-sm font-medium text-gray-700">' + esc(s.furthestPlace.name) + '</div>' +
        '<div class="text-xs text-gray-400">' + esc((s.furthestPlace.city||'') + (s.furthestPlace.country ? ', '+s.furthestPlace.country : '')) + '</div>' +
        '<div class="text-xs font-semibold mt-0.5" style="color:#97AC9F;">' + s.furthestMiles.toLocaleString() + ' mi away</div>' +
        '</div>';
    }
    html += '</div>';
  } else if (isMainStats && s.furthestPlace) {
    html += '<div class="bg-white border border-gray-100 rounded-xl p-3 mb-3" id="geoExtremesBlock">' +
      '<div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Geographic Extremes</div>' +
      '<div><div class="text-xs text-gray-400 mb-0.5">✈ Furthest from Dallas</div>' +
      '<div class="text-sm font-medium text-gray-700">' + esc(s.furthestPlace.name) + '</div>' +
      '<div class="text-xs text-gray-400">' + esc((s.furthestPlace.city||'') + (s.furthestPlace.country ? ', '+s.furthestPlace.country : '')) + '</div>' +
      '<div class="text-xs font-semibold mt-0.5" style="color:#97AC9F;">' + s.furthestMiles.toLocaleString() + ' mi away</div>' +
      '</div></div>';
  } else if (isMainStats) {
    html += '<div class="bg-white border border-gray-100 rounded-xl p-3 mb-3" id="geoExtremesBlock">' +
      '<div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Geographic Extremes</div>' +
      '<div class="text-xs text-gray-400 italic">Add Maps links to see geographic extremes</div></div>';
  }

  return html;
}



// ── Geocode all places to get _lat/_lng, then batch-fetch elevation ──
function geocodeAndFetchElevations(ps) {
  var missing = ps.filter(function(p){ return p._lat == null && (p.city || p.country); });
  var pending = missing.length;
  function afterGeocode() {
    // Now batch-fetch elevations for any that have coords but no elevation
    var needElev = ps.filter(function(p){ return p._elevation == null && p._lat != null; });
    if (!needElev.length) return;
    var batch = needElev.slice(0, 100);
    var lats = batch.map(function(p){ return p._lat; }).join(',');
    var lngs = batch.map(function(p){ return p._lng; }).join(',');
    fetch('https://api.open-meteo.com/v1/elevation?latitude=' + lats + '&longitude=' + lngs)
      .then(function(r){ return r.json(); })
      .then(function(data) {
        if (data && data.elevation) {
          data.elevation.forEach(function(elev, i) {
            if (batch[i] && elev != null) {
              batch[i]._elevation = Math.round(elev);
            }
          });
        }
        batch.forEach(function(p){ saveToStorage(p); });
      }).catch(function(){});
  }
  if (!pending) { afterGeocode(); return; }
  missing.forEach(function(p) {
    var key = (p.city||'') + '|' + (p.state||'') + '|' + (p.country||'');
    if (geocodeCache[key]) {
      p._lat = geocodeCache[key][0]; p._lng = geocodeCache[key][1];
      pending--;
      if (pending === 0) afterGeocode();
      return;
    }
    var q = [p.city, p.state, p.country].filter(Boolean).join(', ');
    fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q) + '&limit=1')
      .then(function(r){ return r.json(); })
      .then(function(data) {
        if (data && data[0]) {
          p._lat = parseFloat(data[0].lat);
          p._lng = parseFloat(data[0].lon);
          geocodeCache[key] = [p._lat, p._lng];
        }
      }).catch(function(){})
      .finally(function(){
        pending--;
        if (pending === 0) afterGeocode();
      });
  });
}

// ── Fetch elevation from Open-Elevation API ──
function fetchElevation(place, onDone) {
  if (place._elevation != null || place._lat == null) { onDone(); return; }
  fetch('https://api.open-meteo.com/v1/elevation?latitude=' + place._lat + '&longitude=' + place._lng)
    .then(function(r){ return r.json(); })
    .then(function(data) {
      if (data && data.elevation && data.elevation[0] != null) {
        place._elevation = Math.round(data.elevation[0]);
        saveToStorage(place);
      }
    })
    .catch(function(){})
    .finally(function(){ onDone(); });
}

// Fetch elevation for all places in array that have coords but no elevation
function fetchElevationsBatch(ps, onAllDone) {
  var need = ps.filter(function(p){ return p._elevation == null && p._lat != null; });
  if (!need.length) { onAllDone(); return; }
  // Batch up to 100 at a time
  var batch = need.slice(0, 100);
  var lats2 = batch.map(function(p){ return p._lat; }).join(',');
  var lngs2 = batch.map(function(p){ return p._lng; }).join(',');
  fetch('https://api.open-meteo.com/v1/elevation?latitude=' + lats2 + '&longitude=' + lngs2)
    .then(function(r){ return r.json(); })
    .then(function(data) {
      if (data && data.elevation) {
        data.elevation.forEach(function(elev, i) {
          if (batch[i] && elev != null) {
            batch[i]._elevation = Math.round(elev);
            saveToStorage(batch[i]);
          }
        });
      }
    })
    .catch(function(){})
    .finally(function(){ onAllDone(); });
}

// ── Geocode any places missing _lat/_lng, then call done() ──
var _geocodingQueue = false;
function geocodeMissingPlaces(ps, done) {
  var missing = ps.filter(function(p){ return p._lat == null && (p.city || p.country); });
  if (!missing.length) return; // all already cached — no need to re-render
  var total = missing.length, count = 0;
  missing.forEach(function(p) {
    var key = (p.city||'') + '|' + (p.state||'') + '|' + (p.country||'');
    // Use geocodeCache first to avoid extra requests
    if (geocodeCache[key]) {
      p._lat = geocodeCache[key][0]; p._lng = geocodeCache[key][1];
      count++; if (count === total) done();
      return;
    }
    var q = [p.city, p.state, p.country].filter(Boolean).join(', ');
    fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q) + '&limit=1')
      .then(function(r){ return r.json(); })
      .then(function(data) {
        if (data && data[0]) {
          var lat = parseFloat(data[0].lat), lng = parseFloat(data[0].lon);
          p._lat = lat; p._lng = lng;
          geocodeCache[key] = [lat, lng];
        }
      })
      .catch(function(){})
      .finally(function(){ count++; if (count === total) done(); });
  });
}

function renderStats() {
  var visited = places.filter(function(p){ return !p.isWishlist; });
  var el = document.getElementById('statsContent');
  if (!visited.length) { el.innerHTML = '<div class="text-center py-10 text-gray-400">No places yet</div>'; return; }

  // Build year tabs using normalised date starts
  var years = Array.from(new Set(visited.flatMap(function(p){
    return getDateStarts(p).map(function(d){ return new Date(d+'T12:00:00').getFullYear(); });
  }))).filter(Boolean).sort(function(a,b){ return b - a; });

  var activeYear = el.dataset.activeYear || 'all';
  // If stored year no longer exists, fall back to all
  if (activeYear !== 'all' && years.indexOf(parseInt(activeYear)) === -1) activeYear = 'all';

  function buildTabsHtml(ay) {
    return '<div id="statsYearTabs" class="flex gap-2 mb-4 overflow-x-auto pb-1 no-scrollbar">' +
      ['all'].concat(years).map(function(y) {
        var active = String(y) === String(ay);
        return '<button data-statsyear="' + y + '" style="flex-shrink:0;padding:6px 14px;border-radius:20px;font-size:0.8rem;font-weight:600;border:none;cursor:pointer;' +
          (active ? 'background:#97AC9F;color:white;' : 'background:#f3f4f6;color:#6b7280;') + '">' +
          (y === 'all' ? 'All Time' : y) + '</button>';
      }).join('') + '</div>';
  }

  var filteredPlaces = activeYear === 'all' ? visited : visited.filter(function(p) {
    return getDateStarts(p).some(function(d){ return new Date(d+'T12:00:00').getFullYear() === parseInt(activeYear); });
  });

  el.innerHTML = buildTabsHtml(activeYear) + renderStatsBlock(filteredPlaces, activeYear === 'all' ? null : activeYear, true);
  el.dataset.activeYear = activeYear;
  // Wire year tab clicks via event delegation (avoids inline onclick quote issues)
  var tabsEl = document.getElementById('statsYearTabs');
  if (tabsEl) {
    tabsEl.addEventListener('click', function(e) {
      var btn = e.target.closest('[data-statsyear]');
      if (btn) setStatsYear(btn.getAttribute('data-statsyear'));
    });
  }
}

function setStatsYear(year) {
  var el = document.getElementById('statsContent');
  el.dataset.activeYear = year;
  renderStats();
}

function statCard(val, label) {
  return '<div class="bg-white rounded-xl p-3 text-center shadow-sm border border-gray-100"><div class="text-xl font-bold" style="color:#97AC9F;">' + val + '</div><div class="text-xs text-gray-500 mt-0.5">' + label + '</div></div>';
}


function exportPDF() {
  var visited = places.filter(function(p){ return !p.isWishlist; });
  if (!visited.length) { showToast('No places to export'); return; }

  var doc = new window.jspdf.jsPDF({ unit:'mm', format:'a4' });
  var pageW = doc.internal.pageSize.getWidth();
  var pageH = doc.internal.pageSize.getHeight();
  var margin = 15;
  var contentW = pageW - margin * 2;
  var y = margin;

  function checkPage(needed) {
    if (y + needed > pageH - margin) { doc.addPage(); y = margin; }
  }

  function drawLine() {
    checkPage(4);
    doc.setDrawColor(220, 220, 220);
    doc.line(margin, y, pageW - margin, y);
    y += 4;
  }

  function writeText(text, size, style, color) {
    doc.setFontSize(size || 11);
    doc.setFont('helvetica', style || 'normal');
    if (color) doc.setTextColor(color[0], color[1], color[2]);
    else doc.setTextColor(60, 60, 60);
    var lines = doc.splitTextToSize(String(text), contentW);
    checkPage(lines.length * (size || 11) * 0.4 + 2);
    doc.text(lines, margin, y);
    y += lines.length * (size || 11) * 0.38 + 2;
  }

  // Title
  doc.setFillColor(151, 172, 159);
  doc.rect(0, 0, pageW, 22, 'F');
  doc.setFontSize(18); doc.setFont('helvetica', 'bold');
  doc.setTextColor(255, 255, 255);
  doc.text('My Travel Journal', margin, 14);
  doc.setFontSize(9); doc.setFont('helvetica', 'normal');
  doc.text(visited.length + ' places · ' + new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}), pageW - margin, 14, {align:'right'});
  y = 28;

  visited.forEach(function(p, i) {
    checkPage(24);

    // Place name
    writeText(p.name, 13, 'bold', [45, 55, 72]);

    // Location
    if (p.location) writeText(p.location, 9, 'normal', [130, 130, 130]);

    // Ratings row
    var ratingStr = '';
    if (p.hunterRating) ratingStr += 'Hunter: ' + p.hunterRating + '/5';
    if (p.brandonRating) ratingStr += (ratingStr ? '   ' : '') + 'Brandon: ' + p.brandonRating + '/5';
    if (p.rating) ratingStr += (ratingStr ? '   ' : '') + 'Avg: ' + Number(p.rating).toFixed(1) + '/5';
    if (p.enjoymentRating) ratingStr += (ratingStr ? '   ' : '') + 'Memory: ' + p.enjoymentRating + '/5';
    if (ratingStr) writeText(ratingStr, 9, 'normal', [151, 172, 159]);

    // Trip + dates
    var meta = [];
    var pdfTrips = getTrips(p); if (pdfTrips.length) meta.push('Trip: ' + pdfTrips.join(', '));
    var _pdfDates = normaliseDates(p);
    var fmtPdf = function(s){ return new Date(s+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); };
    if (_pdfDates.length) meta.push('Visited: ' + _pdfDates.map(function(e){ return e.end&&e.end!==e.start ? fmtPdf(e.start)+' – '+fmtPdf(e.end) : fmtPdf(e.start); }).join(', '));
    if (meta.length) writeText(meta.join('   '), 8, 'normal', [160, 160, 160]);

    // Tags
    var tags = (p.typeTags||[]).concat(p.peopleTags||[]);
    if (tags.length) writeText(tags.join(' · '), 8, 'italic', [133, 158, 172]);

    // Notes
    var notesArr = Array.isArray(p.notes) ? p.notes : (p.notes ? [{author:'',text:p.notes}] : []);
    notesArr.forEach(function(n) {
      var noteText = (n.author ? n.author + ': ' : '') + n.text;
      writeText(noteText, 8, 'normal', [100, 100, 100]);
    });

    y += 2;
    if (i < visited.length - 1) drawLine();
  });

  doc.save('travel-journal.pdf');
  showToast('✓ PDF exported!');
}

// ================================================================
// AUTOCOMPLETE
// ================================================================
function setupAutocomplete(inputId, sugId, dataSet) {
  var inp = document.getElementById(inputId);
  var sug = document.getElementById(sugId);
  inp.addEventListener('input', function() {
    var val = inp.value.toLowerCase();
    if (!val) { sug.classList.remove('active'); return; }
    var matches = Array.from(dataSet).filter(function(x){ return x.toLowerCase().startsWith(val); });
    if (!matches.length) { sug.classList.remove('active'); return; }
    sug.innerHTML = matches.slice(0,8).map(function(m){ return '<div class="tag-suggestion-item" onclick="pickSuggestion(\'' + inputId + '\',\'' + sugId + '\',\'' + esc(m) + '\')">' + esc(m) + '</div>'; }).join('');
    sug.classList.add('active');
  });
  inp.addEventListener('blur', function(){ setTimeout(function(){ sug.classList.remove('active'); }, 200); });
}

function updateDetailChips() {
  var chipsEl = document.getElementById('detailTagChips');
  if (!chipsEl) return;
  var typeVal = (document.getElementById('placeTypeTags') || {}).value || '';
  var types = typeVal.split(',').map(function(t){ return t.trim().toLowerCase(); }).filter(Boolean);

  var candidates = new Set();
  types.forEach(function(type) {
    Object.keys(typeToDetailMap).forEach(function(key) {
      if (key === type || key.startsWith(type) || type.startsWith(key)) {
        typeToDetailMap[key].forEach(function(d){ candidates.add(d); });
      }
    });
  });

  var current = (document.getElementById('placeDetailTags').value || '')
    .split(',').map(function(t){ return t.trim().toLowerCase(); }).filter(Boolean);
  var chips = Array.from(candidates).filter(function(d){
    return current.indexOf(d.toLowerCase()) === -1;
  });

  if (!chips.length || !types.length) {
    chipsEl.style.display = 'none';
    chipsEl.innerHTML = '';
    return;
  }
  chipsEl.style.display = 'flex';
  chipsEl.innerHTML = chips.slice(0, 12).map(function(chip) {
    return '<button type="button" onclick="addDetailChip(' + JSON.stringify(chip) + ')" ' +
      'style="background:#e8ede5;color:#6E8175;border:none;border-radius:20px;padding:2px 10px;font-size:0.72rem;font-weight:600;cursor:pointer;">' +
      esc(chip) + '</button>';
  }).join('');
}

function addDetailChip(val) {
  var inp = document.getElementById('placeDetailTags');
  var parts = inp.value.split(',').map(function(t){ return t.trim(); }).filter(Boolean);
  if (parts.indexOf(val) === -1) parts.push(val);
  inp.value = parts.join(', ');
  updateDetailChips();
}

function setupTagAutocomplete(inputId, sugId, dataSet) {
  var inp = document.getElementById(inputId);
  var sug = document.getElementById(sugId);
  inp.addEventListener('input', function() {
    var parts = inp.value.split(',');
    var val = parts[parts.length-1].trim().toLowerCase();
    if (!val) { sug.classList.remove('active'); return; }
    var matches = Array.from(dataSet).filter(function(x){ return x.toLowerCase().startsWith(val); });
    if (!matches.length) { sug.classList.remove('active'); return; }
    sug.innerHTML = matches.slice(0,8).map(function(m){ return '<div class="tag-suggestion-item" onclick="pickTagSuggestion(\'' + inputId + '\',\'' + sugId + '\',\'' + esc(m) + '\')">' + esc(m) + '</div>'; }).join('');
    sug.classList.add('active');
  });
  inp.addEventListener('blur', function(){ setTimeout(function(){ sug.classList.remove('active'); }, 200); });
}

function pickSuggestion(inputId, sugId, val) {
  document.getElementById(inputId).value = val;
  document.getElementById(sugId).classList.remove('active');
}

function pickTagSuggestion(inputId, sugId, val) {
  var inp = document.getElementById(inputId);
  var parts = inp.value.split(',');
  parts[parts.length-1] = ' ' + val;
  inp.value = parts.join(',').replace(/^,\s*/,'');
  document.getElementById(sugId).classList.remove('active');
}

// ================================================================
// UTILS
// ================================================================
function showToast(msg) {
  var t = document.getElementById('successToast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); }, 2500);
}

function esc(str) {
  if (typeof str !== 'string') return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
</script>
</body>
</html>
